# %%
```python
# %% [markdown]
# # ğŸ§ª Lab: Prompt Engineering à¸à¸±à¸š MLflow
# ## à¹€à¸£à¸µà¸¢à¸™à¸£à¸¹à¹‰ 3 à¹€à¸—à¸„à¸™à¸´à¸„ + Reflection Loop + à¸à¸²à¸£à¸•à¸´à¸”à¸•à¸²à¸¡à¸œà¸¥à¸”à¹‰à¸§à¸¢ MLflow
#
# ---
#
# ## ğŸ¯ à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢à¸‚à¸­à¸‡ Lab à¸™à¸µà¹‰
#
# à¹ƒà¸™à¸à¸²à¸£à¸à¸±à¸’à¸™à¸² AI Application à¸ˆà¸£à¸´à¸‡ à¹€à¸£à¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£:
# 1. **à¹€à¸—à¸„à¸™à¸´à¸„à¸à¸²à¸£à¹€à¸‚à¸µà¸¢à¸™ Prompt à¸—à¸µà¹ˆà¸”à¸µ** â†’ à¹ƒà¸«à¹‰ AI à¸•à¸­à¸šà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¹à¸¥à¸°à¸¡à¸µà¸„à¸¸à¸“à¸ à¸²à¸
# 2. **à¸£à¸°à¸šà¸šà¸•à¸´à¸”à¸•à¸²à¸¡à¸œà¸¥** â†’ à¸£à¸¹à¹‰à¸§à¹ˆà¸² Prompt à¹€à¸§à¸­à¸£à¹Œà¸Šà¸±à¸™à¹„à¸«à¸™à¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸”
# 3. **à¸à¸²à¸£à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´** â†’ à¹ƒà¸«à¹‰ AI à¸Šà¹ˆà¸§à¸¢à¸›à¸£à¸±à¸š Prompt à¹€à¸­à¸‡
#
# Lab à¸™à¸µà¹‰à¸ˆà¸°à¸ªà¸­à¸™ 3 à¹€à¸—à¸„à¸™à¸´à¸„à¸«à¸¥à¸±à¸ + à¸§à¸´à¸˜à¸µà¹ƒà¸Šà¹‰ MLflow à¸•à¸´à¸”à¸•à¸²à¸¡à¸—à¸¸à¸à¸­à¸¢à¹ˆà¸²à¸‡
#
# ---
#
# ## ğŸ—ºï¸ à¹à¸œà¸™à¸œà¸±à¸‡à¸£à¸§à¸¡ (Big Picture)
#
# ```
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                    3 à¹€à¸—à¸„à¸™à¸´à¸„ Prompt Engineering                  â”‚
# â”‚                                                                 â”‚
# â”‚  Technique 1: Self-Consistency                                  â”‚
# â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
# â”‚  â”‚  à¸–à¸²à¸¡à¸„à¸³à¸–à¸²à¸¡à¹€à¸”à¸´à¸¡ 5 à¸„à¸£à¸±à¹‰à¸‡ â†’ à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸š â†’ à¹‚à¸«à¸§à¸•à¹€à¸ªà¸µà¸¢à¸‡à¸‚à¹‰à¸²à¸‡à¸¡à¸²à¸  â”‚        â”‚
# â”‚  â”‚  Problem â†’ [Path1: 42] [Path2: 42] [Path3: 38] â†’ 42 â”‚        â”‚
# â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
# â”‚                                                                 â”‚
# â”‚  Technique 2: Prompt Chaining                                   â”‚
# â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
# â”‚  â”‚  à¹à¸šà¹ˆà¸‡à¸‡à¸²à¸™à¹€à¸›à¹‡à¸™à¸‚à¸±à¹‰à¸™ à¸ªà¹ˆà¸‡ output à¸•à¹ˆà¸­à¸à¸±à¸™à¹€à¸›à¹‡à¸™à¸—à¸­à¸”à¹†          â”‚        â”‚
# â”‚  â”‚  Review â†’ [Extract] â†’ [Analyze] â†’ [Report]          â”‚        â”‚
# â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
# â”‚                                                                 â”‚
# â”‚  Technique 3: Self-Critique                                     â”‚
# â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
# â”‚  â”‚  à¹ƒà¸«à¹‰ AI à¸•à¸£à¸§à¸ˆà¸‡à¸²à¸™à¸•à¸±à¸§à¹€à¸­à¸‡ à¹à¸¥à¹‰à¸§à¹à¸à¹‰à¹„à¸‚                    â”‚        â”‚
# â”‚  â”‚  [Generate Draft] â†’ [Critique] â†’ [Revise] â†’ Final  â”‚        â”‚
# â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
# â”‚                              â†“                                  â”‚
# â”‚           Reflection Loop: à¸—à¸”à¸ªà¸­à¸š â†’ à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ â†’ à¸›à¸£à¸±à¸š Prompt     â”‚
# â”‚                              â†“                                  â”‚
# â”‚           MLflow: à¸šà¸±à¸™à¸—à¸¶à¸ Version, Metrics, Parameters           â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
# ```

# %% [markdown]
# ---
# ## âš™ï¸ à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆ 0: à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡à¹à¸¥à¸°à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²
#
# à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸”à¹‰à¸§à¸¢à¸à¸²à¸£ import library à¸—à¸µà¹ˆà¸ˆà¸³à¹€à¸›à¹‡à¸™ à¹à¸¥à¸°à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­

# %%
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Import Libraries
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

import mlflow
import mlflow.genai
import json
import time
import re

from collections import Counter
from typing import List, Dict, Any

from google import genai
from google.genai import types

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸«à¸¥à¸±à¸ (à¹à¸à¹‰à¹„à¸‚à¸•à¸£à¸‡à¸™à¸µà¹‰)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

API_KEY   = "YOUR_GEMINI_API_KEY"   # <<<< à¹ƒà¸ªà¹ˆ Gemini API Key à¸‚à¸­à¸‡à¸„à¸¸à¸“
MODEL_ID  = "gemini-2.0-flash"      # à¹‚à¸¡à¹€à¸”à¸¥à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰
MLFLOW_URI = "http://127.0.0.1:5000" # à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆ MLflow Server

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  à¸ªà¸£à¹‰à¸²à¸‡ Client à¹à¸¥à¸°à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ MLflow
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

client = genai.Client(api_key=API_KEY)

mlflow.set_tracking_uri(MLFLOW_URI)
mlflow.set_experiment("prompt_engineering_lab")  # à¸Šà¸·à¹ˆà¸­ Experiment à¹ƒà¸™ MLflow

print("=" * 50)
print(f"  âœ… Gemini Model : {MODEL_ID}")
print(f"  âœ… MLflow URI   : {mlflow.get_tracking_uri()}")
print("=" * 50)

# %% [markdown]
# ### ğŸ’¡ à¸—à¸³à¹„à¸¡à¸•à¹‰à¸­à¸‡à¹ƒà¸Šà¹‰ Version Tracker?
#
# MLflow à¹€à¸à¹‡à¸š Prompt à¹€à¸›à¹‡à¸™ Version (1, 2, 3, ...) à¹à¸•à¹ˆ**à¹„à¸¡à¹ˆà¸£à¸­à¸‡à¸£à¸±à¸š "latest"** à¹‚à¸”à¸¢à¸•à¸£à¸‡
# à¹€à¸£à¸²à¸ˆà¸¶à¸‡à¸ªà¸£à¹‰à¸²à¸‡ dictionary à¹„à¸§à¹‰à¸•à¸´à¸”à¸•à¸²à¸¡ version à¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¸‚à¸­à¸‡à¹à¸•à¹ˆà¸¥à¸° prompt à¹€à¸­à¸‡
#
# ```
# _prompt_versions = {
#     "sc_math_solver": 3,    â† à¸•à¸­à¸™à¸™à¸µà¹‰à¸­à¸¢à¸¹à¹ˆà¸—à¸µà¹ˆ version 3
#     "chain_extract":  1,    â† à¸¢à¸±à¸‡à¸­à¸¢à¸¹à¹ˆ version 1
#     ...
# }
# ```

# %%
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Version Tracker: à¸•à¸´à¸”à¸•à¸²à¸¡ Version à¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¸‚à¸­à¸‡à¹à¸•à¹ˆà¸¥à¸° Prompt
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

_prompt_versions: Dict[str, int] = {}


def track_version(name: str, version: int):
    """
    à¸šà¸±à¸™à¸—à¸¶à¸ version à¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¸‚à¸­à¸‡ prompt à¸¥à¸‡à¹ƒà¸™ dictionary
    à¸–à¹‰à¸² version à¹ƒà¸«à¸¡à¹ˆà¸ªà¸¹à¸‡à¸à¸§à¹ˆà¸² version à¹€à¸”à¸´à¸¡ à¹ƒà¸«à¹‰à¸­à¸±à¸›à¹€à¸”à¸•
    """
    current_max = _prompt_versions.get(name, 0)
    _prompt_versions[name] = max(current_max, version)


def get_latest_version(name: str) -> int:
    """
    à¸”à¸¶à¸‡ version à¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¸‚à¸­à¸‡ prompt
    à¸–à¹‰à¸²à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹€à¸„à¸¢ track à¹„à¸§à¹‰ à¸„à¸·à¸™à¸„à¹ˆà¸² 1 à¹€à¸›à¹‡à¸™ default
    """
    return _prompt_versions.get(name, 1)


def load_latest_prompt(name: str):
    """
    à¹‚à¸«à¸¥à¸” prompt version à¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¸ˆà¸²à¸ MLflow Registry
    à¹ƒà¸Šà¹‰ format: prompts:/<à¸Šà¸·à¹ˆà¸­>/<version>
    """
    latest_version = get_latest_version(name)
    prompt_uri = f"prompts:/{name}/{latest_version}"
    return mlflow.genai.load_prompt(prompt_uri)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  à¸—à¸”à¸ªà¸­à¸šà¸§à¹ˆà¸² Version Tracker à¸—à¸³à¸‡à¸²à¸™à¹„à¸”à¹‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

track_version("test_prompt", 1)
track_version("test_prompt", 3)
track_version("test_prompt", 2)  # à¹„à¸¡à¹ˆà¸„à¸§à¸£à¸—à¸±à¸š version 3

assert get_latest_version("test_prompt") == 3, "Version Tracker à¸¡à¸µà¸›à¸±à¸à¸«à¸²!"
print("  âœ… Version Tracker à¸—à¸³à¸‡à¸²à¸™à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡")
print(f"     track 1, 3, 2 â†’ latest = {get_latest_version('test_prompt')}")

# %% [markdown]
# ---
# ## ğŸ¨ à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆ 1: Helper Functions à¸ªà¸³à¸«à¸£à¸±à¸šà¹à¸ªà¸”à¸‡à¸œà¸¥
#
# à¹€à¸£à¸²à¸ˆà¸°à¸ªà¸£à¹‰à¸²à¸‡à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸Šà¹ˆà¸§à¸¢à¹à¸ªà¸”à¸‡à¸œà¸¥à¸ªà¸§à¸¢à¸‡à¸²à¸¡ à¹ƒà¸™ Jupyter Notebook
# à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸­à¹ˆà¸²à¸™à¹à¸¥à¸°à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¹„à¸”à¹‰à¸‡à¹ˆà¸²à¸¢à¸‚à¸¶à¹‰à¸™

# %%
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸«à¸¥à¸±à¸: à¹€à¸£à¸µà¸¢à¸ Gemini API
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def call_gemini(prompt: str,
                temperature: float = 0.0,
                max_tokens: int = 2048) -> str:
    """
    à¸ªà¹ˆà¸‡ prompt à¹„à¸›à¹ƒà¸«à¹‰ Gemini à¹à¸¥à¸°à¸£à¸±à¸š text à¸à¸¥à¸±à¸šà¸¡à¸²

    Parameters:
        prompt      : à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸—à¸µà¹ˆà¸ˆà¸°à¸ªà¹ˆà¸‡à¹ƒà¸«à¹‰ AI
        temperature : à¸„à¸§à¸²à¸¡à¸ªà¸£à¹‰à¸²à¸‡à¸ªà¸£à¸£à¸„à¹Œ (0.0 = à¹à¸¡à¹ˆà¸™à¸¢à¸³, 1.0 = à¸ªà¸£à¹‰à¸²à¸‡à¸ªà¸£à¸£à¸„à¹Œ)
        max_tokens  : à¸ˆà¸³à¸™à¸§à¸™ token à¸ªà¸¹à¸‡à¸ªà¸¸à¸”à¸‚à¸­à¸‡à¸„à¸³à¸•à¸­à¸š

    Returns:
        str : à¸„à¸³à¸•à¸­à¸šà¸ˆà¸²à¸ Gemini à¹€à¸›à¹‡à¸™ text
    """
    response = client.models.generate_content(
        model=MODEL_ID,
        contents=prompt,
        config=types.GenerateContentConfig(
            temperature=temperature,
            max_output_tokens=max_tokens,
        ),
    )
    return response.text


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹à¸ªà¸”à¸‡à¸œà¸¥: à¸«à¸±à¸§à¸‚à¹‰à¸­ (Title)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def print_title(text: str, level: int = 1):
    """
    à¹à¸ªà¸”à¸‡à¸«à¸±à¸§à¸‚à¹‰à¸­à¹à¸šà¹ˆà¸‡à¸£à¸°à¸”à¸±à¸š

    level 1 â†’ à¸«à¸±à¸§à¸‚à¹‰à¸­à¹ƒà¸«à¸à¹ˆ (à¸¡à¸µà¸à¸£à¸­à¸š â”â”â”)
    level 2 â†’ à¸«à¸±à¸§à¸‚à¹‰à¸­à¸£à¸­à¸‡ (à¹€à¸ªà¹‰à¸™ â”€â”€)
    level 3 â†’ à¸«à¸±à¸§à¸‚à¹‰à¸­à¸¢à¹ˆà¸­à¸¢ (à¸ˆà¸¸à¸” â–¸)
    """
    if level == 1:
        border = "â”" * 62
        print(f"\n{border}")
        print(f"  ğŸ”· {text}")
        print(f"{border}")

    elif level == 2:
        padding = "â”€" * max(1, 48 - len(text))
        print(f"\n  â”€â”€ {text} {padding}")

    else:  # level 3
        print(f"\n    â–¸ {text}")


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹à¸ªà¸”à¸‡à¸œà¸¥: à¸à¸¥à¹ˆà¸­à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ (Box)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def print_box(title: str, content: str,
              emoji: str = "ğŸ“Œ", width: int = 78):
    """
    à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹ƒà¸™à¸à¸¥à¹ˆà¸­à¸‡à¸ªà¸§à¸¢à¸‡à¸²à¸¡ à¸à¸£à¹‰à¸­à¸¡ Word-wrap à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´

    Parameters:
        title   : à¸Šà¸·à¹ˆà¸­à¸à¸¥à¹ˆà¸­à¸‡
        content : à¹€à¸™à¸·à¹‰à¸­à¸«à¸²à¸ à¸²à¸¢à¹ƒà¸™à¸à¸¥à¹ˆà¸­à¸‡
        emoji   : à¹„à¸­à¸„à¸­à¸™à¸«à¸±à¸§à¸à¸¥à¹ˆà¸­à¸‡
        width   : à¸„à¸§à¸²à¸¡à¸à¸§à¹‰à¸²à¸‡à¸à¸¥à¹ˆà¸­à¸‡ (characters)
    """
    inner_width = width - 4  # à¸à¸·à¹‰à¸™à¸—à¸µà¹ˆà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ (à¸¥à¸šà¸à¸£à¸­à¸š 4 à¸”à¹‰à¸²à¸™)

    # à¸§à¸²à¸”à¸à¸£à¸­à¸šà¸šà¸™
    print(f"\n  â”Œ{'â”€' * (width - 2)}â”")
    print(f"  â”‚ {emoji} {title:<{inner_width - 2}}â”‚")
    print(f"  â”œ{'â”€' * (width - 2)}â”¤")
    print(f"  â”‚{' ' * (width - 2)}â”‚")

    # à¹à¸ªà¸”à¸‡à¹€à¸™à¸·à¹‰à¸­à¸«à¸²à¸—à¸µà¸¥à¸°à¸šà¸£à¸£à¸—à¸±à¸” à¸à¸£à¹‰à¸­à¸¡ Word-wrap
    for line in content.split("\n"):
        line = line.rstrip()

        if not line:
            # à¸šà¸£à¸£à¸—à¸±à¸”à¸§à¹ˆà¸²à¸‡
            print(f"  â”‚{' ' * (width - 2)}â”‚")
            continue

        # à¸•à¸±à¸”à¸šà¸£à¸£à¸—à¸±à¸”à¸¢à¸²à¸§à¹ƒà¸«à¹‰à¸à¸­à¸”à¸µà¸à¸¥à¹ˆà¸­à¸‡
        while len(line) > inner_width:
            cut_point = line[:inner_width].rfind(" ")
            if cut_point <= 0:
                cut_point = inner_width  # à¸•à¸±à¸”à¸à¸¥à¸²à¸‡à¸„à¸³à¸–à¹‰à¸²à¸ˆà¸³à¹€à¸›à¹‡à¸™
            print(f"  â”‚ {line[:cut_point]:<{inner_width}} â”‚")
            line = line[cut_point:].lstrip()

        print(f"  â”‚ {line:<{inner_width}} â”‚")

    # à¸§à¸²à¸”à¸à¸£à¸­à¸šà¸¥à¹ˆà¸²à¸‡
    print(f"  â”‚{' ' * (width - 2)}â”‚")
    print(f"  â””{'â”€' * (width - 2)}â”˜")


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹à¸ªà¸”à¸‡à¸œà¸¥: à¸•à¸²à¸£à¸²à¸‡ (Table)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def print_table(headers: List[str],
                rows: List[List[str]],
                title: str = ""):
    """
    à¹à¸ªà¸”à¸‡à¸•à¸²à¸£à¸²à¸‡à¸ªà¸§à¸¢à¸‡à¸²à¸¡ à¸à¸£à¹‰à¸­à¸¡à¸›à¸£à¸±à¸šà¸„à¸§à¸²à¸¡à¸à¸§à¹‰à¸²à¸‡à¹à¸•à¹ˆà¸¥à¸°à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œà¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´

    Parameters:
        headers : à¸Šà¸·à¹ˆà¸­à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œ ['Col A', 'Col B', ...]
        rows    : à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸•à¹ˆà¸¥à¸°à¹à¸–à¸§ [['a1', 'b1'], ['a2', 'b2'], ...]
        title   : à¸«à¸±à¸§à¸•à¸²à¸£à¸²à¸‡ (optional)
    """
    if title:
        print(f"\n  ğŸ“Š {title}")

    # à¸„à¸³à¸™à¸§à¸“à¸„à¸§à¸²à¸¡à¸à¸§à¹‰à¸²à¸‡à¹à¸•à¹ˆà¸¥à¸°à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œ = max(à¸„à¸§à¸²à¸¡à¸¢à¸²à¸§ header, à¸„à¸§à¸²à¸¡à¸¢à¸²à¸§ data)
    col_widths = [
        max(
            len(str(header)),
            max((len(str(row[i])) for row in rows), default=0)
        ) + 2
        for i, header in enumerate(headers)
    ]

    # à¸ªà¸£à¹‰à¸²à¸‡ separator à¹à¸•à¹ˆà¸¥à¸°à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œ
    def make_separator(left, mid, right):
        return f"  {left}" + f"{mid}".join("â”€" * (w + 1) for w in col_widths) + f"â”€{right}"

    # à¸§à¸²à¸”à¸«à¸±à¸§à¸•à¸²à¸£à¸²à¸‡
    print(make_separator("â”Œ", "â”€â”¬", "â”€â”"))

    header_line = "  â”‚".join(f" {h:^{w}}" for h, w in zip(headers, col_widths))
    print(f"  â”‚{header_line} â”‚")

    print(make_separator("â”œ", "â”€â”¼", "â”€â”¤"))

    # à¸§à¸²à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸•à¹ˆà¸¥à¸°à¹à¸–à¸§
    for row in rows:
        row_line = "  â”‚".join(f" {str(v):^{w}}" for v, w in zip(row, col_widths))
        print(f"  â”‚{row_line} â”‚")

    print(make_separator("â””", "â”€â”´", "â”€â”˜"))


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹à¸ªà¸”à¸‡à¸œà¸¥: Progress Bar à¹à¸¥à¸° Metric
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def print_progress(current: int, total: int,
                   label: str = "", bar_width: int = 30):
    """
    à¹à¸ªà¸”à¸‡ Progress Bar à¹à¸šà¸š text
    à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 27% Iter 1

    """
    pct = current / total if total > 0 else 0
    filled = int(bar_width * pct)
    bar = "â–ˆ" * filled + "â–‘" * (bar_width - filled)
    print(f"  [{bar}] {pct:.0%}  {label}")


def print_metric(label: str, value, unit: str = "", emoji: str = "ğŸ“ˆ"):
    """
    à¹à¸ªà¸”à¸‡ Metric à¸ªà¸±à¹‰à¸™à¹†
    à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡: ğŸ“ˆ Accuracy: 83.3%
    """
    if isinstance(value, float):
        print(f"    {emoji} {label}: {value:.1f}{unit}")
    else:
        print(f"    {emoji} {label}: {value}{unit}")


def print_divider(char: str = "â”€", width: int = 60):
    """à¹à¸ªà¸”à¸‡à¹€à¸ªà¹‰à¸™à¸„à¸±à¹ˆà¸™"""
    print(f"  {char * width}")


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  à¸—à¸”à¸ªà¸­à¸š Helper Functions
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

print_title("à¸—à¸”à¸ªà¸­à¸š Helper Functions", 1)
print_title("à¸£à¸°à¸”à¸±à¸š 2: à¸«à¸±à¸§à¸‚à¹‰à¸­à¸£à¸­à¸‡", 2)
print_title("à¸£à¸°à¸”à¸±à¸š 3: à¸«à¸±à¸§à¸‚à¹‰à¸­à¸¢à¹ˆà¸­à¸¢", 3)

print_box(
    title   = "à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡ Box",
    content = "à¸šà¸£à¸£à¸—à¸±à¸”à¸—à¸µà¹ˆ 1: Hello World\nà¸šà¸£à¸£à¸—à¸±à¸”à¸—à¸µà¹ˆ 2: à¸ªà¸§à¸±à¸ªà¸”à¸µà¹‚à¸¥à¸\n\nà¸šà¸£à¸£à¸—à¸±à¸”à¸§à¹ˆà¸²à¸‡ à¹à¸¥à¹‰à¸§à¸•à¹ˆà¸­...",
    emoji   = "ğŸ¯",
)

print_table(
    headers = ["à¹€à¸—à¸„à¸™à¸´à¸„", "à¸„à¸§à¸²à¸¡à¸‹à¸±à¸šà¸‹à¹‰à¸­à¸™", "à¹ƒà¸Šà¹‰à¹€à¸¡à¸·à¹ˆà¸­"],
    rows    = [
        ["Self-Consistency", "à¸›à¸²à¸™à¸à¸¥à¸²à¸‡", "Math / Logic"],
        ["Prompt Chaining",  "à¸ªà¸¹à¸‡",     "à¸‡à¸²à¸™à¸«à¸¥à¸²à¸¢à¸‚à¸±à¹‰à¸™"],
        ["Self-Critique",    "à¸ªà¸¹à¸‡",     "à¸•à¹‰à¸­à¸‡à¸à¸²à¸£ Accuracy à¸ªà¸¹à¸‡"],
    ],
    title = "à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸•à¸²à¸£à¸²à¸‡",
)

print_progress(70, 100, "Example 70%")
print_metric("Test Score", 92.5, "%", "ğŸ†")

# %%
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  à¸—à¸”à¸ªà¸­à¸šà¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ Gemini API
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

print_title("à¸—à¸”à¸ªà¸­à¸šà¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ Gemini API")

test_prompt = "à¸•à¸­à¸šà¸ªà¸±à¹‰à¸™à¹† à¸ à¸²à¸¢à¹ƒà¸™ 1 à¸›à¸£à¸°à¹‚à¸¢à¸„: MLflow à¸Šà¹ˆà¸§à¸¢à¸­à¸°à¹„à¸£à¹ƒà¸™à¸à¸²à¸£à¸à¸±à¸’à¸™à¸² AI?"
test_answer = call_gemini(test_prompt, max_tokens=100)

print_box(
    title   = "à¸„à¸³à¸–à¸²à¸¡à¸—à¸”à¸ªà¸­à¸š",
    content = f"Q: {test_prompt}\n\nA: {test_answer}",
    emoji   = "ğŸ§ª",
)

# %% [markdown]
# ---
# ## ğŸ“˜ à¹€à¸—à¸„à¸™à¸´à¸„à¸—à¸µà¹ˆ 1: Self-Consistency (SC)
#
# ### à¸«à¸¥à¸±à¸à¸à¸²à¸£
#
# à¹à¸—à¸™à¸—à¸µà¹ˆà¸ˆà¸°à¸–à¸²à¸¡à¸„à¸³à¸–à¸²à¸¡à¸„à¸£à¸±à¹‰à¸‡à¹€à¸”à¸µà¸¢à¸§ â†’ à¸–à¸²à¸¡ **N à¸„à¸£à¸±à¹‰à¸‡** à¸”à¹‰à¸§à¸¢ temperature à¸ªà¸¹à¸‡
# (à¸—à¸³à¹ƒà¸«à¹‰à¹„à¸”à¹‰ reasoning paths à¸—à¸µà¹ˆà¸«à¸¥à¸²à¸à¸«à¸¥à¸²à¸¢) â†’ **à¹‚à¸«à¸§à¸•à¹€à¸ªà¸µà¸¢à¸‡à¸‚à¹‰à¸²à¸‡à¸¡à¸²à¸**
#
# ### à¸—à¸³à¹„à¸¡à¸–à¸¶à¸‡à¹„à¸”à¹‰à¸œà¸¥?
#
# - AI à¸­à¸²à¸ˆà¹€à¸”à¸´à¸™à¸—à¸²à¸‡à¸œà¸´à¸”à¹ƒà¸™à¸šà¸²à¸‡à¸„à¸£à¸±à¹‰à¸‡ à¹à¸•à¹ˆà¸–à¹‰à¸²à¸–à¸²à¸¡ 5 à¸„à¸£à¸±à¹‰à¸‡ à¸ªà¹ˆà¸§à¸™à¹ƒà¸«à¸à¹ˆà¸ˆà¸°à¹„à¸”à¹‰à¸„à¸³à¸•à¸­à¸šà¸–à¸¹à¸
# - Majority voting à¸Šà¹ˆà¸§à¸¢à¸à¸£à¸­à¸‡à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¸­à¸­à¸
# - à¸¢à¸´à¹ˆà¸‡ N à¸¡à¸²à¸ à¸¢à¸´à¹ˆà¸‡à¹à¸¡à¹ˆà¸™à¸¢à¸³ (à¹à¸•à¹ˆà¹ƒà¸Šà¹‰à¹€à¸§à¸¥à¸²à¹à¸¥à¸° token à¸¡à¸²à¸à¸‚à¸¶à¹‰à¸™)
#
# ### à¹à¸œà¸™à¸œà¸±à¸‡
#
# ```
#                    â”Œâ”€ Path 1 (temp=0.7) â”€â”€ Answer: 42 â”€â”
#                    â”‚                                     â”‚
#  Question â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ Path 2 (temp=0.7) â”€â”€ Answer: 42 â”€â”¼â”€â”€â†’ à¹‚à¸«à¸§à¸• â†’ 42 âœ…
#                    â”‚                                     â”‚    (2/3)
#                    â””â”€ Path 3 (temp=0.7) â”€â”€ Answer: 38 â”€â”˜
# ```
#
# ### à¹€à¸«à¸¡à¸²à¸°à¸à¸±à¸šà¸‡à¸²à¸™à¸›à¸£à¸°à¹€à¸ à¸—à¹„à¸«à¸™?
#
# | âœ… à¹€à¸«à¸¡à¸²à¸° | âŒ à¹„à¸¡à¹ˆà¹€à¸«à¸¡à¸²à¸° |
# |---------|-----------|
# | à¸„à¸“à¸´à¸•à¸¨à¸²à¸ªà¸•à¸£à¹Œ | à¸‡à¸²à¸™à¸ªà¸£à¹‰à¸²à¸‡à¸ªà¸£à¸£à¸„à¹Œ |
# | Logic / Reasoning | à¸‡à¸²à¸™à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£ variety |
# | à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆà¸¡à¸µà¸„à¸³à¸•à¸­à¸šà¹€à¸”à¸µà¸¢à¸§ | à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸›à¸£à¸°à¸«à¸¢à¸±à¸” cost |

# %%
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ Self-Consistency Prompt v1 à¹ƒà¸™ MLflow
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

print_title("à¹€à¸—à¸„à¸™à¸´à¸„à¸—à¸µà¹ˆ 1: Self-Consistency")

SC_PROMPT_NAME = "sc_math_solver"

# Prompt Version 1: à¸‡à¹ˆà¸²à¸¢ à¸•à¸£à¸‡à¹„à¸›à¸•à¸£à¸‡à¸¡à¸²
SC_PROMPT_V1 = """à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸›à¸±à¸à¸«à¸²à¸•à¹ˆà¸­à¹„à¸›à¸™à¸µà¹‰à¹à¸¥à¸°à¹ƒà¸«à¹‰à¸„à¸³à¸•à¸­à¸š

à¸›à¸±à¸à¸«à¸²: {{ problem }}

à¹à¸ªà¸”à¸‡à¸§à¸´à¸˜à¸µà¸„à¸´à¸”à¸—à¸µà¸¥à¸°à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™ à¹à¸¥à¹‰à¸§à¸ªà¸£à¸¸à¸›à¸„à¸³à¸•à¸­à¸šà¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¹€à¸¥à¸‚"""

# à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¹ƒà¸™ MLflow Prompt Registry
sc_prompt_v1 = mlflow.genai.register_prompt(
    name=SC_PROMPT_NAME,
    template=SC_PROMPT_V1,
    commit_message="v1: Basic prompt â€” minimal instruction",
)

track_version(SC_PROMPT_NAME, sc_prompt_v1.version)

print(f"  âœ… à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆ: '{SC_PROMPT_NAME}' version {sc_prompt_v1.version}")
print_box(
    title   = f"SC Prompt v{sc_prompt_v1.version}",
    content = SC_PROMPT_V1,
    emoji   = "ğŸ“",
)

# %%
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Self-Consistency Engine: à¸ªà¹ˆà¸§à¸™à¸ªà¸³à¸„à¸±à¸à¸‚à¸­à¸‡à¹€à¸—à¸„à¸™à¸´à¸„
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def extract_number_from_text(text: str) -> str:
    """
    à¸ªà¸à¸±à¸”à¸•à¸±à¸§à¹€à¸¥à¸‚à¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢à¸ˆà¸²à¸ text
    à¹€à¸«à¸•à¸¸à¸œà¸¥: AI à¸¡à¸±à¸à¸ªà¸£à¸¸à¸›à¸„à¸³à¸•à¸­à¸šà¹„à¸§à¹‰à¸•à¸­à¸™à¸—à¹‰à¸²à¸¢ à¹€à¸Šà¹ˆà¸™ "à¸”à¸±à¸‡à¸™à¸±à¹‰à¸™ à¸„à¸³à¸•à¸­à¸šà¸„à¸·à¸­ 42"

    à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡:
        "...à¸”à¸±à¸‡à¸™à¸±à¹‰à¸™ à¸„à¸³à¸•à¸­à¸šà¸„à¸·à¸­ 1,575 à¸šà¸²à¸—" â†’ "1575"
        "à¹à¸•à¹ˆà¸¥à¸°à¸„à¸™à¹„à¸”à¹‰ 4 à¸¥à¸¹à¸"               â†’ "4"
    """
    # à¸«à¸²à¸•à¸±à¸§à¹€à¸¥à¸‚à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” (à¸£à¸§à¸¡ comma à¹à¸¥à¸° decimal)
    all_numbers = re.findall(r"\b\d[\d,]*(?:\.\d+)?\b", text)

    if not all_numbers:
        return "N/A"

    # à¹€à¸­à¸²à¸•à¸±à¸§à¹€à¸¥à¸‚à¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢ (à¸¡à¸±à¸à¹€à¸›à¹‡à¸™à¸„à¸³à¸•à¸­à¸šà¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢) à¹à¸¥à¸°à¸¥à¸š comma à¸­à¸­à¸
    last_number = all_numbers[-1].replace(",", "")
    return last_number


def run_self_consistency(template: str,
                         problem: str,
                         n_samples: int = 5,
                         temperature: float = 0.7,
                         show_details: bool = True) -> Dict:
    """
    à¸£à¸±à¸™ Self-Consistency: à¸ªà¸¸à¹ˆà¸¡à¸„à¸³à¸•à¸­à¸š N à¸„à¸£à¸±à¹‰à¸‡ â†’ Majority Vote

    Parameters:
        template     : Prompt template (à¸¡à¸µ {{ problem }})
        problem      : à¹‚à¸ˆà¸—à¸¢à¹Œà¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸„à¸³à¸•à¸­à¸š
        n_samples    : à¸ˆà¸³à¸™à¸§à¸™à¸„à¸£à¸±à¹‰à¸‡à¸—à¸µà¹ˆà¸–à¸²à¸¡ (à¸¡à¸²à¸à¸‚à¸¶à¹‰à¸™ = à¹à¸¡à¹ˆà¸™à¸¢à¸³à¸‚à¸¶à¹‰à¸™ à¹à¸•à¹ˆà¸Šà¹‰à¸²à¸¥à¸‡)
        temperature  : à¸„à¸§à¸²à¸¡à¸«à¸¥à¸²à¸à¸«à¸¥à¸²à¸¢à¸‚à¸­à¸‡à¸„à¸³à¸•à¸­à¸š (à¸ªà¸¹à¸‡ = à¸«à¸¥à¸²à¸à¸«à¸¥à¸²à¸¢)
        show_details : True = à¹à¸ªà¸”à¸‡à¸—à¸¸à¸ Path (debug mode)
                       False = à¹à¸ªà¸”à¸‡à¹à¸„à¹ˆà¸ªà¸£à¸¸à¸› (fast mode)

    Returns:
        dict: {
            "final_answer" : à¸„à¸³à¸•à¸­à¸šà¸—à¸µà¹ˆà¸Šà¸™à¸°à¸à¸²à¸£à¹‚à¸«à¸§à¸•
            "confidence"   : à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™ (à¹€à¸Šà¹ˆà¸™ 0.6 = 3/5)
            "answers"      : list à¸„à¸³à¸•à¸­à¸šà¸—à¸¸à¸ path
            "distribution" : à¸à¸²à¸£à¸à¸£à¸°à¸ˆà¸²à¸¢à¸‚à¸­à¸‡à¸„à¸³à¸•à¸­à¸š
        }
    """
    # à¹à¸—à¸™ placeholder à¸”à¹‰à¸§à¸¢à¹‚à¸ˆà¸—à¸¢à¹Œà¸ˆà¸£à¸´à¸‡
    filled_prompt = template.replace("{{ problem }}", problem)

    answers_collected = []
    full_responses = []

    print_title(f"à¸£à¸±à¸™ {n_samples} Reasoning Paths (temperature={temperature})", 2)

    # â”€â”€ à¸£à¸±à¸™ N paths â”€â”€
    for path_num in range(1, n_samples + 1):

        # à¹€à¸£à¸µà¸¢à¸ AI
        response = call_gemini(filled_prompt, temperature=temperature)
        full_responses.append(response)

        # à¸ªà¸à¸±à¸”à¸„à¸³à¸•à¸­à¸šà¸•à¸±à¸§à¹€à¸¥à¸‚
        extracted_ans = extract_number_from_text(response)
        answers_collected.append(extracted_ans)

        if show_details:
            # à¹à¸ªà¸”à¸‡à¸œà¸¥ path à¹€à¸•à¹‡à¸¡à¹† à¹ƒà¸™ box
            print_box(
                title   = f"Path {path_num}/{n_samples}  â†’  à¸„à¸³à¸•à¸­à¸š: {extracted_ans}",
                content = response,
                emoji   = "ğŸ§ ",
            )
        else:
            # à¹à¸ªà¸”à¸‡à¸ªà¸£à¸¸à¸›à¸ªà¸±à¹‰à¸™ (1 à¸šà¸£à¸£à¸—à¸±à¸”)
            preview = response.replace("\n", " ")[:65]
            status  = "âœ…" if extracted_ans != "N/A" else "âš ï¸"
            print(f"      {status} Path {path_num}: ans={extracted_ans:>10s}  â”‚  {preview}...")

        time.sleep(1.0)  # à¸«à¸™à¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²à¹€à¸¥à¹‡à¸à¸™à¹‰à¸­à¸¢ à¸›à¹‰à¸­à¸‡à¸à¸±à¸™ rate limit

    # â”€â”€ Majority Voting â”€â”€
    # à¸™à¸±à¸šà¹€à¸‰à¸à¸²à¸°à¸„à¸³à¸•à¸­à¸šà¸—à¸µà¹ˆà¸ªà¸à¸±à¸”à¹„à¸”à¹‰ (à¹„à¸¡à¹ˆà¸™à¸±à¸š "N/A")
    vote_counter = Counter(a for a in answers_collected if a != "N/A")

    if vote_counter:
        winner_ans, winner_count = vote_counter.most_common(1)[0]
        confidence = winner_count / n_samples
    else:
        winner_ans, confidence = "N/A", 0.0

    # â”€â”€ à¹à¸ªà¸”à¸‡à¸œà¸¥ Vote â”€â”€
    vote_lines = []
    for ans, count in vote_counter.most_common():
        filled_bar = "â–ˆ" * (count * 6)
        empty_bar  = "â–‘" * ((n_samples - count) * 6)
        is_winner  = "  â† Winner âœ…" if ans == winner_ans else ""
        vote_lines.append(f"  {ans:>12s} :  {filled_bar}{empty_bar}  ({count}/{n_samples}){is_winner}")

    vote_lines.append(f"\n  ğŸ† Final Answer : {winner_ans}")
    vote_lines.append(f"  ğŸ“Š Confidence   : {confidence:.0%}  ({int(confidence * n_samples)}/{n_samples} à¹€à¸«à¹‡à¸™à¸”à¹‰à¸§à¸¢)")

    print_box(
        title   = "à¸œà¸¥à¸à¸²à¸£à¹‚à¸«à¸§à¸• (Majority Vote)",
        content = "\n".join(vote_lines),
        emoji   = "ğŸ—³ï¸",
    )

    return {
        "final_answer" : winner_ans,
        "confidence"   : confidence,
        "answers"      : answers_collected,
        "distribution" : dict(vote_counter),
        "all_responses": full_responses,
    }


# %%
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  à¸—à¸”à¸ªà¸­à¸š Self-Consistency
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# à¹‚à¸ˆà¸—à¸¢à¹Œà¸‡à¹ˆà¸²à¸¢: à¸—à¸”à¸ªà¸­à¸šà¸§à¹ˆà¸² SC à¸—à¸³à¸‡à¸²à¸™à¹„à¸”à¹‰
EASY_PROBLEM = "à¸¡à¸µà¹à¸­à¸›à¹€à¸›à¸´à¹‰à¸¥ 24 à¸¥à¸¹à¸ à¹à¸šà¹ˆà¸‡à¹ƒà¸«à¹‰à¹€à¸”à¹‡à¸ 6 à¸„à¸™à¹€à¸—à¹ˆà¸²à¹† à¸à¸±à¸™ à¹à¸•à¹ˆà¸¥à¸°à¸„à¸™à¹„à¸”à¹‰à¸à¸µà¹ˆà¸¥à¸¹à¸?"

# à¹‚à¸ˆà¸—à¸¢à¹Œà¸¢à¸²à¸: à¸«à¸¥à¸²à¸¢à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™ à¸¡à¸µà¸«à¸™à¹ˆà¸§à¸¢à¸‹à¸±à¸šà¸‹à¹‰à¸­à¸™
HARD_PROBLEM = """à¸šà¸£à¸´à¸©à¸±à¸—à¸¡à¸µà¸à¸™à¸±à¸à¸‡à¸²à¸™ 3 à¹à¸œà¸™à¸:
- à¹à¸œà¸™à¸ A: 15 à¸„à¸™ à¹€à¸‡à¸´à¸™à¹€à¸”à¸·à¸­à¸™à¹€à¸‰à¸¥à¸µà¹ˆà¸¢ 35,000 à¸šà¸²à¸—
- à¹à¸œà¸™à¸ B: 20 à¸„à¸™ à¹€à¸‡à¸´à¸™à¹€à¸”à¸·à¸­à¸™à¹€à¸‰à¸¥à¸µà¹ˆà¸¢ 42,000 à¸šà¸²à¸—
- à¹à¸œà¸™à¸ C: 10 à¸„à¸™ à¹€à¸‡à¸´à¸™à¹€à¸”à¸·à¸­à¸™à¹€à¸‰à¸¥à¸µà¹ˆà¸¢ 58,000 à¸šà¸²à¸—

à¸šà¸£à¸´à¸©à¸±à¸—à¸ˆà¸°à¸‚à¸¶à¹‰à¸™à¹€à¸‡à¸´à¸™à¹€à¸”à¸·à¸­à¸™à¸—à¸¸à¸à¸„à¸™ 8%
à¸„à¹ˆà¸²à¹ƒà¸Šà¹‰à¸ˆà¹ˆà¸²à¸¢à¹€à¸‡à¸´à¸™à¹€à¸”à¸·à¸­à¸™à¸£à¸§à¸¡à¸•à¹ˆà¸­à¹€à¸”à¸·à¸­à¸™à¸«à¸¥à¸±à¸‡à¸‚à¸¶à¹‰à¸™à¹€à¸‡à¸´à¸™à¹€à¸”à¸·à¸­à¸™à¹€à¸›à¹‡à¸™à¹€à¸—à¹ˆà¸²à¹„à¸«à¸£à¹ˆ?"""

# â”€â”€ à¸—à¸”à¸ªà¸­à¸šà¹‚à¸ˆà¸—à¸¢à¹Œà¸‡à¹ˆà¸²à¸¢ â”€â”€
print_title("à¸—à¸”à¸ªà¸­à¸š: à¹‚à¸ˆà¸—à¸¢à¹Œà¸‡à¹ˆà¸²à¸¢ (à¸«à¸²à¸£)")
print_box("à¹‚à¸ˆà¸—à¸¢à¹Œ", EASY_PROBLEM, "â“")
sc_easy_result = run_self_consistency(SC_PROMPT_V1, EASY_PROBLEM, n_samples=3)

# â”€â”€ à¸—à¸”à¸ªà¸­à¸šà¹‚à¸ˆà¸—à¸¢à¹Œà¸¢à¸²à¸ â”€â”€
print_title("à¸—à¸”à¸ªà¸­à¸š: à¹‚à¸ˆà¸—à¸¢à¹Œà¸¢à¸²à¸ (à¸„à¸³à¸™à¸§à¸“à¹€à¸‡à¸´à¸™à¹€à¸”à¸·à¸­à¸™)")
print_box("à¹‚à¸ˆà¸—à¸¢à¹Œ", HARD_PROBLEM, "â“")
sc_hard_result = run_self_consistency(SC_PROMPT_V1, HARD_PROBLEM, n_samples=5)

# %% [markdown]
# ---
# ## ğŸ“˜ à¹€à¸—à¸„à¸™à¸´à¸„à¸—à¸µà¹ˆ 2: Prompt Chaining
#
# ### à¸«à¸¥à¸±à¸à¸à¸²à¸£
#
# à¹à¸—à¸™à¸—à¸µà¹ˆà¸ˆà¸°à¹€à¸‚à¸µà¸¢à¸™ Prompt à¸¢à¸²à¸§à¹† à¸„à¸£à¸±à¹‰à¸‡à¹€à¸”à¸µà¸¢à¸§ â†’ **à¹à¸šà¹ˆà¸‡à¸‡à¸²à¸™à¸­à¸­à¸à¹€à¸›à¹‡à¸™à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸¢à¹ˆà¸­à¸¢**
# à¹‚à¸”à¸¢ output à¸‚à¸­à¸‡à¹à¸•à¹ˆà¸¥à¸°à¸‚à¸±à¹‰à¸™ à¸ˆà¸°à¹€à¸›à¹‡à¸™ input à¸‚à¸­à¸‡à¸‚à¸±à¹‰à¸™à¸–à¸±à¸”à¹„à¸›
#
# ### à¸—à¸³à¹„à¸¡à¸–à¸¶à¸‡à¹„à¸”à¹‰à¸œà¸¥?
#
# - AI à¸—à¸³à¸‡à¸²à¸™à¹„à¸”à¹‰à¸”à¸µà¸‚à¸¶à¹‰à¸™à¹€à¸¡à¸·à¹ˆà¸­ focus à¸—à¸µà¸¥à¸°à¸­à¸¢à¹ˆà¸²à¸‡
# - Debug à¸‡à¹ˆà¸²à¸¢: à¸£à¸¹à¹‰à¸§à¹ˆà¸²à¸‚à¸±à¹‰à¸™à¹„à¸«à¸™à¸œà¸´à¸”
# - à¹à¸•à¹ˆà¸¥à¸°à¸‚à¸±à¹‰à¸™à¸ªà¸²à¸¡à¸²à¸£à¸– optimize à¹à¸¢à¸à¸à¸±à¸™à¹„à¸”à¹‰
# - à¹ƒà¸Šà¹‰ output à¸ˆà¸²à¸à¸‚à¸±à¹‰à¸™à¸à¹ˆà¸­à¸™à¹€à¸›à¹‡à¸™ context
#
# ### à¹à¸œà¸™à¸œà¸±à¸‡ Lab à¸™à¸µà¹‰ (à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ Review)
#
# ```
#  Review â”€â”€â†’ [Step 1: Extract]  â”€â”€â†’ JSON à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸”à¸´à¸š
#                                         â”‚
#                                         â–¼
#             [Step 2: Analyze] â”€â”€â†’ Score + Business Insight
#                                         â”‚
#                                         â–¼
#             [Step 3: Report]  â”€â”€â†’ Executive Summary
# ```
#
# ### à¹€à¸«à¸¡à¸²à¸°à¸à¸±à¸šà¸‡à¸²à¸™à¸›à¸£à¸°à¹€à¸ à¸—à¹„à¸«à¸™?
#
# | âœ… à¹€à¸«à¸¡à¸²à¸° | âŒ à¹„à¸¡à¹ˆà¹€à¸«à¸¡à¸²à¸° |
# |---------|-----------|
# | à¸‡à¸²à¸™à¸—à¸µà¹ˆà¹à¸šà¹ˆà¸‡à¸‚à¸±à¹‰à¸™à¹„à¸”à¹‰à¸Šà¸±à¸” | à¸‡à¸²à¸™à¸‡à¹ˆà¸²à¸¢à¹† 1 à¸‚à¸±à¹‰à¸™ |
# | à¸•à¹‰à¸­à¸‡à¸à¸²à¸£ intermediate results | à¸•à¹‰à¸­à¸‡à¸à¸²à¸£ speed à¸ªà¸¹à¸‡ |
# | à¸‡à¸²à¸™ document processing | à¸•à¹‰à¸™à¸—à¸¸à¸™ API à¸•à¹ˆà¸³ |

# %%
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ Prompt Chain 3 à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™ à¹ƒà¸™ MLflow
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

print_title("à¹€à¸—à¸„à¸™à¸´à¸„à¸—à¸µà¹ˆ 2: Prompt Chaining")

# â”€â”€ à¸à¸³à¸«à¸™à¸” Template à¹à¸•à¹ˆà¸¥à¸°à¸‚à¸±à¹‰à¸™ â”€â”€

CHAIN_PROMPTS = {

    # à¸‚à¸±à¹‰à¸™à¸—à¸µà¹ˆ 1: à¸ªà¸à¸±à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¸„à¸±à¸à¸ˆà¸²à¸ Review
    "chain_extract": {
        "template": """à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™à¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸”à¹‰à¸²à¸™à¸à¸²à¸£à¸ªà¸à¸±à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ Review

à¸£à¸µà¸§à¸´à¸§:
{{ review }}

à¸‡à¸²à¸™: à¸ªà¸à¸±à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¸„à¸±à¸à¸­à¸­à¸à¸¡à¸²à¹ƒà¸«à¹‰à¸„à¸£à¸šà¸–à¹‰à¸§à¸™ à¸•à¸­à¸šà¹€à¸›à¹‡à¸™ JSON à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™

{
  "positive_points"  : ["à¸ˆà¸¸à¸”à¸”à¸µà¸—à¸µà¹ˆà¸¥à¸¹à¸à¸„à¹‰à¸²à¸à¸¥à¹ˆà¸²à¸§à¸–à¸¶à¸‡"],
  "negative_points"  : ["à¸ˆà¸¸à¸”à¸”à¹‰à¸­à¸¢à¸—à¸µà¹ˆà¸¥à¸¹à¸à¸„à¹‰à¸²à¸à¸¥à¹ˆà¸²à¸§à¸–à¸¶à¸‡"],
  "overall_emotion"  : "positive / negative / mixed",
  "has_sarcasm"      : "yes / no â€” à¸­à¸˜à¸´à¸šà¸²à¸¢à¸ªà¸±à¹‰à¸™à¹† à¸§à¹ˆà¸²à¹€à¸ˆà¸­à¸•à¸£à¸‡à¹„à¸«à¸™",
  "would_recommend"  : "yes / no / neutral"
}""",
        "commit_message": "v1: à¸ªà¸à¸±à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸·à¹‰à¸™à¸à¸²à¸™à¸ˆà¸²à¸ Review",
    },

    # à¸‚à¸±à¹‰à¸™à¸—à¸µà¹ˆ 2: à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ Sentiment à¹à¸¥à¸° Business Impact
    "chain_analyze": {
        "template": """à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™à¸™à¸±à¸à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ Sentiment à¹à¸¥à¸° Business Intelligence

à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸ªà¸à¸±à¸”à¸ˆà¸²à¸ Review:
{{ extracted }}

à¸‡à¸²à¸™: à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹€à¸Šà¸´à¸‡à¸¥à¸¶à¸ à¸•à¸­à¸šà¹€à¸›à¹‡à¸™ JSON à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™

{
  "sentiment_score"   : "0-10 (0=à¹à¸¢à¹ˆà¸¡à¸²à¸, 10=à¸”à¸µà¸¡à¸²à¸)",
  "urgent_fixes"      : ["à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¹à¸à¹‰à¹€à¸£à¹ˆà¸‡à¸”à¹ˆà¸§à¸™ à¹€à¸£à¸µà¸¢à¸‡à¸•à¸²à¸¡à¸„à¸§à¸²à¸¡à¸ªà¸³à¸„à¸±à¸"],
  "business_opportunities" : ["à¹‚à¸­à¸à¸²à¸ªà¸—à¸²à¸‡à¸˜à¸¸à¸£à¸à¸´à¸ˆà¸—à¸µà¹ˆà¹€à¸«à¹‡à¸™à¹„à¸”à¹‰"],
  "business_risks"    : ["à¸„à¸§à¸²à¸¡à¹€à¸ªà¸µà¹ˆà¸¢à¸‡à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¹à¸à¹‰à¹„à¸‚"]
}""",
        "commit_message": "v1: à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ Sentiment + Business Impact",
    },

    # à¸‚à¸±à¹‰à¸™à¸—à¸µà¹ˆ 3: à¸ªà¸£à¸¸à¸›à¸£à¸²à¸¢à¸‡à¸²à¸™à¸ªà¸³à¸«à¸£à¸±à¸šà¸œà¸¹à¹‰à¸šà¸£à¸´à¸«à¸²à¸£
    "chain_report": {
        "template": """à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™ Business Report Writer à¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸

à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸”à¸´à¸šà¸ˆà¸²à¸ Review:
{{ extracted }}

à¸œà¸¥à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ:
{{ analysis }}

à¸‡à¸²à¸™: à¹€à¸‚à¸µà¸¢à¸™ Executive Summary à¸à¸£à¸°à¸Šà¸±à¸š à¸Šà¸±à¸”à¹€à¸ˆà¸™ à¹ƒà¸Šà¹‰à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆà¹„à¸”à¹‰à¸—à¸±à¸™à¸—à¸µ

à¸£à¸¹à¸›à¹à¸šà¸š:
**HEADLINE:** [à¸ªà¸£à¸¸à¸›à¸ªà¸–à¸²à¸™à¸à¸²à¸£à¸“à¹Œà¹ƒà¸™ 1 à¸›à¸£à¸°à¹‚à¸¢à¸„]

**KEY FINDINGS:**
â€¢ [à¸‚à¹‰à¸­à¸„à¹‰à¸™à¸à¸šà¸ªà¸³à¸„à¸±à¸à¸—à¸µà¹ˆ 1]
â€¢ [à¸‚à¹‰à¸­à¸„à¹‰à¸™à¸à¸šà¸ªà¸³à¸„à¸±à¸à¸—à¸µà¹ˆ 2]
â€¢ [à¸‚à¹‰à¸­à¸„à¹‰à¸™à¸à¸šà¸ªà¸³à¸„à¸±à¸à¸—à¸µà¹ˆ 3]

**PRIORITY ACTIONS:**
1. [à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸—à¸³à¸—à¸±à¸™à¸—à¸µ]
2. [à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸—à¸³à¸ à¸²à¸¢à¹ƒà¸™ 1 à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ]
3. [à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸—à¸³à¸ à¸²à¸¢à¹ƒà¸™ 1 à¹€à¸”à¸·à¸­à¸™]

**RISK LEVEL:** LOW / MEDIUM / HIGH
**REASON:** [à¹€à¸«à¸•à¸¸à¸œà¸¥ 1-2 à¸›à¸£à¸°à¹‚à¸¢à¸„]""",
        "commit_message": "v1: à¸ªà¸£à¹‰à¸²à¸‡ Executive Summary Report",
    },
}

# â”€â”€ à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸—à¸¸à¸ Prompt à¹ƒà¸™ MLflow â”€â”€
registered_chain_prompts = {}

for prompt_name, prompt_info in CHAIN_PROMPTS.items():
    registered = mlflow.genai.register_prompt(
        name=prompt_name,
        template=prompt_info["template"],
        commit_message=prompt_info["commit_message"],
    )
    registered_chain_prompts[prompt_name] = registered
    track_version(prompt_name, registered.version)

    print(f"  âœ… à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™: '{prompt_name}' version {registered.version}")

print_divider()
print(f"  ğŸ“¦ à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ Prompt Chain à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” {len(CHAIN_PROMPTS)} à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™")

# %%
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Chain Runner: à¸£à¸±à¸™ 3 à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸•à¹ˆà¸­à¹€à¸™à¸·à¹ˆà¸­à¸‡à¸à¸±à¸™
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def run_prompt_chain(review_text: str) -> Dict:
    """
    à¸£à¸±à¸™ Prompt Chain 3 à¸‚à¸±à¹‰à¸™: Extract â†’ Analyze â†’ Report

    Output à¸‚à¸­à¸‡à¹à¸•à¹ˆà¸¥à¸°à¸‚à¸±à¹‰à¸™à¸ˆà¸°à¸–à¸¹à¸à¸ªà¹ˆà¸‡à¸•à¹ˆà¸­à¹€à¸›à¹‡à¸™ Input à¸‚à¸­à¸‡à¸‚à¸±à¹‰à¸™à¸–à¸±à¸”à¹„à¸›

    Parameters:
        review_text : à¸£à¸µà¸§à¸´à¸§à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ

    Returns:
        dict: à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¸ˆà¸²à¸à¸—à¸¸à¸à¸‚à¸±à¹‰à¸™ {
            "chain_extract": "...",
            "chain_analyze": "...",
            "chain_report" : "...",
        }
    """
    step_results = {}

    step_configs = [
        {
            "name"  : "chain_extract",
            "emoji" : "ğŸ”",
            "label" : "à¸ªà¸à¸±à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ (Extract)",
            "build_prompt": lambda p, _: p.format(review=review_text),
        },
        {
            "name"  : "chain_analyze",
            "emoji" : "ğŸ“Š",
            "label" : "à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ Sentiment (Analyze)",
            "build_prompt": lambda p, r: p.format(extracted=r.get("chain_extract", "")),
        },
        {
            "name"  : "chain_report",
            "emoji" : "ğŸ“‹",
            "label" : "à¸ªà¸£à¸¸à¸›à¸£à¸²à¸¢à¸‡à¸²à¸™ (Report)",
            "build_prompt": lambda p, r: p.format(
                extracted = r.get("chain_extract", ""),
                analysis  = r.get("chain_analyze", ""),
            ),
        },
    ]

    print_title(f"à¸£à¸±à¸™ Prompt Chain ({len(step_configs)} à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™)", 2)

    for step_num, step in enumerate(step_configs, start=1):
        # à¹‚à¸«à¸¥à¸” prompt à¹€à¸§à¸­à¸£à¹Œà¸Šà¸±à¸™à¸¥à¹ˆà¸²à¸ªà¸¸à¸”
        prompt = load_latest_prompt(step["name"])

        # à¸ªà¸£à¹‰à¸²à¸‡ prompt à¸ˆà¸£à¸´à¸‡à¹‚à¸”à¸¢à¹à¸—à¸™à¸„à¹ˆà¸²
        filled = step["build_prompt"](prompt, step_results)

        # à¹€à¸£à¸µà¸¢à¸ AI à¹à¸¥à¸°à¸ˆà¸±à¸šà¹€à¸§à¸¥à¸²
        start_time = time.time()
        result     = call_gemini(filled)
        elapsed    = time.time() - start_time

        step_results[step["name"]] = result

        # à¹à¸ªà¸”à¸‡à¸œà¸¥à¹à¸•à¹ˆà¸¥à¸°à¸‚à¸±à¹‰à¸™
        print_box(
            title   = f"à¸‚à¸±à¹‰à¸™à¸—à¸µà¹ˆ {step_num}: {step['label']}  â±ï¸ {elapsed:.1f}s",
            content = result,
            emoji   = step["emoji"],
        )

        time.sleep(1.0)

    print(f"\n  âœ… Chain à¸ªà¸³à¹€à¸£à¹‡à¸ˆ! à¸œà¹ˆà¸²à¸™à¸—à¸±à¹‰à¸‡ {len(step_configs)} à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™")
    return step_results


# %%
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  à¸—à¸”à¸ªà¸­à¸š Prompt Chain à¸”à¹‰à¸§à¸¢ Review à¹à¸šà¸š Sarcastic (à¸›à¸£à¸°à¸Šà¸”à¸›à¸£à¸°à¸Šà¸±à¸™)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Review à¸—à¸µà¹ˆà¸¡à¸µà¸à¸²à¸£à¸›à¸£à¸°à¸Šà¸”à¸›à¸£à¸°à¸Šà¸±à¸™ à¸—à¸”à¸ªà¸­à¸šà¸§à¹ˆà¸² Chain à¸ªà¸²à¸¡à¸²à¸£à¸–à¸ˆà¸±à¸šà¹„à¸”à¹‰à¹„à¸«à¸¡
SARCASTIC_REVIEW = """
à¸§à¹‰à¸²à¸§! à¸›à¸£à¸°à¸—à¸±à¸šà¹ƒà¸ˆà¸¡à¸²à¸à¸ˆà¸£à¸´à¸‡à¹† à¸„à¸£à¸±à¸š à¸ªà¸±à¹ˆà¸‡à¹„à¸›à¹€à¸¡à¸·à¹ˆà¸­ 3 à¸­à¸²à¸—à¸´à¸•à¸¢à¹Œà¸—à¸µà¹ˆà¹à¸¥à¹‰à¸§ à¹€à¸à¸´à¹ˆà¸‡à¹„à¸”à¹‰à¸£à¸±à¸šà¸§à¸±à¸™à¸™à¸µà¹‰à¹€à¸­à¸‡
à¸Šà¹‰à¸²à¹à¸„à¹ˆà¸™à¸µà¹‰à¹€à¸­à¸‡à¸™à¸° à¸£à¸°à¸”à¸±à¸š World Class à¸¡à¸²à¸à¹†

à¸•à¸±à¸§à¸ªà¸´à¸™à¸„à¹‰à¸²à¸à¹‡à¸”à¸µà¸„à¸£à¸±à¸š à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸™à¸±à¸šà¸§à¹ˆà¸²à¸¡à¸±à¸™à¹à¸•à¸à¸¡à¸²à¸„à¸£à¸¶à¹ˆà¸‡à¸«à¸™à¸¶à¹ˆà¸‡ à¸à¹‡à¸–à¸·à¸­à¸§à¹ˆà¸²à¹‚à¸­à¹€à¸„à¸™à¸°
à¸ˆà¹ˆà¸²à¸¢à¹„à¸› 2,500 à¸šà¸²à¸— à¹„à¸”à¹‰à¸‚à¸­à¸‡à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¹„à¸”à¹‰à¹à¸„à¹ˆ 3 à¸§à¸±à¸™ à¸„à¸¸à¹‰à¸¡à¸¡à¸²à¸à¹†

Customer Service à¸•à¸­à¸šà¹€à¸£à¹‡à¸§à¸¡à¸²à¸à¸ à¸²à¸¢à¹ƒà¸™ 5 à¸§à¸±à¸™à¸—à¸³à¸à¸²à¸£ à¸›à¸£à¸°à¸—à¸±à¸šà¹ƒà¸ˆà¹ƒà¸™à¸„à¸§à¸²à¸¡à¸£à¸§à¸”à¹€à¸£à¹‡à¸§

à¹‚à¸”à¸¢à¸£à¸§à¸¡à¸–à¹‰à¸²à¸Šà¸­à¸šà¸„à¸§à¸²à¸¡à¸•à¸·à¹ˆà¸™à¹€à¸•à¹‰à¸™à¸§à¹ˆà¸²à¸‚à¸­à¸‡à¸ˆà¸°à¸¡à¸²à¸–à¸¶à¸‡à¸¡à¸·à¸­à¸«à¸£à¸·à¸­à¹€à¸›à¸¥à¹ˆà¸² à¹à¸™à¸°à¸™à¸³à¹€à¸¥à¸¢à¸„à¸£à¸±à¸š
"""

print_box(
    title   = "Review à¸—à¸”à¸ªà¸­à¸š (à¹à¸šà¸šà¸›à¸£à¸°à¸Šà¸”à¸›à¸£à¸°à¸Šà¸±à¸™)",
    content = SARCASTIC_REVIEW,
    emoji   = "ğŸ’¬",
)

chain_results = run_prompt_chain(SARCASTIC_REVIEW)

# %% [markdown]
# ---
# ## ğŸ“˜ à¹€à¸—à¸„à¸™à¸´à¸„à¸—à¸µà¹ˆ 3: Self-Critique
#
# ### à¸«à¸¥à¸±à¸à¸à¸²à¸£
#
# à¹ƒà¸«à¹‰ AI **à¸•à¸£à¸§à¸ˆà¹à¸¥à¸°à¸§à¸´à¸à¸²à¸à¸©à¹Œà¸„à¸³à¸•à¸­à¸šà¸•à¸±à¸§à¹€à¸­à¸‡** à¹à¸¥à¹‰à¸§à¸™à¸³à¸œà¸¥à¸§à¸´à¸à¸²à¸à¸©à¹Œà¸¡à¸²à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡
#
# à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸«à¸¡à¸·à¸­à¸™à¸™à¸±à¸à¹€à¸‚à¸µà¸¢à¸™à¸—à¸µà¹ˆà¹€à¸‚à¸µà¸¢à¸™à¸£à¹ˆà¸²à¸‡à¹à¸£à¸ â†’ à¹à¸à¹‰à¹„à¸‚à¹€à¸­à¸‡ â†’ à¸£à¹ˆà¸²à¸‡à¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢à¸”à¸µà¸‚à¸¶à¹‰à¸™
#
# ### à¹à¸œà¸™à¸œà¸±à¸‡
#
# ```
#  à¸„à¸³à¸–à¸²à¸¡ â”€â”€â†’ [Generate]  â”€â”€â†’  à¸„à¸³à¸•à¸­à¸š Draft
#                                    â”‚
#                                    â–¼
#             [Critique]  â”€â”€â†’  à¸ˆà¸¸à¸”à¸­à¹ˆà¸­à¸™ / à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”
#                                    â”‚
#                                    â–¼
#             [Revise]    â”€â”€â†’  à¸„à¸³à¸•à¸­à¸š Final (à¸”à¸µà¸‚à¸¶à¹‰à¸™)
#                                    â”‚
#                            (à¸—à¸³à¸‹à¹‰à¸³à¹„à¸”à¹‰ N à¸£à¸­à¸š)
# ```
#
# ### à¸‚à¹‰à¸­à¸”à¸µ vs à¸‚à¹‰à¸­à¹€à¸ªà¸µà¸¢
#
# | âœ… à¸‚à¹‰à¸­à¸”à¸µ | âš ï¸ à¸‚à¹‰à¸­à¹€à¸ªà¸µà¸¢ |
# |---------|----------|
# | à¸¥à¸” bias à¹à¸¥à¸° logical fallacy | à¹ƒà¸Šà¹‰ token à¸¡à¸²à¸à¸à¸§à¹ˆà¸² 3x |
# | à¹„à¸”à¹‰à¸„à¸³à¸•à¸­à¸šà¸£à¸­à¸šà¸”à¹‰à¸²à¸™à¸‚à¸¶à¹‰à¸™ | à¸Šà¹‰à¸²à¸à¸§à¹ˆà¸² |
# | à¹€à¸«à¸¡à¸²à¸°à¸à¸±à¸šà¸«à¸±à¸§à¸‚à¹‰à¸­ controversial | à¸­à¸²à¸ˆ over-critique |

# %%
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ Self-Critique Prompts à¹ƒà¸™ MLflow
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

print_title("à¹€à¸—à¸„à¸™à¸´à¸„à¸—à¸µà¹ˆ 3: Self-Critique")

CRITIQUE_PROMPTS = {

    # à¸‚à¸±à¹‰à¸™à¸—à¸µà¹ˆ 1: à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸³à¸•à¸­à¸šà¹€à¸šà¸·à¹‰à¸­à¸‡à¸•à¹‰à¸™
    "crit_generate": {
        "template": """à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™à¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸—à¸µà¹ˆà¹ƒà¸«à¹‰à¸„à¸³à¹à¸™à¸°à¸™à¸³à¸­à¸¢à¹ˆà¸²à¸‡à¸£à¸­à¸šà¸„à¸­à¸šà¹à¸¥à¸°à¸ªà¸¡à¸”à¸¸à¸¥

à¸„à¸³à¸–à¸²à¸¡: {{ task }}

à¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¸™à¸µà¹‰à¸­à¸¢à¹ˆà¸²à¸‡à¸„à¸£à¸­à¸šà¸„à¸¥à¸¸à¸¡ à¸à¸´à¸ˆà¸²à¸£à¸“à¸²à¸«à¸¥à¸²à¸¢à¸¡à¸¸à¸¡à¸¡à¸­à¸‡
à¸à¸£à¹‰à¸­à¸¡à¹ƒà¸«à¹‰à¹€à¸«à¸•à¸¸à¸œà¸¥à¸Šà¸±à¸”à¹€à¸ˆà¸™à¸ªà¸³à¸«à¸£à¸±à¸šà¸—à¸¸à¸à¸‚à¹‰à¸­""",
        "commit_message": "v1: Generate initial answer",
    },

    # à¸‚à¸±à¹‰à¸™à¸—à¸µà¹ˆ 2: à¸§à¸´à¸à¸²à¸à¸©à¹Œà¸„à¸³à¸•à¸­à¸šà¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸‚à¹‰à¸¡à¸‚à¹‰à¸™
    "crit_critic": {
        "template": """à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™ Devil's Advocate à¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸ â€” à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¸„à¸·à¸­à¸«à¸²à¸ˆà¸¸à¸”à¸­à¹ˆà¸­à¸™à¸—à¸¸à¸à¸­à¸¢à¹ˆà¸²à¸‡

à¹‚à¸ˆà¸—à¸¢à¹Œà¹€à¸”à¸´à¸¡:
{{ task }}

à¸„à¸³à¸•à¸­à¸šà¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸§à¸´à¸à¸²à¸à¸©à¹Œ:
{{ answer }}

à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸‚à¹‰à¸¡à¸‚à¹‰à¸™à¸•à¸²à¸¡à¸«à¸±à¸§à¸‚à¹‰à¸­à¹€à¸«à¸¥à¹ˆà¸²à¸™à¸µà¹‰:

â–¡ Logical Fallacies  â€” à¸¡à¸µà¸à¸²à¸£à¹ƒà¸Šà¹‰à¸•à¸£à¸£à¸à¸°à¸—à¸µà¹ˆà¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹„à¸«à¸¡?
â–¡ Unsupported Claims â€” à¸¡à¸µà¸à¸²à¸£à¸­à¹‰à¸²à¸‡à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸¡à¸µà¸«à¸¥à¸±à¸à¸à¸²à¸™à¸ªà¸™à¸±à¸šà¸ªà¸™à¸¸à¸™à¹„à¸«à¸¡?
â–¡ Missing Perspectives â€” à¸‚à¸²à¸”à¸¡à¸¸à¸¡à¸¡à¸­à¸‡à¸ªà¸³à¸„à¸±à¸à¸­à¸°à¹„à¸£à¹„à¸›à¸šà¹‰à¸²à¸‡?
â–¡ Bias â€” à¸¡à¸µà¸„à¸§à¸²à¸¡à¸¥à¸³à¹€à¸­à¸µà¸¢à¸‡à¹„à¸«à¸¡? (à¹€à¸Šà¹ˆà¸™ à¹€à¸‚à¹‰à¸²à¸‚à¹‰à¸²à¸‡à¸à¹ˆà¸²à¸¢à¹ƒà¸”à¸à¹ˆà¸²à¸¢à¸«à¸™à¸¶à¹ˆà¸‡)
â–¡ Feasibility â€” à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¹à¸™à¸°à¸™à¸³à¸—à¸³à¹„à¸”à¹‰à¸ˆà¸£à¸´à¸‡à¹ƒà¸™à¸—à¸²à¸‡à¸›à¸à¸´à¸šà¸±à¸•à¸´à¹„à¸«à¸¡?

âš ï¸ à¸‚à¹‰à¸­à¸à¸³à¸«à¸™à¸”: à¸•à¹‰à¸­à¸‡à¸«à¸²à¸›à¸±à¸à¸«à¸²à¸­à¸¢à¹ˆà¸²à¸‡à¸™à¹‰à¸­à¸¢ 3 à¸‚à¹‰à¸­ à¸«à¹‰à¸²à¸¡à¸à¸¹à¸”à¸§à¹ˆà¸²à¸”à¸µà¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¸Šà¸µà¹‰à¸‚à¹‰à¸­à¸œà¸´à¸”

à¸•à¸­à¸šà¹ƒà¸™à¸£à¸¹à¸›à¹à¸šà¸š:
ISSUES:
- [à¸›à¸±à¸à¸«à¸²à¸—à¸µà¹ˆ 1: à¸­à¸˜à¸´à¸šà¸²à¸¢à¸Šà¸±à¸”à¹€à¸ˆà¸™]
- [à¸›à¸±à¸à¸«à¸²à¸—à¸µà¹ˆ 2: à¸­à¸˜à¸´à¸šà¸²à¸¢à¸Šà¸±à¸”à¹€à¸ˆà¸™]
- [à¸›à¸±à¸à¸«à¸²à¸—à¸µà¹ˆ 3: à¸­à¸˜à¸´à¸šà¸²à¸¢à¸Šà¸±à¸”à¹€à¸ˆà¸™]

VERDICT: WEAK / ACCEPTABLE / STRONG
SUMMARY: [à¸ªà¸£à¸¸à¸› 2 à¸›à¸£à¸°à¹‚à¸¢à¸„ à¸§à¹ˆà¸²à¸—à¸³à¹„à¸¡à¸–à¸¶à¸‡à¹ƒà¸«à¹‰ verdict à¸™à¸µà¹‰]""",
        "commit_message": "v1: Adversarial critic with structured output",
    },

    # à¸‚à¸±à¹‰à¸™à¸—à¸µà¹ˆ 3: à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸„à¸³à¸•à¸­à¸šà¹‚à¸”à¸¢à¹ƒà¸Šà¹‰à¸œà¸¥à¸§à¸´à¸à¸²à¸à¸©à¹Œ
    "crit_revise": {
        "template": """à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™à¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸—à¸µà¹ˆà¸£à¸±à¸šà¸œà¸¥à¸§à¸´à¸à¸²à¸à¸©à¹Œà¸¡à¸²à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸„à¸³à¸•à¸­à¸š

à¹‚à¸ˆà¸—à¸¢à¹Œà¹€à¸”à¸´à¸¡:
{{ task }}

à¸„à¸³à¸•à¸­à¸šà¹€à¸”à¸´à¸¡:
{{ answer }}

à¸œà¸¥à¸§à¸´à¸à¸²à¸à¸©à¹Œà¸ˆà¸²à¸ Critic:
{{ critique }}

à¸‡à¸²à¸™: à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸„à¸³à¸•à¸­à¸šà¹‚à¸”à¸¢:
1. à¹à¸à¹‰à¹„à¸‚à¸—à¸¸à¸à¸›à¸±à¸à¸«à¸²à¸—à¸µà¹ˆà¸–à¸¹à¸à¸Šà¸µà¹‰à¹ƒà¸™ ISSUES
2. à¹€à¸à¸´à¹ˆà¸¡à¸¡à¸¸à¸¡à¸¡à¸­à¸‡à¸—à¸µà¹ˆà¸‚à¸²à¸”à¸«à¸²à¸¢à¹„à¸›
3. à¸£à¸±à¸à¸©à¸²à¸ˆà¸¸à¸”à¹à¸‚à¹‡à¸‡à¸‚à¸­à¸‡à¸„à¸³à¸•à¸­à¸šà¹€à¸”à¸´à¸¡

à¸•à¸­à¸šà¹ƒà¸™à¸£à¸¹à¸›à¹à¸šà¸š:
WHAT_I_FIXED:
- [à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¹à¸à¹‰à¹„à¸‚ 1]
- [à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¹à¸à¹‰à¹„à¸‚ 2]

REVISED_ANSWER:
[à¸„à¸³à¸•à¸­à¸šà¹ƒà¸«à¸¡à¹ˆà¸—à¸µà¹ˆà¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¹à¸¥à¹‰à¸§]

CONFIDENCE: LOW / MEDIUM / HIGH
REASON: [à¹€à¸«à¸•à¸¸à¸œà¸¥ 1 à¸›à¸£à¸°à¹‚à¸¢à¸„]""",
        "commit_message": "v1: Structured revision based on critique",
    },
}

# â”€â”€ à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸—à¸¸à¸ Prompt â”€â”€
for prompt_name, prompt_info in CRITIQUE_PROMPTS.items():
    registered = mlflow.genai.register_prompt(
        name=prompt_name,
        template=prompt_info["template"],
        commit_message=prompt_info["commit_message"],
    )
    track_version(prompt_name, registered.version)
    print(f"  âœ… à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™: '{prompt_name}' version {registered.version}")

# %%
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Self-Critique Runner
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def run_self_critique(task: str, n_rounds: int = 1) -> Dict:
    """
    à¸£à¸±à¸™ Self-Critique Loop: Generate â†’ Critique â†’ Revise

    Parameters:
        task     : à¸„à¸³à¸–à¸²à¸¡ / à¹‚à¸ˆà¸—à¸¢à¹Œà¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸„à¸³à¸•à¸­à¸š
        n_rounds : à¸ˆà¸³à¸™à¸§à¸™à¸£à¸­à¸šà¸—à¸µà¹ˆà¸§à¸´à¸à¸²à¸à¸©à¹Œà¹à¸¥à¸°à¹à¸à¹‰à¹„à¸‚ (à¸¡à¸²à¸à¸‚à¸¶à¹‰à¸™ = à¸”à¸µà¸‚à¸¶à¹‰à¸™ à¹à¸•à¹ˆà¸Šà¹‰à¸²à¸¥à¸‡)

    Returns:
        dict: {
            "initial_answer" : à¸„à¸³à¸•à¸­à¸šà¹à¸£à¸à¸à¹ˆà¸­à¸™ critique
            "final_answer"   : à¸„à¸³à¸•à¸­à¸šà¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢à¸«à¸¥à¸±à¸‡ revise à¸—à¸¸à¸à¸£à¸­à¸š
            "rounds"         : à¸œà¸¥à¸‚à¸­à¸‡à¹à¸•à¹ˆà¸¥à¸°à¸£à¸­à¸š
        }
    """
    # à¹‚à¸«à¸¥à¸” prompts à¸¥à¹ˆà¸²à¸ªà¸¸à¸”
    generate_prompt = load_latest_prompt("crit_generate")
    critic_prompt   = load_latest_prompt("crit_critic")
    revise_prompt   = load_latest_prompt("crit_revise")

    print_title(f"Self-Critique ({n_rounds} à¸£à¸­à¸š)", 2)

    # â”€â”€ à¸‚à¸±à¹‰à¸™à¸—à¸µà¹ˆ 1: à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸³à¸•à¸­à¸šà¹à¸£à¸ â”€â”€
    print("    ğŸ“ à¸à¸³à¸¥à¸±à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸³à¸•à¸­à¸šà¹€à¸šà¸·à¹‰à¸­à¸‡à¸•à¹‰à¸™...")
    initial_answer = call_gemini(
        generate_prompt.format(task=task),
        temperature=0.2,
    )
    print_box("à¸‚à¸±à¹‰à¸™à¸—à¸µà¹ˆ 1: à¸„à¸³à¸•à¸­à¸šà¹€à¸šà¸·à¹‰à¸­à¸‡à¸•à¹‰à¸™ (Draft)", initial_answer, "ğŸ“")
    time.sleep(1.0)

    current_answer = initial_answer
    all_rounds_data = []

    # â”€â”€ à¸£à¸±à¸™ N à¸£à¸­à¸š Critique + Revise â”€â”€
    for round_num in range(1, n_rounds + 1):
        print_title(f"à¸£à¸­à¸šà¸—à¸µà¹ˆ {round_num}/{n_rounds}", 2)

        # Critique: à¸§à¸´à¸à¸²à¸à¸©à¹Œà¸„à¸³à¸•à¸­à¸š
        print("    âš”ï¸  à¸à¸³à¸¥à¸±à¸‡à¸§à¸´à¸à¸²à¸à¸©à¹Œà¸„à¸³à¸•à¸­à¸š...")
        critique = call_gemini(
            critic_prompt.format(task=task, answer=current_answer),
            temperature=0.1,  # temperature à¸•à¹ˆà¸³ = à¸§à¸´à¸à¸²à¸à¸©à¹Œà¸­à¸¢à¹ˆà¸²à¸‡à¸ªà¸¡à¹ˆà¸³à¹€à¸ªà¸¡à¸­
        )
        print_box(f"à¸‚à¸±à¹‰à¸™à¸—à¸µà¹ˆ 2: à¸œà¸¥à¸§à¸´à¸à¸²à¸à¸©à¹Œ (à¸£à¸­à¸š {round_num})", critique, "âš”ï¸")
        time.sleep(1.0)

        # Revise: à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸„à¸³à¸•à¸­à¸š
        print("    âœï¸  à¸à¸³à¸¥à¸±à¸‡à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸„à¸³à¸•à¸­à¸š...")
        revised = call_gemini(
            revise_prompt.format(task=task, answer=current_answer, critique=critique),
            temperature=0.2,
        )
        print_box(f"à¸‚à¸±à¹‰à¸™à¸—à¸µà¹ˆ 3: à¸„à¸³à¸•à¸­à¸šà¸—à¸µà¹ˆà¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¹à¸¥à¹‰à¸§ (à¸£à¸­à¸š {round_num})", revised, "âœ¨")
        time.sleep(1.0)

        # à¸šà¸±à¸™à¸—à¸¶à¸à¸œà¸¥à¸£à¸­à¸šà¸™à¸µà¹‰
        verdict = next(
            (v for v in ["STRONG", "ACCEPTABLE", "WEAK"] if v in critique),
            "UNKNOWN",
        )
        all_rounds_data.append({
            "round"  : round_num,
            "critique": critique,
            "revised" : revised,
            "verdict" : verdict,
        })
        current_answer = revised  # à¹ƒà¸Šà¹‰à¸„à¸³à¸•à¸­à¸šà¹ƒà¸«à¸¡à¹ˆà¹ƒà¸™à¸£à¸­à¸šà¸–à¸±à¸”à¹„à¸›

    # à¸ªà¸£à¸¸à¸›à¸œà¸¥
    print_title("à¸ªà¸£à¸¸à¸› Self-Critique", 2)
    for rd in all_rounds_data:
        verdict_emoji = {"STRONG": "ğŸ’ª", "ACCEPTABLE": "ğŸ‘", "WEAK": "âš ï¸"}.get(rd["verdict"], "â“")
        print_metric(f"à¸£à¸­à¸š {rd['round']} Verdict", rd["verdict"], "", verdict_emoji)

    return {
        "initial_answer": initial_answer,
        "final_answer"  : current_answer,
        "rounds"        : all_rounds_data,
        "task"          : task,
    }


# %%
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  à¸—à¸”à¸ªà¸­à¸š Self-Critique à¸”à¹‰à¸§à¸¢à¸«à¸±à¸§à¸‚à¹‰à¸­à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸´à¸ˆà¸²à¸£à¸“à¸²à¸«à¸¥à¸²à¸¢à¸¡à¸¸à¸¡
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

COMPLEX_TASK = """
à¸šà¸£à¸´à¸©à¸±à¸— Startup à¸”à¹‰à¸²à¸™ FinTech (45 à¸„à¸™, à¸à¸£à¸°à¸ˆà¸²à¸¢ 3 à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”) à¸„à¸§à¸£à¹ƒà¸Šà¹‰à¸™à¹‚à¸¢à¸šà¸²à¸¢
Remote Work 100% à¸«à¸£à¸·à¸­ à¸¡à¸²à¸­à¸­à¸Ÿà¸Ÿà¸´à¸¨à¸—à¸¸à¸à¸§à¸±à¸™?

à¹‚à¸›à¸£à¸”à¸à¸´à¸ˆà¸²à¸£à¸“à¸²à¸ˆà¸²à¸ 3 à¸¡à¸¸à¸¡à¸¡à¸­à¸‡: à¸™à¸²à¸¢à¸ˆà¹‰à¸²à¸‡, à¸¥à¸¹à¸à¸ˆà¹‰à¸²à¸‡, à¹à¸¥à¸°à¸¥à¸¹à¸à¸„à¹‰à¸²
"""

print_box("à¹‚à¸ˆà¸—à¸¢à¹Œà¸—à¸”à¸ªà¸­à¸š Self-Critique", COMPLEX_TASK, "â“")

critique_result = run_self_critique(COMPLEX_TASK, n_rounds=2)

# %% [markdown]
# ---
# ## ğŸ” Reflection Loop: à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡ Prompt à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´
#
# ### à¸«à¸¥à¸±à¸à¸à¸²à¸£
#
# **Reflection** à¸„à¸·à¸­à¸à¸²à¸£à¹ƒà¸«à¹‰ AI à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸§à¹ˆà¸²à¸—à¸³à¹„à¸¡ Prompt à¸–à¸¶à¸‡à¹ƒà¸«à¹‰à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¹„à¸¡à¹ˆà¸”à¸µ
# à¹à¸¥à¹‰à¸§à¸ªà¸£à¹‰à¸²à¸‡ Prompt à¹ƒà¸«à¸¡à¹ˆà¸—à¸µà¹ˆà¹à¸à¹‰à¸›à¸±à¸à¸«à¸²à¸™à¸±à¹‰à¸™ â†’ à¸§à¸™à¸‹à¹‰à¸³à¸ˆà¸™à¹„à¸”à¹‰ accuracy à¸•à¸²à¸¡à¹€à¸›à¹‰à¸²
#
# ### à¹à¸œà¸™à¸œà¸±à¸‡
#
# ```
#  Prompt vN â”€â”€â†’ [à¸—à¸”à¸ªà¸­à¸šà¸à¸±à¸š Dataset] â”€â”€â†’ Accuracy â‰¥ Target?
#                                              â”‚
#                                        YES   â”‚   NO
#                                         â†“    â”‚    â†“
#                                        DONE  â”‚  [Reflect]
#                                              â”‚    â†“
#                                              â”‚  à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸‚à¹‰à¸­à¸—à¸µà¹ˆà¸œà¸´à¸”
#                                              â”‚    â†“
#                                              â”‚  à¸ªà¸£à¹‰à¸²à¸‡ Prompt vN+1
#                                              â”‚    â†“
#                                              â””â”€â”€â†’ Loop
# ```
#
# ### Dataset à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¸—à¸”à¸ªà¸­à¸š
#
# | à¸£à¸°à¸”à¸±à¸š | à¸ˆà¸³à¸™à¸§à¸™ | à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡ |
# |-------|-------|---------|
# | easy  | 2 à¸‚à¹‰à¸­ | à¸«à¸²à¸£, à¸„à¸¹à¸“ à¸˜à¸£à¸£à¸¡à¸”à¸² |
# | medium| 2 à¸‚à¹‰à¸­ | à¸«à¸¥à¸²à¸¢à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™, à¸ªà¹ˆà¸§à¸™à¸¥à¸” |
# | hard  | 2 à¸‚à¹‰à¸­ | à¸—à¸³à¸‡à¸²à¸™à¸£à¹ˆà¸§à¸¡, à¸—à¸µà¹ˆà¸™à¸±à¹ˆà¸‡ |

# %%
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Test Dataset: 6 à¹‚à¸ˆà¸—à¸¢à¹Œ 3 à¸£à¸°à¸”à¸±à¸š
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

print_title("Reflection Loop: à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡ Prompt à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´")

TEST_DATASET = [
    # â”€â”€ à¸£à¸°à¸”à¸±à¸š Easy â”€â”€
    {
        "problem"   : "à¸¡à¸µà¸ªà¹‰à¸¡ 24 à¸¥à¸¹à¸ à¹à¸šà¹ˆà¸‡à¹ƒà¸«à¹‰à¹€à¸”à¹‡à¸ 6 à¸„à¸™à¹€à¸—à¹ˆà¸²à¹† à¸à¸±à¸™ à¹à¸•à¹ˆà¸¥à¸°à¸„à¸™à¹„à¸”à¹‰à¸à¸µà¹ˆà¸¥à¸¹à¸?",
        "expected"  : "4",
        "difficulty": "easy",
    },
    {
        "problem"   : "à¸£à¸–à¸¢à¸™à¸•à¹Œà¸§à¸´à¹ˆà¸‡à¸”à¹‰à¸§à¸¢à¸„à¸§à¸²à¸¡à¹€à¸£à¹‡à¸§ 80 à¸à¸¡./à¸Šà¸¡. à¸™à¸²à¸™ 3 à¸Šà¸±à¹ˆà¸§à¹‚à¸¡à¸‡ à¸§à¸´à¹ˆà¸‡à¹„à¸”à¹‰à¸à¸µà¹ˆà¸à¸´à¹‚à¸¥à¹€à¸¡à¸•à¸£?",
        "expected"  : "240",
        "difficulty": "easy",
    },

    # â”€â”€ à¸£à¸°à¸”à¸±à¸š Medium â”€â”€
    {
        "problem"   : "à¹€à¸ªà¸·à¹‰à¸­ à¸£à¸²à¸„à¸² 350 à¸šà¸²à¸— à¸‹à¸·à¹‰à¸­ 3 à¸•à¸±à¸§ à¹à¸¥à¸°à¸à¸²à¸‡à¹€à¸à¸‡ à¸£à¸²à¸„à¸² 450 à¸šà¸²à¸— à¸‹à¸·à¹‰à¸­ 2 à¸•à¸±à¸§ "
                      "à¸–à¹‰à¸²à¸‹à¸·à¹‰à¸­à¹€à¸à¸´à¸™ 1,500 à¸šà¸²à¸— à¹„à¸”à¹‰à¸ªà¹ˆà¸§à¸™à¸¥à¸” 15% à¸ˆà¹ˆà¸²à¸¢à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹€à¸—à¹ˆà¸²à¹„à¸«à¸£à¹ˆ?",
        "expected"  : "1785",
        "difficulty": "medium",
    },
    {
        "problem"   : "à¸£à¸– 5 à¸„à¸±à¸™ à¸§à¸´à¹ˆà¸‡à¸£à¸§à¸¡à¸à¸±à¸™ 450 à¸à¸¡./à¸§à¸±à¸™ à¸­à¸±à¸•à¸£à¸²à¸ªà¸´à¹‰à¸™à¹€à¸›à¸¥à¸·à¸­à¸‡ 12 à¸à¸¡./à¸¥à¸´à¸•à¸£ "
                      "à¸™à¹‰à¸³à¸¡à¸±à¸™à¸£à¸²à¸„à¸² 42 à¸šà¸²à¸—/à¸¥à¸´à¸•à¸£ à¸„à¹ˆà¸²à¸™à¹‰à¸³à¸¡à¸±à¸™à¸£à¸§à¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸•à¹ˆà¸­à¸§à¸±à¸™à¹€à¸—à¹ˆà¸²à¹„à¸«à¸£à¹ˆ?",
        "expected"  : "1575",
        "difficulty": "medium",
    },

    # â”€â”€ à¸£à¸°à¸”à¸±à¸š Hard â”€â”€
    {
        "problem"   : "à¸—à¸µà¸¡ A à¸—à¸³à¸‡à¸²à¸™à¹„à¸”à¹‰ 1/30 à¸‚à¸­à¸‡à¸‡à¸²à¸™à¸•à¹ˆà¸­à¸§à¸±à¸™ à¸—à¸µà¸¡ B à¸—à¸³à¹„à¸”à¹‰ 1/45 à¸‚à¸­à¸‡à¸‡à¸²à¸™à¸•à¹ˆà¸­à¸§à¸±à¸™ "
                      "à¸–à¹‰à¸²à¸—à¸³à¸‡à¸²à¸™à¸à¸£à¹‰à¸­à¸¡à¸à¸±à¸™ à¹ƒà¸Šà¹‰à¸à¸µà¹ˆà¸§à¸±à¸™à¸–à¸¶à¸‡à¹€à¸ªà¸£à¹‡à¸ˆ? (à¸›à¸±à¸”à¸‚à¸¶à¹‰à¸™à¹€à¸›à¹‡à¸™à¸ˆà¸³à¸™à¸§à¸™à¹€à¸•à¹‡à¸¡)",
        "expected"  : "18",
        "difficulty": "hard",
    },
    {
        "problem"   : "à¸£à¹‰à¸²à¸™à¸­à¸²à¸«à¸²à¸£à¸¡à¸µ: à¹‚à¸•à¹Šà¸°à¹€à¸”à¸µà¹ˆà¸¢à¸§ 8 à¹‚à¸•à¹Šà¸° (2 à¸„à¸™/à¹‚à¸•à¹Šà¸°), à¹‚à¸•à¹Šà¸°à¸„à¸¹à¹ˆ 5 à¹‚à¸•à¹Šà¸° (4 à¸„à¸™/à¹‚à¸•à¹Šà¸°), "
                      "à¹‚à¸•à¹Šà¸°à¹ƒà¸«à¸à¹ˆ 3 à¹‚à¸•à¹Šà¸° (8 à¸„à¸™/à¹‚à¸•à¹Šà¸°). à¸•à¸­à¸™à¸™à¸µà¹‰à¸¡à¸µà¸¥à¸¹à¸à¸„à¹‰à¸² 35 à¸„à¸™ à¹à¸¥à¸°à¸ˆà¸°à¸¡à¸²à¹€à¸à¸´à¹ˆà¸¡à¸­à¸µà¸ "
                      "2 à¸à¸¥à¸¸à¹ˆà¸¡ à¸à¸¥à¸¸à¹ˆà¸¡à¸¥à¸° 7 à¸„à¸™ à¹€à¸«à¸¥à¸·à¸­à¸—à¸µà¹ˆà¸™à¸±à¹ˆà¸‡à¸§à¹ˆà¸²à¸‡à¸à¸µà¹ˆà¸—à¸µà¹ˆ?",
        "expected"  : "5",
        "difficulty": "hard",
    },
]

# à¹à¸ªà¸”à¸‡ Dataset à¹ƒà¸™à¸•à¸²à¸£à¸²à¸‡
print_table(
    headers = ["#", "Difficulty", "Expected", "à¹‚à¸ˆà¸—à¸¢à¹Œ (à¸¢à¹ˆà¸­)"],
    rows    = [
        [
            str(i + 1),
            item["difficulty"],
            item["expected"],
            item["problem"][:45] + "...",
        ]
        for i, item in enumerate(TEST_DATASET)
    ],
    title = "Test Dataset (6 à¹‚à¸ˆà¸—à¸¢à¹Œ)",
)

# %%
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Evaluate Function: à¸—à¸”à¸ªà¸­à¸š Prompt à¸à¸±à¸š Dataset
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def evaluate_prompt(template: str,
                    dataset: List[Dict],
                    n_samples: int = 3,
                    label: str = "Prompt") -> Dict:
    """
    à¸—à¸”à¸ªà¸­à¸š SC Prompt à¸à¸±à¸š dataset à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” à¹à¸¥à¸°à¸„à¸·à¸™à¸„à¹ˆà¸² accuracy

    Parameters:
        template  : Prompt template à¸—à¸µà¹ˆà¸ˆà¸°à¸—à¸”à¸ªà¸­à¸š
        dataset   : list à¸‚à¸­à¸‡ {problem, expected, difficulty}
        n_samples : à¸ˆà¸³à¸™à¸§à¸™ SC paths à¸•à¹ˆà¸­à¹‚à¸ˆà¸—à¸¢à¹Œ
        label     : à¸Šà¸·à¹ˆà¸­à¸ªà¸³à¸«à¸£à¸±à¸šà¹à¸ªà¸”à¸‡à¸œà¸¥

    Returns:
        dict: {
            "accuracy"  : overall accuracy (%)
            "results"   : à¸œà¸¥à¹à¸•à¹ˆà¸¥à¸°à¸‚à¹‰à¸­
            "breakdown" : accuracy à¹à¸¢à¸à¸•à¸²à¸¡ difficulty
        }
    """
    correct_count = 0
    all_results   = []

    print_title(f"à¸›à¸£à¸°à¹€à¸¡à¸´à¸™: {label}", 2)

    for idx, item in enumerate(dataset, start=1):
        # à¸£à¸±à¸™ SC (verbose=False à¹€à¸à¸·à¹ˆà¸­à¹à¸ªà¸”à¸‡à¸œà¸¥à¸ªà¸±à¹‰à¸™)
        sc_result = run_self_consistency(
            template    = template,
            problem     = item["problem"],
            n_samples   = n_samples,
            temperature = 0.7,
            show_details = False,
        )

        # à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸„à¸³à¸•à¸­à¸š
        predicted = sc_result["final_answer"].replace(",", "").strip()
        expected  = item["expected"].strip()
        is_correct = (predicted == expected)

        if is_correct:
            correct_count += 1

        all_results.append({
            "idx"        : idx,
            "problem"    : item["problem"][:45],
            "expected"   : expected,
            "predicted"  : predicted,
            "confidence" : sc_result["confidence"],
            "difficulty" : item["difficulty"],
            "correct"    : is_correct,
        })

        # à¹à¸ªà¸”à¸‡à¸œà¸¥à¹à¸•à¹ˆà¸¥à¸°à¸‚à¹‰à¸­
        status = "âœ…" if is_correct else "âŒ"
        print(
            f"      {status} Q{idx} [{item['difficulty']:6s}]  "
            f"Expected={expected:>6s}  Got={predicted:>6s}  "
            f"Confidence={sc_result['confidence']:.0%}"
        )

    # â”€â”€ à¸„à¸³à¸™à¸§à¸“ Accuracy à¸£à¸§à¸¡ â”€â”€
    overall_accuracy = (correct_count / len(dataset)) * 100

    # â”€â”€ à¸„à¸³à¸™à¸§à¸“ Accuracy à¹à¸¢à¸à¸•à¸²à¸¡ Difficulty â”€â”€
    breakdown = {}
    for difficulty in ["easy", "medium", "hard"]:
        diff_results = [r for r in all_results if r["difficulty"] == difficulty]
        diff_correct = sum(1 for r in diff_results if r["correct"])
        diff_total   = len(diff_results)
        diff_acc     = (diff_correct / diff_total * 100) if diff_total > 0 else 0
        breakdown[difficulty] = {
            "correct" : diff_correct,
            "total"   : diff_total,
            "accuracy": diff_acc,
        }

    # â”€â”€ à¹à¸ªà¸”à¸‡à¸œà¸¥à¸ªà¸£à¸¸à¸› â”€â”€
    print_table(
        headers = ["#", "Difficulty", "Expected", "Got", "Confidence", "Result"],
        rows    = [
            [
                str(r["idx"]),
                r["difficulty"],
                r["expected"],
                r["predicted"],
                f"{r['confidence']:.0%}",
                "âœ…" if r["correct"] else "âŒ",
            ]
            for r in all_results
        ],
        title = f"à¸œà¸¥à¸à¸²à¸£à¸›à¸£à¸°à¹€à¸¡à¸´à¸™ â€” {label}",
    )

    # Summary box
    difficulty_emoji = {"easy": "ğŸŸ¢", "medium": "ğŸŸ¡", "hard": "ğŸ”´"}
    summary_lines = [f"Overall Accuracy: {overall_accuracy:.1f}%  ({correct_count}/{len(dataset)})\n"]
    for diff, info in breakdown.items():
        filled = int(info["accuracy"] / 10)
        bar    = "â–ˆ" * filled + "â–‘" * (10 - filled)
        summary_lines.append(
            f"{difficulty_emoji[diff]} {diff.capitalize():8s}:  {bar}  "
            f"{info['accuracy']:.0f}%  ({info['correct']}/{info['total']})"
        )

    print_box(
        title   = f"à¸ªà¸£à¸¸à¸› Accuracy â€” {label}",
        content = "\n".join(summary_lines),
        emoji   = "ğŸ¯",
    )

    return {
        "accuracy" : overall_accuracy,
        "results"  : all_results,
        "breakdown": breakdown,
    }


# %%
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Reflect Function: à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸” â†’ à¸ªà¸£à¹‰à¸²à¸‡ Prompt à¹ƒà¸«à¸¡à¹ˆ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def reflect_and_improve_prompt(current_template: str,
                               eval_result: Dict) -> str:
    """
    à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸§à¹ˆà¸² Prompt à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¸•à¸£à¸‡à¹„à¸«à¸™ à¹à¸¥à¸°à¸ªà¸£à¹‰à¸²à¸‡ Prompt à¸—à¸µà¹ˆà¸”à¸µà¸‚à¸¶à¹‰à¸™

    Parameters:
        current_template : Prompt à¹€à¸§à¸­à¸£à¹Œà¸Šà¸±à¸™à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™
        eval_result      : à¸œà¸¥à¸à¸²à¸£ evaluate (à¸ˆà¸²à¸ evaluate_prompt)

    Returns:
        str: Prompt template à¹ƒà¸«à¸¡à¹ˆà¸—à¸µà¹ˆà¸„à¸§à¸£à¸”à¸µà¸‚à¸¶à¹‰à¸™
             (à¸–à¹‰à¸²à¸ªà¸à¸±à¸”à¹„à¸¡à¹ˆà¹„à¸”à¹‰ à¸ˆà¸°à¸„à¸·à¸™ template à¹€à¸”à¸´à¸¡)
    """
    wrong_items = [r for r in eval_result["results"] if not r["correct"]]

    if not wrong_items:
        print("  ğŸ‰ Accuracy 100% â€” à¹„à¸¡à¹ˆà¸ˆà¸³à¹€à¸›à¹‡à¸™à¸•à¹‰à¸­à¸‡à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡!")
        return current_template

    # à¸ªà¸£à¹‰à¸²à¸‡ Reflection Prompt
    wrong_summary = json.dumps(wrong_items[:4], ensure_ascii=False, indent=2)

    reflection_prompt = f"""à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™ Prompt Engineer à¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸”à¹‰à¸²à¸™ Math Reasoning

## Prompt à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™:
```
{current_template}
```

## à¸œà¸¥à¸à¸²à¸£à¸—à¸”à¸ªà¸­à¸š:
- Overall Accuracy: {eval_result['accuracy']:.1f}%
- à¸‚à¹‰à¸­à¸—à¸µà¹ˆà¸œà¸´à¸” {len(wrong_items)} à¸‚à¹‰à¸­

## à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸‚à¹‰à¸­à¸—à¸µà¹ˆà¸œà¸´à¸”:
{wrong_summary}

## à¸‡à¸²à¸™à¸‚à¸­à¸‡à¸„à¸¸à¸“:
1. à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ pattern à¸§à¹ˆà¸²à¸—à¸³à¹„à¸¡ Prompt à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¸–à¸¶à¸‡à¹ƒà¸«à¹‰à¸„à¸³à¸•à¸­à¸šà¸œà¸´à¸”
2. à¸£à¸°à¸šà¸¸à¸ˆà¸¸à¸”à¸­à¹ˆà¸­à¸™ 2-3 à¸ˆà¸¸à¸”à¸‚à¸­à¸‡ Prompt à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™
3. à¸ªà¸£à¹‰à¸²à¸‡ Prompt à¹ƒà¸«à¸¡à¹ˆà¸—à¸µà¹ˆà¹à¸à¹‰à¹„à¸‚à¸ˆà¸¸à¸”à¸­à¹ˆà¸­à¸™à¹€à¸«à¸¥à¹ˆà¸²à¸™à¸±à¹‰à¸™

## à¸à¸à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸£à¸±à¸à¸©à¸²:
- à¸•à¹‰à¸­à¸‡à¸¡à¸µ {{{{ problem }}}} à¹ƒà¸™ prompt (à¸ªà¸³à¸«à¸£à¸±à¸šà¹à¸—à¸™ placeholder)
- à¹ƒà¸«à¹‰ AI à¹à¸ªà¸”à¸‡ reasoning à¸à¹ˆà¸­à¸™à¸ªà¸£à¸¸à¸›à¸„à¸³à¸•à¸­à¸š
- à¸à¸³à¸«à¸™à¸” output format à¸Šà¸±à¸”à¹€à¸ˆà¸™
- à¸„à¸³à¸•à¸­à¸šà¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¹€à¸¥à¸‚

## à¸£à¸¹à¸›à¹à¸šà¸š output:
à¸‚à¸¶à¹‰à¸™à¸•à¹‰à¸™ Prompt à¹ƒà¸«à¸¡à¹ˆà¸”à¹‰à¸§à¸¢ [NEW_PROMPT_START]
à¸ˆà¸šà¸”à¹‰à¸§à¸¢ [NEW_PROMPT_END]"""

    print_title("à¸à¸³à¸¥à¸±à¸‡ Reflect...", 3)
    reflection_response = call_gemini(reflection_prompt, temperature=0.3, max_tokens=4096)

    print_box("à¸œà¸¥ Reflection Analysis", reflection_response, "ğŸ”")

    # à¸ªà¸à¸±à¸” Prompt à¹ƒà¸«à¸¡à¹ˆ
    if "[NEW_PROMPT_START]" in reflection_response and "[NEW_PROMPT_END]" in reflection_response:
        start_idx  = reflection_response.index("[NEW_PROMPT_START]") + len("[NEW_PROMPT_START]")
        end_idx    = reflection_response.index("[NEW_PROMPT_END]")
        new_prompt = reflection_response[start_idx:end_idx].strip()

        print_box(
            title   = f"Prompt à¹ƒà¸«à¸¡à¹ˆà¸—à¸µà¹ˆà¸ªà¸£à¹‰à¸²à¸‡à¸‚à¸¶à¹‰à¸™ ({len(new_prompt)} à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£)",
            content = new_prompt,
            emoji   = "ğŸ†•",
        )
        return new_prompt

    print("    âš ï¸  à¹„à¸¡à¹ˆà¸à¸š Prompt à¹ƒà¸«à¸¡à¹ˆà¹ƒà¸™ response â€” à¹ƒà¸Šà¹‰ template à¹€à¸”à¸´à¸¡")
    return current_template


# %%
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Optimization Loop: à¸§à¸™à¸—à¸”à¸ªà¸­à¸šà¹à¸¥à¸°à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸ˆà¸™à¸–à¸¶à¸‡ Target
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def run_optimization_loop(prompt_name: str,
                           initial_template: str,
                           dataset: List[Dict],
                           target_accuracy: float = 83.0,
                           max_iterations: int = 3,
                           n_samples: int = 3) -> Dict:
    """
    à¸§à¸™ Loop: Evaluate â†’ Reflect â†’ Improve â†’ Register â†’ Repeat

    Parameters:
        prompt_name      : à¸Šà¸·à¹ˆà¸­ Prompt à¹ƒà¸™ MLflow Registry
        initial_template : Prompt à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™
        dataset          : Dataset à¸ªà¸³à¸«à¸£à¸±à¸šà¸—à¸”à¸ªà¸­à¸š
        target_accuracy  : à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢ accuracy (%)
        max_iterations   : à¸£à¸­à¸šà¸ªà¸¹à¸‡à¸ªà¸¸à¸” (à¸›à¹‰à¸­à¸‡à¸à¸±à¸™ loop à¹„à¸¡à¹ˆà¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”)
        n_samples        : SC paths à¸•à¹ˆà¸­à¹‚à¸ˆà¸—à¸¢à¹Œ

    Returns:
        dict: à¸ªà¸£à¸¸à¸›à¸œà¸¥à¸—à¸¸à¸ iteration
    """
    optimization_history = []
    current_template     = initial_template

    print_title(f"Optimization Loop â€” à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢ {target_accuracy}%", 2)
    print_divider("â•")

    for iteration in range(1, max_iterations + 1):
        print(f"\n  ğŸ”„ Iteration {iteration}/{max_iterations}")
        print_divider()

        # â”€â”€ à¸—à¸”à¸ªà¸­à¸š Prompt à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™ â”€â”€
        eval_result = evaluate_prompt(
            template  = current_template,
            dataset   = dataset,
            n_samples = n_samples,
            label     = f"Iteration {iteration}",
        )

        # à¸šà¸±à¸™à¸—à¸¶à¸à¸›à¸£à¸°à¸§à¸±à¸•à¸´
        optimization_history.append({
            "iteration": iteration,
            "accuracy" : eval_result["accuracy"],
            "breakdown": eval_result["breakdown"],
        })

        # â”€â”€ à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸–à¸¶à¸‡ Target à¹à¸¥à¹‰à¸§à¸«à¸£à¸·à¸­à¸¢à¸±à¸‡ â”€â”€
        if eval_result["accuracy"] >= target_accuracy:
            print(f"\n  ğŸ‰ à¸–à¸¶à¸‡à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢à¹à¸¥à¹‰à¸§! {eval_result['accuracy']:.1f}% â‰¥ {target_accuracy}%")
            break

        print(f"\n  ğŸ” à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸–à¸¶à¸‡à¹€à¸›à¹‰à¸² ({eval_result['accuracy']:.1f}% < {target_accuracy}%)")
        print(    "     à¸à¸³à¸¥à¸±à¸‡ Reflect à¹à¸¥à¸°à¸ªà¸£à¹‰à¸²à¸‡ Prompt à¹ƒà¸«à¸¡à¹ˆ...")

        # â”€â”€ Reflect à¹à¸¥à¸°à¸ªà¸£à¹‰à¸²à¸‡ Prompt à¹ƒà¸«à¸¡à¹ˆ â”€â”€
        new_template = reflect_and_improve_prompt(current_template, eval_result)

        if new_template != current_template:
            # à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ Prompt à¹ƒà¸«à¸¡à¹ˆà¹ƒà¸™ MLflow
            new_registered = mlflow.genai.register_prompt(
                name=prompt_name,
                template=new_template,
                commit_message=(
                    f"Reflection iter {iteration}: "
                    f"accuracy {eval_result['accuracy']:.1f}% â†’ improving"
                ),
            )
            track_version(prompt_name, new_registered.version)
            print(f"  ğŸ“¦ à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ version à¹ƒà¸«à¸¡à¹ˆ: v{new_registered.version}")
            current_template = new_template
        else:
            print("  âš ï¸  Prompt à¹„à¸¡à¹ˆà¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡ â€” à¸«à¸¢à¸¸à¸” Loop")
            break

        time.sleep(2.0)

    # â”€â”€ à¹à¸ªà¸”à¸‡ History â”€â”€
    print_title("à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£ Optimize", 2)
    print_table(
        headers = ["Iter", "Accuracy", "Easy", "Medium", "Hard"],
        rows    = [
            [
                str(h["iteration"]),
                f"{h['accuracy']:.1f}%",
                f"{h['breakdown']['easy']['accuracy']:.0f}%",
                f"{h['breakdown']['medium']['accuracy']:.0f}%",
                f"{h['breakdown']['hard']['accuracy']:.0f}%",
            ]
            for h in optimization_history
        ],
        title = "Accuracy à¹à¸•à¹ˆà¸¥à¸° Iteration",
    )

    # à¹à¸ªà¸”à¸‡à¸à¸²à¸£à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸£à¸§à¸¡
    if len(optimization_history) > 1:
        total_improvement = (
            optimization_history[-1]["accuracy"] - optimization_history[0]["accuracy"]
        )
        emoji = "ğŸ“ˆ" if total_improvement >= 0 else "ğŸ“‰"
        print_metric("à¸à¸²à¸£à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸£à¸§à¸¡", total_improvement, "%", emoji)

    return {
        "history"          : optimization_history,
        "final_template"   : current_template,
        "final_accuracy"   : optimization_history[-1]["accuracy"],
        "total_iterations" : len(optimization_history),
    }


# %%
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  à¸£à¸±à¸™ Optimization Loop à¸ˆà¸£à¸´à¸‡!
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

print_title("à¹€à¸£à¸´à¹ˆà¸¡ Optimization Loop!")

loop_result = run_optimization_loop(
    prompt_name      = SC_PROMPT_NAME,
    initial_template = SC_PROMPT_V1,
    dataset          = TEST_DATASET,
    target_accuracy  = 83.0,    # à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢: à¸•à¸­à¸šà¸–à¸¹à¸ 5/6 à¸‚à¹‰à¸­à¸‚à¸¶à¹‰à¸™à¹„à¸›
    max_iterations   = 3,       # à¸¥à¸­à¸‡à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸ªà¸¹à¸‡à¸ªà¸¸à¸” 3 à¸£à¸­à¸š
    n_samples        = 3,       # SC 3 paths à¸•à¹ˆà¸­à¹‚à¸ˆà¸—à¸¢à¹Œ (à¸›à¸£à¸°à¸«à¸¢à¸±à¸” cost)
)

# %% [markdown]
# ---
# ## ğŸ“Š à¸ªà¹ˆà¸§à¸™à¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢: à¸šà¸±à¸™à¸—à¸¶à¸à¸œà¸¥à¹ƒà¸™ MLflow à¹à¸¥à¸°à¸ªà¸£à¸¸à¸›à¸£à¸§à¸¡
#
# MLflow à¸Šà¹ˆà¸§à¸¢à¹ƒà¸«à¹‰à¹€à¸£à¸²à¸•à¸´à¸”à¸•à¸²à¸¡à¹à¸¥à¸°à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸œà¸¥à¸à¸²à¸£à¸—à¸”à¸¥à¸­à¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹„à¸”à¹‰
# à¸£à¸§à¸¡à¸–à¸¶à¸‡ Prompt versions, metrics, à¹à¸¥à¸° parameters à¸•à¹ˆà¸²à¸‡à¹†

# %%
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  à¸šà¸±à¸™à¸—à¸¶à¸à¸œà¸¥à¸—à¸¸à¸à¸­à¸¢à¹ˆà¸²à¸‡à¹ƒà¸™ MLflow
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

print_title("à¸šà¸±à¸™à¸—à¸¶à¸à¸œà¸¥à¹ƒà¸™ MLflow")

with mlflow.start_run(run_name="prompt_engineering_lab_final"):

    # â”€â”€ SC Optimization Metrics â”€â”€
    for hist in loop_result["history"]:
        mlflow.log_metric(
            key  = f"sc_accuracy_iter{hist['iteration']}",
            value= hist["accuracy"],
        )

    mlflow.log_metric("sc_final_accuracy",  loop_result["final_accuracy"])
    mlflow.log_metric("sc_total_iterations", loop_result["total_iterations"])

    # â”€â”€ Prompt Chaining Metrics â”€â”€
    mlflow.log_metric("chain_n_steps",       3)
    mlflow.log_metric("chain_report_length", len(chain_results.get("chain_report", "")))

    # â”€â”€ Self-Critique Metrics â”€â”€
    mlflow.log_metric("critique_n_rounds",    len(critique_result["rounds"]))
    mlflow.log_metric("critique_final_length", len(critique_result["final_answer"]))

    # â”€â”€ Parameters â”€â”€
    mlflow.log_param("model_id",     MODEL_ID)
    mlflow.log_param("techniques",   "Self-Consistency, Prompt-Chaining, Self-Critique")
    mlflow.log_param("test_size",    len(TEST_DATASET))
    mlflow.log_param("sc_n_samples", 3)
    mlflow.log_param("target_acc",   83.0)

    print("  âœ… à¸šà¸±à¸™à¸—à¸¶à¸ Metrics à¸ªà¸³à¹€à¸£à¹‡à¸ˆ:")
    print(f"     - SC final accuracy: {loop_result['final_accuracy']:.1f}%")
    print(f"     - SC iterations    : {loop_result['total_iterations']}")
    print(f"     - Chain steps      : 3")
    print(f"     - Critique rounds  : {len(critique_result['rounds'])}")


# %%
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  ğŸ† Dashboard à¸ªà¸£à¸¸à¸›à¸œà¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

print_title("ğŸ† Lab Dashboard â€” à¸ªà¸£à¸¸à¸›à¸œà¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”")

# â”€â”€ à¸•à¸²à¸£à¸²à¸‡ Technique Results â”€â”€
sarcasm_detected = (
    "sarcasm" in chain_results.get("chain_extract", "").lower()
    or "à¸›à¸£à¸°à¸Šà¸”" in chain_results.get("chain_extract", "")
    or "yes" in chain_results.get("chain_extract", "").lower()
)

print_table(
    headers = ["à¹€à¸—à¸„à¸™à¸´à¸„", "à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸§à¸±à¸”", "à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ"],
    rows    = [
        [
            "Self-Consistency",
            "Final Accuracy",
            f"{loop_result['final_accuracy']:.1f}%",
        ],
        [
            "Prompt Chaining",
            "Sarcasm Detected",
            "âœ… à¹ƒà¸Šà¹ˆ" if sarcasm_detected else "â“ à¹„à¸¡à¹ˆà¹à¸™à¹ˆà¹ƒà¸ˆ",
        ],
        [
            "Self-Critique",
            "à¸ˆà¸³à¸™à¸§à¸™à¸£à¸­à¸š Revise",
            f"{len(critique_result['rounds'])} à¸£à¸­à¸š",
        ],
    ],
    title = "à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¹à¸•à¹ˆà¸¥à¸°à¹€à¸—à¸„à¸™à¸´à¸„",
)

# â”€â”€ SC Optimization Progress â”€â”€
print_title("SC Optimization Progress", 2)
for hist in loop_result["history"]:
    print_progress(
        current = int(hist["accuracy"]),
        total   = 100,
        label   = f"Iter {hist['iteration']}: {hist['accuracy']:.1f}%",
    )

# â”€â”€ MLflow Registry Summary â”€â”€
print_title("MLflow Prompt Registry", 2)

all_prompt_names = [
    SC_PROMPT_NAME,
    "chain_extract",
    "chain_analyze",
    "chain_report",
    "crit_generate",
    "crit_critic",
    "crit_revise",
]

print_table(
    headers = ["Prompt Name", "Latest Version", "à¹€à¸—à¸„à¸™à¸´à¸„"],
    rows    = [
        [
            name,
            f"v{get_latest_version(name)}",
            "Self-Consistency" if "sc_" in name
            else "Prompt Chaining" if "chain_" in name
            else "Self-Critique",
        ]
        for name in all_prompt_names
    ],
    title = "Prompt Registry Summary",
)

# â”€â”€ Links â”€â”€
print_divider("â•")
print(f"\n  ğŸŒ à¸”à¸¹à¸œà¸¥à¹ƒà¸™ MLflow UI : {MLFLOW_URI}")
print(f"  ğŸ“Š Experiment       : prompt_engineering_lab")
print(f"  ğŸ“¦ Prompts          : {len(all_prompt_names)} prompts registered")
print_divider("â•")

# %% [markdown]
# ---
# ## ğŸ“ à¸ªà¸£à¸¸à¸›à¸šà¸—à¹€à¸£à¸µà¸¢à¸™ (Key Takeaways)
#
# ### 3 à¹€à¸—à¸„à¸™à¸´à¸„ Prompt Engineering
#
# | à¹€à¸¡à¸·à¹ˆà¸­à¹„à¸«à¸£à¹ˆà¸„à¸§à¸£à¹ƒà¸Šà¹‰? | à¹€à¸—à¸„à¸™à¸´à¸„ | à¹€à¸«à¸•à¸¸à¸œà¸¥ |
# |----------------|--------|--------|
# | à¸‡à¸²à¸™ Math / Logic / à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸„à¸§à¸²à¸¡à¹à¸¡à¹ˆà¸™à¸¢à¸³ | **Self-Consistency** | Majority vote à¸¥à¸”à¹‚à¸­à¸à¸²à¸ªà¸œà¸´à¸” |
# | à¸‡à¸²à¸™à¸‹à¸±à¸šà¸‹à¹‰à¸­à¸™à¸«à¸¥à¸²à¸¢à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™ (à¹€à¸Šà¹ˆà¸™ à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ document) | **Prompt Chaining** | à¹à¸¢à¸ focus, debug à¸‡à¹ˆà¸²à¸¢ |
# | à¸«à¸±à¸§à¸‚à¹‰à¸­ controversial / à¸•à¹‰à¸­à¸‡à¸à¸²à¸£ unbiased answer | **Self-Critique** | à¸§à¸´à¸à¸²à¸à¸©à¹Œà¸•à¸±à¸§à¹€à¸­à¸‡ â†’ à¸£à¸­à¸šà¸”à¹‰à¸²à¸™à¸‚à¸¶à¹‰à¸™ |
# | Prompt à¸¢à¸±à¸‡à¹ƒà¸«à¹‰à¸œà¸¥à¹„à¸¡à¹ˆà¸”à¸µà¸à¸­ | **Reflection Loop** | à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸‚à¹‰à¸­à¸œà¸´à¸” â†’ auto-improve |
#
# ### MLflow Best Practices
#
# | âœ… à¸„à¸§à¸£à¸—à¸³ | âŒ à¹„à¸¡à¹ˆà¸„à¸§à¸£à¸—à¸³ |
# |---------|-----------|
# | à¹ƒà¸ªà¹ˆ `commit_message` à¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡à¸—à¸µà¹ˆ register | Register à¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¸¡à¸µ message |
# | à¸•à¸´à¸”à¸•à¸²à¸¡ version à¸”à¹‰à¸§à¸¢ `track_version()` | à¹ƒà¸Šà¹‰ version hardcode |
# | `log_metric` à¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡à¸—à¸µà¹ˆ evaluate | à¸§à¸±à¸”à¸œà¸¥à¹à¸„à¹ˆà¹ƒà¸™à¸«à¸±à¸§ |
# | à¸•à¸±à¹‰à¸‡à¸Šà¸·à¹ˆà¸­ prompt à¹ƒà¸«à¹‰à¸ªà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸«à¸¡à¸²à¸¢ | à¸•à¸±à¹‰à¸‡à¸Šà¸·à¹ˆà¸­ prompt1, prompt2 |
#
# ### à¹à¸™à¸§à¸„à¸´à¸”à¸—à¸µà¹ˆà¸ªà¸³à¸„à¸±à¸à¸—à¸µà¹ˆà¸ªà¸¸à¸”
#
# > **"Prompt Engineering à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸¨à¸´à¸¥à¸›à¸° à¹à¸•à¹ˆà¹€à¸›à¹‡à¸™à¸§à¸´à¸—à¸¢à¸²à¸¨à¸²à¸ªà¸•à¸£à¹Œ"**
# >
# > à¸§à¸±à¸”à¸œà¸¥ â†’ à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ â†’ à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡ â†’ à¸§à¸±à¸”à¸œà¸¥à¸‹à¹‰à¸³
# > à¹€à¸«à¸¡à¸·à¸­à¸™à¸à¸²à¸£à¸à¸±à¸’à¸™à¸² Software à¸—à¸µà¹ˆà¸”à¸µ à¸•à¹‰à¸­à¸‡à¸¡à¸µ test à¹à¸¥à¸° iteration
#
# ---
# **ğŸ‰ à¸¢à¸´à¸™à¸”à¸µà¸”à¹‰à¸§à¸¢! à¸„à¸¸à¸“à¹€à¸£à¸µà¸¢à¸™à¸ˆà¸š Lab à¸™à¸µà¹‰à¹à¸¥à¹‰à¸§**
#
# à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸„à¸¸à¸“à¸—à¸³à¹„à¸”à¹‰à¹à¸¥à¹‰à¸§:
# - âœ… à¹€à¸‚à¸µà¸¢à¸™à¹à¸¥à¸°à¸—à¸”à¸ªà¸­à¸š 3 à¹€à¸—à¸„à¸™à¸´à¸„ Prompt Engineering
# - âœ… à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¹à¸¥à¸°à¸ˆà¸±à¸”à¸à¸²à¸£ Prompt versions à¹ƒà¸™ MLflow
# - âœ… à¸ªà¸£à¹‰à¸²à¸‡ Reflection Loop à¹€à¸à¸·à¹ˆà¸­à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡ Prompt à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´
# - âœ… à¸•à¸´à¸”à¸•à¸²à¸¡à¹à¸¥à¸°à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸œà¸¥à¸”à¹‰à¸§à¸¢ MLflow Tracking
```