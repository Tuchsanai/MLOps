# %% [markdown]
# # ü•ä Pose Time Series Analysis Lab: ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡πà‡∏≤‡∏°‡∏ß‡∏¢‡πÑ‡∏ó‡∏¢‡∏î‡πâ‡∏ß‡∏¢ Time Series ‡πÅ‡∏•‡∏∞ Angle Analysis
#
# ---
#
# ## üìã Lab Overview
#
# **‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ (Learning Objectives):**
# 1. ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Pose Estimation ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Time Series
# 2. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏Ç‡∏≠‡∏á‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤
# 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Joint Angles ‡∏à‡∏≤‡∏Å Keypoint Coordinates
# 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á Visualization ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ (Actions)
# 5. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Pattern ‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏°‡∏ß‡∏¢‡πÑ‡∏ó‡∏¢‡∏ú‡πà‡∏≤‡∏ô Time Series ‡πÅ‡∏•‡∏∞ Angle Analysis
#
# **Prerequisites:**
# - Python 3.8+
# - ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Pandas DataFrame
# - ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Trigonometry (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°)
#
# **Estimated Time:** 2-3 hours
#
# ---

# %% [markdown]
# ## üìö Part 1: Environment Setup ‡πÅ‡∏•‡∏∞ Data Loading
#
# ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£ import libraries ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
# ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Pose Estimation ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV
#
# ### 1.1 Import Libraries
#
# **‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:** ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ libraries ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Time Series ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Visualization
#
# | Library | ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà |
# |---------|--------|
# | pandas | ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö DataFrame |
# | numpy | ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ä‡∏¥‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞ array operations |
# | matplotlib | ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞ visualization ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô |
# | seaborn | ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° |
# | scipy | Signal processing ‡πÅ‡∏•‡∏∞ smoothing |

# %%
# =====================================================
# STEP 1.1: Import Required Libraries
# =====================================================
# üìù Description: 
# ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ libraries ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
# - pandas: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• DataFrame
# - numpy: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ä‡∏¥‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
# - matplotlib & seaborn: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü
# - scipy: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö signal processing (smoothing)
#
# üí° Tip: ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ library ‡πÉ‡∏î‡πÜ ‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô: 
#     pip install pandas numpy matplotlib seaborn scipy
# =====================================================

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from scipy import signal
from scipy.ndimage import uniform_filter1d
import warnings

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Visualization ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
plt.rcParams['figure.figsize'] = (14, 8)      # ‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
plt.rcParams['font.size'] = 11                 # ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
plt.rcParams['axes.titlesize'] = 14            # ‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏£‡∏≤‡∏ü
plt.rcParams['axes.labelsize'] = 12            # ‡∏Ç‡∏ô‡∏≤‡∏î label ‡πÅ‡∏Å‡∏ô
sns.set_style("whitegrid")                     # ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ö‡∏ö‡∏°‡∏µ grid
warnings.filterwarnings('ignore')              # ‡∏õ‡∏¥‡∏î warnings

# ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ font)
try:
    plt.rcParams['font.family'] = 'DejaVu Sans'
except:
    pass

print("‚úÖ Libraries imported successfully!")
print(f"   üìä Pandas version: {pd.__version__}")
print(f"   üî¢ NumPy version: {np.__version__}")

# %% [markdown]
# ### 1.2 Load Pose Data
#
# **‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:** ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Pose Estimation ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV
#
# **‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Data Structure):**
#
# ```
# ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
# ‚îÇ                    POSE DATA STRUCTURE                      ‚îÇ
# ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
# ‚îÇ frame_idx      : ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏ü‡∏£‡∏° (‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡πÄ‡∏ß‡∏•‡∏≤)                    ‚îÇ
# ‚îÇ timestamp      : ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ                          ‚îÇ
# ‚îÇ person_id      : ‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°                      ‚îÇ
# ‚îÇ avg_confidence : ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á keypoints           ‚îÇ
# ‚îÇ keypoint_x     : ‡∏û‡∏¥‡∏Å‡∏±‡∏î X ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ keypoint                  ‚îÇ
# ‚îÇ keypoint_y     : ‡∏û‡∏¥‡∏Å‡∏±‡∏î Y ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ keypoint                  ‚îÇ
# ‚îÇ keypoint_conf  : ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ keypoint             ‚îÇ
# ‚îÇ action         : ‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á (Label)                    ‚îÇ
# ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
# ```
#
# **Keypoints ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 17 ‡∏à‡∏∏‡∏î:**
# ```
#        nose (0)
#     left_eye (1)  right_eye (2)
#     left_ear (3)  right_ear (4)
#         |
#   left_shoulder (5) ‚îÄ‚îÄ‚îÄ right_shoulder (6)
#         |                    |
#    left_elbow (7)      right_elbow (8)
#         |                    |
#    left_wrist (9)      right_wrist (10)
#         |                    |
#     left_hip (11) ‚îÄ‚îÄ‚îÄ‚îÄ right_hip (12)
#         |                    |
#    left_knee (13)      right_knee (14)
#         |                    |
#   left_ankle (15)     right_ankle (16)
# ```

# %%
# =====================================================
# STEP 1.2: Load Pose Data from CSV
# =====================================================
# üìù Description: 
# ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ
# ‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• pose estimation ‡∏Ç‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô
# ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å track ‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏ü‡∏£‡∏° ‡∏û‡∏£‡πâ‡∏≠‡∏° action labels
#
# üîÑ Process:
# 1. ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV ‡∏î‡πâ‡∏ß‡∏¢ pd.read_csv()
# 2. ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
# 3. ‡∏î‡∏π‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
#
# ‚ö†Ô∏è Note: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå 'pose_data.csv' ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô directory ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
# =====================================================

# ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
df_pose = pd.read_csv('pose_data.csv')

# ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
print("=" * 70)
print("üìä POSE DATA OVERVIEW")
print("=" * 70)
print(f"\nüìÅ Dataset Shape: {df_pose.shape[0]:,} rows √ó {df_pose.shape[1]} columns")
print(f"üìÖ Frame Range: {df_pose['frame_idx'].min()} to {df_pose['frame_idx'].max()}")
print(f"‚è±Ô∏è  Time Range: {df_pose['timestamp'].min():.2f}s to {df_pose['timestamp'].max():.2f}s")
print(f"üë• Unique Persons: {df_pose['person_id'].nunique()}")
print(f"üéØ Actions: {df_pose['action'].nunique()}")

print("\n" + "=" * 70)
print("üìã DATA SAMPLE (First 5 rows)")
print("=" * 70)
display(df_pose.head())

# %%
# =====================================================
# STEP 1.3: Data Info Summary
# =====================================================
# üìù Description: 
# ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á columns ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
# ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
#
# üîç ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:
# - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Non-Null Count ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ column
# - Dtype ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ column
# - Memory usage
# =====================================================

print("=" * 70)
print("üìã DATA STRUCTURE INFO")
print("=" * 70)
print(f"\nüìä Column Types:")
print(f"   - float64 (coordinates & confidence): 53 columns")
print(f"   - int64 (frame_idx, person_id): 2 columns")
print(f"   - object (action label): 1 column")
print(f"\nüíæ Memory Usage: ~14.9 MB")
print("\n" + "-" * 70)
df_pose.info()

# %% [markdown]
# ### 1.3 Define Constants
#
# **‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:** ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö COCO Keypoint format ‡πÅ‡∏•‡∏∞ Skeleton Connections
#
# **COCO Keypoint Format:**
# - ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏™‡∏≤‡∏Å‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Human Pose Estimation
# - ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢ 17 keypoints ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢
# - ‡πÅ‡∏ï‡πà‡∏•‡∏∞ keypoint ‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î (x, y) ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤ confidence
#
# **‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö Skeleton Connections:**
# ```
#              ‚óã nose
#             /|\
#     left_eye ‚óã ‚óã right_eye
#            /   \
#   left_ear ‚óã     ‚óã right_ear
#                   
#    left_shoulder ‚óã‚îÄ‚îÄ‚îÄ‚óã right_shoulder
#                  |   |
#                  ‚îÇ   ‚îÇ
#      left_elbow ‚óã   ‚óã right_elbow
#                  ‚îÇ   ‚îÇ
#      left_wrist ‚óã   ‚óã right_wrist
#                  ‚îÇ   ‚îÇ
#        left_hip ‚óã‚îÄ‚îÄ‚îÄ‚óã right_hip
#                  ‚îÇ   ‚îÇ
#       left_knee ‚óã   ‚óã right_knee
#                  ‚îÇ   ‚îÇ
#      left_ankle ‚óã   ‚óã right_ankle
# ```

# %%
# =====================================================
# STEP 1.4: Define COCO Keypoint Constants
# =====================================================
# üìù Description: 
# ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏∑‡πà‡∏≠ Keypoints ‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô COCO
# COCO format ‡∏°‡∏µ 17 keypoints ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢
#
# üéØ Purpose:
# - ‡πÉ‡∏ä‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ä‡∏∑‡πà‡∏≠ keypoints ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
# - ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏Ç‡∏≠‡∏á‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
# - ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î skeleton
# =====================================================

# ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Keypoints (17 ‡∏à‡∏∏‡∏î) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏±‡∏ä‡∏ô‡∏µ
KEYPOINT_NAMES = [
    "nose",           # 0 - ‡∏à‡∏°‡∏π‡∏Å
    "left_eye",       # 1 - ‡∏ï‡∏≤‡∏ã‡πâ‡∏≤‡∏¢
    "right_eye",      # 2 - ‡∏ï‡∏≤‡∏Ç‡∏ß‡∏≤
    "left_ear",       # 3 - ‡∏´‡∏π‡∏ã‡πâ‡∏≤‡∏¢
    "right_ear",      # 4 - ‡∏´‡∏π‡∏Ç‡∏ß‡∏≤
    "left_shoulder",  # 5 - ‡πÑ‡∏´‡∏•‡πà‡∏ã‡πâ‡∏≤‡∏¢
    "right_shoulder", # 6 - ‡πÑ‡∏´‡∏•‡πà‡∏Ç‡∏ß‡∏≤
    "left_elbow",     # 7 - ‡∏Ç‡πâ‡∏≠‡∏®‡∏≠‡∏Å‡∏ã‡πâ‡∏≤‡∏¢
    "right_elbow",    # 8 - ‡∏Ç‡πâ‡∏≠‡∏®‡∏≠‡∏Å‡∏Ç‡∏ß‡∏≤
    "left_wrist",     # 9 - ‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠‡∏ã‡πâ‡∏≤‡∏¢
    "right_wrist",    # 10 - ‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠‡∏Ç‡∏ß‡∏≤
    "left_hip",       # 11 - ‡∏™‡∏∞‡πÇ‡∏û‡∏Å‡∏ã‡πâ‡∏≤‡∏¢
    "right_hip",      # 12 - ‡∏™‡∏∞‡πÇ‡∏û‡∏Å‡∏Ç‡∏ß‡∏≤
    "left_knee",      # 13 - ‡πÄ‡∏Ç‡πà‡∏≤‡∏ã‡πâ‡∏≤‡∏¢
    "right_knee",     # 14 - ‡πÄ‡∏Ç‡πà‡∏≤‡∏Ç‡∏ß‡∏≤
    "left_ankle",     # 15 - ‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πâ‡∏≤‡∏ã‡πâ‡∏≤‡∏¢
    "right_ankle"     # 16 - ‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πâ‡∏≤‡∏Ç‡∏ß‡∏≤
]

# ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏Ç‡∏≠‡∏á‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô)
BODY_PARTS = {
    'head': ['nose', 'left_eye', 'right_eye', 'left_ear', 'right_ear'],
    'upper_body': ['left_shoulder', 'right_shoulder', 'left_elbow', 
                   'right_elbow', 'left_wrist', 'right_wrist'],
    'lower_body': ['left_hip', 'right_hip', 'left_knee', 
                   'right_knee', 'left_ankle', 'right_ankle'],
    'left_arm': ['left_shoulder', 'left_elbow', 'left_wrist'],
    'right_arm': ['right_shoulder', 'right_elbow', 'right_wrist'],
    'left_leg': ['left_hip', 'left_knee', 'left_ankle'],
    'right_leg': ['right_hip', 'right_knee', 'right_ankle'],
    'torso': ['left_shoulder', 'right_shoulder', 'left_hip', 'right_hip']
}

# ‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Skeleton Visualization
SKELETON_CONNECTIONS = [
    # Head connections
    ('nose', 'left_eye'), ('nose', 'right_eye'),
    ('left_eye', 'left_ear'), ('right_eye', 'right_ear'),
    # Upper body
    ('left_shoulder', 'right_shoulder'),  # shoulders
    ('left_shoulder', 'left_elbow'), ('left_elbow', 'left_wrist'),
    ('right_shoulder', 'right_elbow'), ('right_elbow', 'right_wrist'),
    # Torso
    ('left_shoulder', 'left_hip'), ('right_shoulder', 'right_hip'),
    ('left_hip', 'right_hip'),
    # Lower body
    ('left_hip', 'left_knee'), ('left_knee', 'left_ankle'),
    ('right_hip', 'right_knee'), ('right_knee', 'right_ankle')
]

print("‚úÖ Constants defined!")
print(f"   üìç Total Keypoints: {len(KEYPOINT_NAMES)}")
print(f"   ü¶¥ Body Parts Groups: {list(BODY_PARTS.keys())}")
print(f"   üîó Skeleton Connections: {len(SKELETON_CONNECTIONS)}")

# ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ Keypoints
print("\n" + "=" * 70)
print("üìã KEYPOINT REFERENCE TABLE")
print("=" * 70)
keypoint_df = pd.DataFrame({
    'Index': range(len(KEYPOINT_NAMES)),
    'Keypoint Name': KEYPOINT_NAMES,
    'Thai Name': ['‡∏à‡∏°‡∏π‡∏Å', '‡∏ï‡∏≤‡∏ã‡πâ‡∏≤‡∏¢', '‡∏ï‡∏≤‡∏Ç‡∏ß‡∏≤', '‡∏´‡∏π‡∏ã‡πâ‡∏≤‡∏¢', '‡∏´‡∏π‡∏Ç‡∏ß‡∏≤',
                  '‡πÑ‡∏´‡∏•‡πà‡∏ã‡πâ‡∏≤‡∏¢', '‡πÑ‡∏´‡∏•‡πà‡∏Ç‡∏ß‡∏≤', '‡∏Ç‡πâ‡∏≠‡∏®‡∏≠‡∏Å‡∏ã‡πâ‡∏≤‡∏¢', '‡∏Ç‡πâ‡∏≠‡∏®‡∏≠‡∏Å‡∏Ç‡∏ß‡∏≤',
                  '‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠‡∏ã‡πâ‡∏≤‡∏¢', '‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠‡∏Ç‡∏ß‡∏≤', '‡∏™‡∏∞‡πÇ‡∏û‡∏Å‡∏ã‡πâ‡∏≤‡∏¢', '‡∏™‡∏∞‡πÇ‡∏û‡∏Å‡∏Ç‡∏ß‡∏≤',
                  '‡πÄ‡∏Ç‡πà‡∏≤‡∏ã‡πâ‡∏≤‡∏¢', '‡πÄ‡∏Ç‡πà‡∏≤‡∏Ç‡∏ß‡∏≤', '‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πâ‡∏≤‡∏ã‡πâ‡∏≤‡∏¢', '‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πâ‡∏≤‡∏Ç‡∏ß‡∏≤']
})
print(keypoint_df.to_string(index=False))

# %% [markdown]
# ---
#
# ## üìö Part 2: Exploratory Data Analysis (EDA)
#
# ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
#
# ### 2.1 Action Distribution Analysis
#
# **‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:** ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á Actions ‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
#
# **‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Action Distribution?**
# - ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Class Balance)
# - ‡∏£‡∏∞‡∏ö‡∏∏ Actions ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏Å/‡∏ô‡πâ‡∏≠‡∏¢
# - ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞ sampling strategy

# %%
# =====================================================
# STEP 2.1: Action Distribution Analysis
# =====================================================
# üìù Description: 
# ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ Action
# ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
#
# üìä Output:
# - ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô frames ‡∏ï‡πà‡∏≠ action
# - Bar chart ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏±‡∏ß
# - Pie chart ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô
#
# üí° Insight:
# ‡∏ñ‡πâ‡∏≤ action ‡πÉ‡∏î‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ß‡∏±‡∏á
# ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á bias ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
# =====================================================

# ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞ Action
action_counts = df_pose['action'].value_counts()
action_percentages = df_pose['action'].value_counts(normalize=True) * 100

print("=" * 70)
print("üéØ ACTION DISTRIBUTION")
print("=" * 70)

# ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
action_summary = pd.DataFrame({
    'Action': action_counts.index,
    'Count': action_counts.values,
    'Percentage (%)': action_percentages.values.round(2)
})
print("\nüìã Summary Table:")
print(action_summary.to_string(index=False))

# ‡∏™‡∏£‡πâ‡∏≤‡∏á Visualization
fig, axes = plt.subplots(1, 2, figsize=(14, 5))

# Bar Chart
colors = plt.cm.Set3(np.linspace(0, 1, len(action_counts)))
bars = axes[0].barh(action_counts.index, action_counts.values, color=colors)
axes[0].set_xlabel('Number of Frames')
axes[0].set_title('üìä Action Distribution (Bar Chart)')
axes[0].invert_yaxis()

# ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ô bar
for bar, count in zip(bars, action_counts.values):
    axes[0].text(bar.get_width() + 50, bar.get_y() + bar.get_height()/2, 
                 f'{count:,}', va='center', fontsize=10)

# Pie Chart
axes[1].pie(action_counts.values, labels=action_counts.index, 
            autopct='%1.1f%%', colors=colors, startangle=90)
axes[1].set_title('üìä Action Distribution (Pie Chart)')

plt.tight_layout()
plt.show()

# %% [markdown]
# ### 2.2 Person ID Analysis
#
# **‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:** ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Frames ‡∏ï‡πà‡∏≠ Person ‡πÅ‡∏•‡∏∞ Person ‡∏ï‡πà‡∏≠ Action
#
# **‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö:**
# 1. ‡πÅ‡∏ï‡πà‡∏•‡∏∞ Person ‡∏°‡∏µ‡∏Å‡∏µ‡πà frames?
# 2. ‡πÅ‡∏ï‡πà‡∏•‡∏∞ Action ‡∏°‡∏µ Person ‡∏Å‡∏µ‡πà‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥?
# 3. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?

# %%
# =====================================================
# STEP 2.2: Person ID Analysis
# =====================================================
# üìù Description: 
# ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ß‡πà‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞ Person ‡∏°‡∏µ‡∏Å‡∏µ‡πà frames
# ‡πÅ‡∏•‡∏∞‡πÅ‡∏ï‡πà‡∏•‡∏∞ Action ‡∏°‡∏µ Person ‡∏Å‡∏µ‡πà‡∏Ñ‡∏ô
#
# üéØ Purpose:
# - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
# - ‡∏´‡∏≤ Persons ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
# - ‡∏î‡∏π‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡πÅ‡∏ï‡πà‡∏•‡∏∞ action
# =====================================================

# ‡∏ô‡∏±‡∏ö frames ‡∏ï‡πà‡∏≠ person
person_frame_counts = df_pose.groupby('person_id').size().reset_index(name='frame_count')
person_frame_counts = person_frame_counts.sort_values('frame_count', ascending=False)

print("=" * 70)
print("üë• PERSON ID ANALYSIS")
print("=" * 70)

print("\nüìã Frames per Person (Top 10):")
print(person_frame_counts.head(10).to_string(index=False))

print(f"\nüìä Statistics:")
print(f"   Total Unique Persons: {len(person_frame_counts)}")
print(f"   Max Frames per Person: {person_frame_counts['frame_count'].max():,}")
print(f"   Min Frames per Person: {person_frame_counts['frame_count'].min():,}")
print(f"   Mean Frames per Person: {person_frame_counts['frame_count'].mean():.2f}")
print(f"   Median Frames per Person: {person_frame_counts['frame_count'].median():.2f}")

# Person distribution per action
print("\n" + "=" * 70)
print("üéØ PERSONS PER ACTION")
print("=" * 70)

person_per_action = df_pose.groupby('action')['person_id'].nunique().reset_index()
person_per_action.columns = ['Action', 'Unique Persons']
print(person_per_action.to_string(index=False))

# Visualization
fig, axes = plt.subplots(1, 2, figsize=(14, 5))

# Frames per person (top 15)
top_persons = person_frame_counts.head(15)
axes[0].bar(top_persons['person_id'].astype(str), top_persons['frame_count'], 
            color='steelblue', edgecolor='navy')
axes[0].set_xlabel('Person ID')
axes[0].set_ylabel('Number of Frames')
axes[0].set_title('üë• Frames per Person (Top 15)')
axes[0].tick_params(axis='x', rotation=45)

# Persons per action
colors = plt.cm.Set2(np.linspace(0, 1, len(person_per_action)))
axes[1].bar(person_per_action['Action'], person_per_action['Unique Persons'], 
            color=colors, edgecolor='black')
axes[1].set_xlabel('Action')
axes[1].set_ylabel('Number of Unique Persons')
axes[1].set_title('üéØ Unique Persons per Action')
axes[1].tick_params(axis='x', rotation=45)

plt.tight_layout()
plt.show()

# %% [markdown]
# ### 2.3 Select 3 Representative Person IDs for Analysis
#
# **‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:** ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 3 Person IDs ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
#
# **‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:**
# 1. ‡∏°‡∏µ labeled frames ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà 'Unknown')
# 2. ‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡πÉ‡∏ô‡∏´‡∏•‡∏≤‡∏¢ actions
# 3. ‡∏°‡∏µ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏≤‡∏ß‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö time series analysis
#
# ```
# ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
# ‚îÇ          SELECTION CRITERIA                 ‚îÇ
# ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
# ‚îÇ ‚úì Labeled frames (not 'Unknown')           ‚îÇ
# ‚îÇ ‚úì Multiple actions performed               ‚îÇ
# ‚îÇ ‚úì Continuous time series                   ‚îÇ
# ‚îÇ ‚úì High confidence keypoints                ‚îÇ
# ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
# ```

# %%
# =====================================================
# STEP 2.3: Select 3 Representative Person IDs
# =====================================================
# üìù Description: 
# ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 3 Person IDs ‡∏ó‡∏µ‡πà‡∏°‡∏µ frames ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
# ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡πÉ‡∏ô Action labels (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Unknown)
# ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
#
# üîÑ Process:
# 1. ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ frames ‡∏ó‡∏µ‡πà‡∏°‡∏µ label
# 2. ‡∏ô‡∏±‡∏ö frames ‡∏ï‡πà‡∏≠ person
# 3. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å top 3 persons
# 4. ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
#
# üí° Note: 
# ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å persons ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
# ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô
# =====================================================

# ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ frames ‡∏ó‡∏µ‡πà‡∏°‡∏µ label (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Unknown)
df_labeled = df_pose[df_pose['action'] != 'Unknown'].copy()

print(f"üìä Filtered Data: {len(df_labeled):,} frames with labels (excluded 'Unknown')")

# ‡∏ô‡∏±‡∏ö frames ‡∏ï‡πà‡∏≠ person ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ label
person_labeled_counts = df_labeled.groupby('person_id').agg({
    'frame_idx': 'count',
    'action': lambda x: x.nunique()
}).reset_index()
person_labeled_counts.columns = ['person_id', 'labeled_frames', 'actions_count']
person_labeled_counts = person_labeled_counts.sort_values('labeled_frames', ascending=False)

print("\n" + "=" * 70)
print("üéØ SELECTING REPRESENTATIVE PERSON IDs")
print("=" * 70)

print("\nüìã Persons with Labeled Frames (Top 10):")
print(person_labeled_counts.head(10).to_string(index=False))

# ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 3 person IDs ‡∏ó‡∏µ‡πà‡∏°‡∏µ frames ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
SELECTED_PERSON_IDS = person_labeled_counts.head(3)['person_id'].tolist()

print(f"\n‚úÖ Selected Person IDs for Analysis: {SELECTED_PERSON_IDS}")

# ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á selected persons
print("\n" + "=" * 70)
print("üìä SELECTED PERSONS DETAILS")
print("=" * 70)

for pid in SELECTED_PERSON_IDS:
    person_data = df_labeled[df_labeled['person_id'] == pid]
    actions = person_data['action'].unique()
    print(f"\nüë§ Person ID: {pid}")
    print(f"   üìà Total Labeled Frames: {len(person_data):,}")
    print(f"   üéØ Actions: {list(actions)}")
    print(f"   üìÖ Frame Range: {person_data['frame_idx'].min()} - {person_data['frame_idx'].max()}")
    print(f"   ‚è±Ô∏è  Time Range: {person_data['timestamp'].min():.2f}s - {person_data['timestamp'].max():.2f}s")
    print(f"   üìä Duration: {person_data['timestamp'].max() - person_data['timestamp'].min():.2f}s")

# %% [markdown]
# ---
#
# ## üìö Part 3: Time Series Analysis
#
# ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤ (Time Series) ‡∏Ç‡∏≠‡∏á keypoints ‡∏ï‡πà‡∏≤‡∏á‡πÜ
#
# ### 3.1 Keypoint Position Time Series
#
# **‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:** ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Keypoints ‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ Action
#
# **Key Keypoints ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡πà‡∏≤‡∏°‡∏ß‡∏¢:**
#
# | Keypoint | ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç |
# |----------|----------|
# | right_wrist | ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏±‡∏î‡∏Ç‡∏ß‡∏≤ |
# | left_wrist | ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏±‡∏î‡∏ã‡πâ‡∏≤‡∏¢ |
# | right_ankle | ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏Ç‡∏≠‡∏á‡πÄ‡∏ï‡∏∞‡∏Ç‡∏ß‡∏≤ |
# | left_ankle | ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏Ç‡∏≠‡∏á‡πÄ‡∏ï‡∏∞‡∏ã‡πâ‡∏≤‡∏¢ |
# | nose | ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏Ç‡∏≠‡∏á‡∏®‡∏µ‡∏£‡∏©‡∏∞/‡∏•‡∏≥‡∏ï‡∏±‡∏ß |
#
# **‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö Coordinate System:**
# ```
# (0,0) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí X (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤)
#   ‚îÇ
#   ‚îÇ    ‚óã nose
#   ‚îÇ   /|\
#   ‚îÇ  ‚óã ‚îÇ ‚óã
#   ‚îÇ    ‚îÇ
#   ‚Üì    ‚îÇ
#   Y    ‚îÇ
# (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á)
# ```

# %%
# =====================================================
# STEP 3.1: Keypoint Position Time Series Analysis
# =====================================================
# üìù Description: 
# ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á keypoints ‡∏´‡∏•‡∏±‡∏Å‡πÜ ‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤
# ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à pattern ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡πà‡∏≤
# 
# üéØ Key Keypoints:
# - wrists: ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏Ç‡∏≠‡∏á‡∏°‡∏∑‡∏≠ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏±‡∏î)
# - ankles: ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏Ç‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∞)
# - nose: ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏Ç‡∏≠‡∏á‡∏®‡∏µ‡∏£‡∏©‡∏∞
#
# üìä Output:
# - ‡∏Å‡∏£‡∏≤‡∏ü X coordinate ‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤
# - ‡∏Å‡∏£‡∏≤‡∏ü Y coordinate ‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤
# - ‡πÅ‡∏¢‡∏Å‡∏™‡∏µ‡∏ï‡∏≤‡∏° action
# =====================================================

# Keypoints ‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡πà‡∏≤‡∏°‡∏ß‡∏¢
ANALYSIS_KEYPOINTS = ['right_wrist', 'left_wrist', 'right_ankle', 'left_ankle', 'nose']

def plot_keypoint_timeseries(df, person_id, keypoints, figsize=(16, 12)):
    """
    ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü Time Series ‡∏Ç‡∏≠‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Keypoints
    
    Parameters:
    -----------
    df : DataFrame - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• pose
    person_id : int - Person ID ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
    keypoints : list - ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ keypoints
    figsize : tuple - ‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ
    
    Returns:
    --------
    fig : matplotlib figure object
    """
    # ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö person ‡∏ô‡∏µ‡πâ
    person_data = df[df['person_id'] == person_id].copy()
    person_data = person_data.sort_values('frame_idx')
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á figure
    fig, axes = plt.subplots(len(keypoints), 2, figsize=figsize)
    fig.suptitle(f'üë§ Keypoint Time Series - Person ID: {person_id}', 
                 fontsize=16, fontweight='bold')
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á color map ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö actions
    actions = person_data['action'].unique()
    action_colors = dict(zip(actions, plt.cm.Set2(np.linspace(0, 1, len(actions)))))
    
    for idx, kpt in enumerate(keypoints):
        # Plot X coordinate
        ax_x = axes[idx, 0]
        for action in actions:
            action_data = person_data[person_data['action'] == action]
            ax_x.scatter(action_data['timestamp'], action_data[f'{kpt}_x'], 
                        label=action, alpha=0.6, s=2, color=action_colors[action])
        
        ax_x.set_ylabel(f'{kpt}\nX Position (pixels)')
        ax_x.set_title(f'{kpt.replace("_", " ").title()} - X Coordinate')
        if idx == 0:
            ax_x.legend(loc='upper right', fontsize=8, markerscale=5)
        
        # Plot Y coordinate
        ax_y = axes[idx, 1]
        for action in actions:
            action_data = person_data[person_data['action'] == action]
            ax_y.scatter(action_data['timestamp'], action_data[f'{kpt}_y'], 
                        label=action, alpha=0.6, s=2, color=action_colors[action])
        
        ax_y.set_ylabel(f'{kpt}\nY Position (pixels)')
        ax_y.set_title(f'{kpt.replace("_", " ").title()} - Y Coordinate')
        
        # ‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏Å‡∏ô Y ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ pixel coordinate ‡∏°‡∏µ Y ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á
        ax_y.invert_yaxis()
    
    # Set x labels for bottom row
    axes[-1, 0].set_xlabel('Time (seconds)')
    axes[-1, 1].set_xlabel('Time (seconds)')
    
    plt.tight_layout()
    return fig

# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Person ID ‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
print("=" * 70)
print("üìà KEYPOINT TIME SERIES VISUALIZATION")
print("=" * 70)
print("\nüí° Interpretation Guide:")
print("   - ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏µ‡πÅ‡∏ó‡∏ô action ‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô")
print("   - ‡πÅ‡∏Å‡∏ô X: ‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)")
print("   - ‡πÅ‡∏Å‡∏ô Y ‡∏ã‡πâ‡∏≤‡∏¢: ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á X (pixels) - ‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤")
print("   - ‡πÅ‡∏Å‡∏ô Y ‡∏Ç‡∏ß‡∏≤: ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Y (pixels) - ‡∏ö‡∏ô/‡∏•‡πà‡∏≤‡∏á (inverted)")
print("\n" + "-" * 70)

for pid in SELECTED_PERSON_IDS[:1]:  # ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ person ‡πÅ‡∏£‡∏Å
    print(f"\nüìä Generating plot for Person ID: {pid}")
    fig = plot_keypoint_timeseries(df_labeled, pid, ANALYSIS_KEYPOINTS)
    plt.show()

# %% [markdown]
# ### 3.2 Compare Keypoint Trajectories Across Actions
#
# **‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:** ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö Trajectory ‡∏Ç‡∏≠‡∏á Keypoints ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞ Action
#
# **‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå:**
# - ‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡πà‡∏≤
# - ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á persons
# - ‡∏´‡∏≤ pattern ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ action
#
# **‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏Å‡∏£‡∏≤‡∏ü:**
# ```
# ‚îÄ‚îÄ‚îÄ ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏∂‡∏ö: X coordinate
# --- ‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞: Y coordinate
# ‡∏™‡∏µ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô: Person ID ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô
# ```

# %%
# =====================================================
# STEP 3.2: Compare Keypoint Trajectories Across Actions
# =====================================================
# üìù Description: 
# ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á keypoints
# ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞ action ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤ pattern ‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô
#
# üîç What to look for:
# - ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡πÜ (repetitive patterns)
# - ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á actions
# - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Ñ‡∏•‡∏∂‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á persons ‡∏ó‡∏≥‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
# =====================================================

def plot_action_comparison(df, person_ids, keypoint, figsize=(16, 10)):
    """
    ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö trajectory ‡∏Ç‡∏≠‡∏á keypoint ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞ action
    ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö selected persons
    
    Parameters:
    -----------
    df : DataFrame - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• pose
    person_ids : list - ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ person IDs
    keypoint : str - ‡∏ä‡∏∑‡πà‡∏≠ keypoint
    figsize : tuple - ‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ
    
    Returns:
    --------
    fig : matplotlib figure object
    """
    # ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    df_selected = df[df['person_id'].isin(person_ids)].copy()
    actions = [a for a in df_selected['action'].unique() if a != 'Unknown']
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á figure
    n_actions = len(actions)
    n_cols = 3
    n_rows = (n_actions + n_cols - 1) // n_cols
    
    fig, axes = plt.subplots(n_rows, n_cols, figsize=figsize)
    axes = axes.flatten() if n_rows > 1 or n_cols > 1 else [axes]
    
    fig.suptitle(f'üéØ {keypoint.replace("_", " ").title()} Trajectory Comparison\n'
                 f'Selected Persons: {person_ids}', 
                 fontsize=14, fontweight='bold')
    
    # Color map ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö persons
    person_colors = dict(zip(person_ids, ['#e74c3c', '#3498db', '#2ecc71']))
    
    for idx, action in enumerate(actions):
        ax = axes[idx]
        action_data = df_selected[df_selected['action'] == action]
        
        for pid in person_ids:
            person_data = action_data[action_data['person_id'] == pid]
            if len(person_data) > 0:
                # Normalize time to start from 0
                person_data = person_data.sort_values('timestamp')
                time_normalized = person_data['timestamp'] - person_data['timestamp'].min()
                
                ax.plot(time_normalized, person_data[f'{keypoint}_x'], 
                       label=f'Person {pid} (X)', linestyle='-', alpha=0.8,
                       color=person_colors[pid])
                ax.plot(time_normalized, person_data[f'{keypoint}_y'], 
                       label=f'Person {pid} (Y)', linestyle='--', alpha=0.8,
                       color=person_colors[pid])
        
        ax.set_title(action.replace('_', ' '), fontsize=11)
        ax.set_xlabel('Normalized Time (s)')
        ax.set_ylabel('Position (pixels)')
        
        if idx == 0:
            ax.legend(fontsize=8, loc='upper right')
    
    # ‡∏ã‡πà‡∏≠‡∏ô axes ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ
    for idx in range(len(actions), len(axes)):
        axes[idx].set_visible(False)
    
    plt.tight_layout()
    return fig

# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö right_wrist (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏±‡∏î)
print("=" * 70)
print("üìä ACTION TRAJECTORY COMPARISON")
print("=" * 70)
print("\nüí° Reading Guide:")
print("   ‚îÄ‚îÄ‚îÄ ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏∂‡∏ö: X coordinate (‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤)")
print("   --- ‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞: Y coordinate (‡∏ö‡∏ô-‡∏•‡πà‡∏≤‡∏á)")
print("   üî¥ ‡πÅ‡∏î‡∏á: Person 1")
print("   üîµ ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô: Person 2") 
print("   üü¢ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß: Person 3")
print("\n" + "-" * 70)

for kpt in ['right_wrist', 'right_ankle']:
    print(f"\nüìä Analyzing: {kpt.replace('_', ' ').title()}")
    fig = plot_action_comparison(df_labeled, SELECTED_PERSON_IDS, kpt)
    plt.show()

# %% [markdown]
# ### 3.3 Velocity Analysis
#
# **‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:** ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏≠‡∏á Keypoints ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤ pattern ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß
#
# **‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß:**
# ```
# velocity = ‚àö((dx/dt)¬≤ + (dy/dt)¬≤)
#
# ‡πÇ‡∏î‡∏¢‡∏ó‡∏µ‡πà:
# - dx = ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á X
# - dy = ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Y  
# - dt = ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤
# ```
#
# **‡∏Å‡∏≤‡∏£‡∏ï‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°:**
# - **‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏π‡∏á** = ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß (‡∏´‡∏°‡∏±‡∏î, ‡πÄ‡∏ï‡∏∞)
# - **‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏ï‡πà‡∏≥** = ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏ä‡πâ‡∏≤‡πÜ (‡∏ó‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏±‡∏ö, ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß)
#
# ```
#        High Velocity              Low Velocity
#            ‚Üó                          ‚Üí
#           /                           
#          /                            
#         ‚óã ‚îÄ‚Üí ‚îÄ‚îÄ‚îÄ‚Üí ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí              ‚óã ‚Üí ‚óã ‚Üí ‚óã
#        ‡∏´‡∏°‡∏±‡∏î/‡πÄ‡∏ï‡∏∞                      ‡∏ó‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏±‡∏ö
# ```

# %%
# =====================================================
# STEP 3.3: Velocity Analysis
# =====================================================
# üìù Description: 
# ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏≠‡∏á keypoints
# ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß = ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤
# 
# üìê Formula: 
# velocity = sqrt((dx/dt)^2 + (dy/dt)^2)
# 
# üéØ Interpretation:
# - ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏π‡∏á = ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß (‡∏´‡∏°‡∏±‡∏î, ‡πÄ‡∏ï‡∏∞)
# - ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏ï‡πà‡∏≥ = ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏ä‡πâ‡∏≤‡πÜ (‡∏ó‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏±‡∏ö)
#
# üîß Smoothing:
# ‡πÉ‡∏ä‡πâ uniform_filter1d ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î noise ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• velocity
# =====================================================

def calculate_velocity(df, person_id, keypoint, window_size=3):
    """
    ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏≠‡∏á keypoint
    
    Parameters:
    -----------
    df : DataFrame - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• pose
    person_id : int - Person ID
    keypoint : str - ‡∏ä‡∏∑‡πà‡∏≠ keypoint
    window_size : int - ‡∏Ç‡∏ô‡∏≤‡∏î window ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö smoothing
    
    Returns:
    --------
    DataFrame ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå velocity ‡πÅ‡∏•‡∏∞ velocity_smooth
    """
    # ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞ sort ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    person_data = df[df['person_id'] == person_id].copy()
    person_data = person_data.sort_values('timestamp').reset_index(drop=True)
    
    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì dx, dy, dt
    person_data['dx'] = person_data[f'{keypoint}_x'].diff()
    person_data['dy'] = person_data[f'{keypoint}_y'].diff()
    person_data['dt'] = person_data['timestamp'].diff()
    
    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì velocity (Euclidean distance per time)
    person_data['velocity'] = np.sqrt(
        (person_data['dx'] / person_data['dt'])**2 + 
        (person_data['dy'] / person_data['dt'])**2
    )
    
    # Smooth velocity ‡∏î‡πâ‡∏ß‡∏¢ moving average
    if window_size > 1 and len(person_data) > window_size:
        person_data['velocity_smooth'] = uniform_filter1d(
            person_data['velocity'].fillna(0), size=window_size
        )
    else:
        person_data['velocity_smooth'] = person_data['velocity']
    
    return person_data

def plot_velocity_analysis(df, person_ids, keypoint, figsize=(16, 10)):
    """
    ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á actions
    
    Parameters:
    -----------
    df : DataFrame - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• pose
    person_ids : list - ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ person IDs
    keypoint : str - ‡∏ä‡∏∑‡πà‡∏≠ keypoint
    figsize : tuple - ‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ
    
    Returns:
    --------
    fig : matplotlib figure object
    """
    actions = [a for a in df['action'].unique() if a != 'Unknown']
    
    fig, axes = plt.subplots(len(person_ids), 1, figsize=figsize, sharex=True)
    if len(person_ids) == 1:
        axes = [axes]
    
    fig.suptitle(f'‚ö° Velocity Analysis - {keypoint.replace("_", " ").title()}\n'
                 f'Higher velocity = Faster movement (e.g., punch, kick)', 
                 fontsize=14, fontweight='bold')
    
    # Color map ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö actions
    action_colors = dict(zip(actions, plt.cm.tab10(np.linspace(0, 1, len(actions)))))
    
    for idx, pid in enumerate(person_ids):
        ax = axes[idx]
        
        # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì velocity
        vel_data = calculate_velocity(df, pid, keypoint, window_size=5)
        vel_data = vel_data[vel_data['action'] != 'Unknown']
        
        # Plot velocity for each action
        for action in actions:
            action_data = vel_data[vel_data['action'] == action]
            if len(action_data) > 0:
                ax.plot(action_data['timestamp'], action_data['velocity_smooth'],
                       label=action, alpha=0.7, linewidth=0.8,
                       color=action_colors[action])
        
        ax.set_ylabel(f'Person {pid}\nVelocity (px/s)')
        ax.set_ylim(0, vel_data['velocity_smooth'].quantile(0.99) * 1.1)
        
        if idx == 0:
            ax.legend(loc='upper right', fontsize=8, ncol=2)
    
    axes[-1].set_xlabel('Time (seconds)')
    
    plt.tight_layout()
    return fig

# ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö wrists
print("=" * 70)
print("‚ö° VELOCITY ANALYSIS")
print("=" * 70)
print("\nüí° Interpretation:")
print("   üìà Peak ‡∏™‡∏π‡∏á = ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡πÄ‡∏£‡πá‡∏ß (‡∏´‡∏°‡∏±‡∏î/‡πÄ‡∏ï‡∏∞)")
print("   üìâ ‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥ = ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏ä‡πâ‡∏≤ (‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß/‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏±‡∏ö)")
print("\n" + "-" * 70)

for kpt in ['right_wrist', 'left_wrist']:
    print(f"\nüìä Velocity analysis for: {kpt.replace('_', ' ').title()}")
    fig = plot_velocity_analysis(df_labeled, SELECTED_PERSON_IDS, kpt)
    plt.show()

# %% [markdown]
# ### 3.4 Velocity Statistics per Action
#
# **‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:** ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ Action ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
#
# **‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì:**
# - **Mean Velocity**: ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ - ‡∏ö‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÇ‡∏î‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤
# - **Max Velocity**: ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î - ‡∏ö‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
# - **Std Velocity**: ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ö‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô - ‡∏ö‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏õ‡∏£‡∏õ‡∏£‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß

# %%
# =====================================================
# STEP 3.4: Velocity Statistics per Action
# =====================================================
# üìù Description: 
# ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß
# ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ action ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡πÄ‡∏£‡πá‡∏ß/‡∏ä‡πâ‡∏≤
#
# üìä Statistics computed:
# - Mean Velocity: ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
# - Max Velocity: ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
# - Std Velocity: ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ö‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
# - Median Velocity: ‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏ò‡∏¢‡∏ê‡∏≤‡∏ô
# =====================================================

def calculate_action_velocity_stats(df, person_ids, keypoints):
    """
    ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏ï‡πà‡∏≠ action
    
    Parameters:
    -----------
    df : DataFrame - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• pose
    person_ids : list - ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ person IDs
    keypoints : list - ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ keypoints
    
    Returns:
    --------
    DataFrame ‡∏Ç‡∏≠‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß
    """
    results = []
    
    for pid in person_ids:
        for kpt in keypoints:
            vel_data = calculate_velocity(df, pid, kpt, window_size=5)
            vel_data = vel_data[vel_data['action'] != 'Unknown']
            
            # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡πà‡∏≠ action
            for action in vel_data['action'].unique():
                action_data = vel_data[vel_data['action'] == action]['velocity_smooth']
                action_data = action_data.dropna()
                
                if len(action_data) > 0:
                    results.append({
                        'person_id': pid,
                        'keypoint': kpt,
                        'action': action,
                        'mean_velocity': action_data.mean(),
                        'max_velocity': action_data.max(),
                        'std_velocity': action_data.std(),
                        'median_velocity': action_data.median()
                    })
    
    return pd.DataFrame(results)

# ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
velocity_stats = calculate_action_velocity_stats(
    df_labeled, 
    SELECTED_PERSON_IDS, 
    ['right_wrist', 'left_wrist', 'right_ankle', 'left_ankle']
)

print("=" * 70)
print("üìä VELOCITY STATISTICS BY ACTION")
print("=" * 70)

# ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡πâ‡∏≤‡∏° persons ‡πÅ‡∏•‡∏∞ keypoints
action_velocity_summary = velocity_stats.groupby('action').agg({
    'mean_velocity': 'mean',
    'max_velocity': 'mean',
    'std_velocity': 'mean'
}).round(2)

action_velocity_summary = action_velocity_summary.sort_values('mean_velocity', ascending=False)

print("\nüìã Average Velocity Statistics by Action:")
print("   (Averaged across all persons and keypoints)")
print("\n" + action_velocity_summary.to_string())

print("\nüí° Interpretation:")
print("   ü•á Actions ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô = ‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤ (‡∏´‡∏°‡∏±‡∏î/‡πÄ‡∏ï‡∏∞)")
print("   ü•â Actions ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á = ‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏ä‡πâ‡∏≤‡∏Å‡∏ß‡πà‡∏≤ (‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏±‡∏ö)")

# Visualization
fig, axes = plt.subplots(1, 2, figsize=(14, 6))

# Mean velocity by action
colors = plt.cm.RdYlGn(np.linspace(0.2, 0.8, len(action_velocity_summary)))[::-1]
bars = axes[0].barh(action_velocity_summary.index, 
                    action_velocity_summary['mean_velocity'],
                    color=colors, edgecolor='black')
axes[0].set_xlabel('Mean Velocity (pixels/second)')
axes[0].set_title('üìä Mean Velocity by Action\n(Higher = Faster movement)')
axes[0].invert_yaxis()

# ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏ö‡∏ô bar
for bar, val in zip(bars, action_velocity_summary['mean_velocity']):
    axes[0].text(bar.get_width() + 5, bar.get_y() + bar.get_height()/2,
                 f'{val:.1f}', va='center', fontsize=9)

# Max velocity by action
bars = axes[1].barh(action_velocity_summary.index, 
                    action_velocity_summary['max_velocity'],
                    color=colors, edgecolor='black')
axes[1].set_xlabel('Max Velocity (pixels/second)')
axes[1].set_title('üìä Max Velocity by Action\n(Peak movement speed)')
axes[1].invert_yaxis()

# ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏ö‡∏ô bar
for bar, val in zip(bars, action_velocity_summary['max_velocity']):
    axes[1].text(bar.get_width() + 5, bar.get_y() + bar.get_height()/2,
                 f'{val:.1f}', va='center', fontsize=9)

plt.tight_layout()
plt.show()

# %% [markdown]
# ---
#
# ## üìö Part 4: Joint Angle Analysis
#
# ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏°‡∏∏‡∏°‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠ (Joint Angles) ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á
#
# ### 4.1 Understanding Joint Angles
#
# **Joint Angle ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?**
# - ‡∏°‡∏∏‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠ 3 ‡∏à‡∏∏‡∏î (‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏´‡∏•‡πà-‡∏Ç‡πâ‡∏≠‡∏®‡∏≠‡∏Å-‡∏Ç‡πâ‡∏≠‡∏°‡∏∑‡∏≠)
# - ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß
# - ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡πÉ‡∏ô‡∏Å‡∏µ‡∏¨‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß
#
# **Angles ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì:**
#
# | Angle | Points | ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢ |
# |-------|--------|----------|
# | Elbow Angle | shoulder-elbow-wrist | ‡∏°‡∏∏‡∏°‡∏á‡∏≠‡∏Ç‡πâ‡∏≠‡∏®‡∏≠‡∏Å |
# | Knee Angle | hip-knee-ankle | ‡∏°‡∏∏‡∏°‡∏á‡∏≠‡πÄ‡∏Ç‡πà‡∏≤ |
# | Shoulder Angle | elbow-shoulder-hip | ‡∏°‡∏∏‡∏°‡∏¢‡∏Å‡πÅ‡∏Ç‡∏ô |
# | Hip Angle | shoulder-hip-knee | ‡∏°‡∏∏‡∏°‡∏¢‡∏Å‡∏Ç‡∏≤ |
# | Torso Lean | ‡∏à‡∏≤‡∏Å‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á | ‡∏°‡∏∏‡∏°‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏ï‡∏±‡∏ß |
#
# **‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°:**
# ```
#         p1 (shoulder)
#          \
#           \  ‚Üê angle
#            \
#             p2 (elbow) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ p3 (wrist)
#
# angle = arctan2(|cross(v1,v2)|, dot(v1,v2))
# ‡πÇ‡∏î‡∏¢ v1 = p1 - p2, v2 = p3 - p2
# ```
#
# **‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏°‡∏∏‡∏°:**
# ```
# Elbow Angle:
# - 180¬∞ = ‡πÅ‡∏Ç‡∏ô‡πÄ‡∏´‡∏¢‡∏µ‡∏¢‡∏î‡∏ï‡∏£‡∏á
# - 90¬∞  = ‡∏á‡∏≠ 90 ‡∏≠‡∏á‡∏®‡∏≤
# - 45¬∞  = ‡∏á‡∏≠‡∏°‡∏≤‡∏Å
#
#   180¬∞           90¬∞            45¬∞
#   ‚îÄ‚îÄ‚îÄ‚îÄ‚óã         ‚óã              ‚óã
#       ‚îÇ          \            /
#       ‚îÇ           \          /
#       ‚óã            ‚óã        ‚óã
# ```

# %%
# =====================================================
# STEP 4.1: Joint Angle Calculation Functions
# =====================================================
# üìù Description: 
# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠
# 
# üìê Mathematical Principle:
# ‡πÉ‡∏ä‡πâ dot product ‡πÅ‡∏•‡∏∞ cross product
# angle = atan2(|cross_product|, dot_product)
# 
# üìä Output:
# ‡∏°‡∏∏‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏á‡∏®‡∏≤ (degrees) ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà 0¬∞ ‡∏ñ‡∏∂‡∏á 180¬∞
#
# üí° Note:
# - 180¬∞ = ‡πÄ‡∏´‡∏¢‡∏µ‡∏¢‡∏î‡∏ï‡∏£‡∏á
# - 90¬∞ = ‡∏á‡∏≠‡∏â‡∏≤‡∏Å
# - 0¬∞ = ‡∏û‡∏±‡∏ö‡∏ä‡∏¥‡∏î
# =====================================================

def calculate_angle(p1, p2, p3):
    """
    ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î p2 ‡∏à‡∏≤‡∏Å‡πÄ‡∏™‡πâ‡∏ô p1-p2 ‡πÅ‡∏•‡∏∞ p2-p3
    
    Parameters:
    -----------
    p1, p2, p3 : np.array - ‡∏û‡∏¥‡∏Å‡∏±‡∏î (x, y) ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏à‡∏∏‡∏î
    
    Returns:
    --------
    angle : float - ‡∏°‡∏∏‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏á‡∏®‡∏≤ (0-180)
    
    Diagram:
           p1
            \
             \  angle
              p2-------p3
    
    Formula:
    angle = arctan2(|v1 √ó v2|, v1 ¬∑ v2)
    """
    # Vector ‡∏à‡∏≤‡∏Å p2 ‡πÑ‡∏õ p1 ‡πÅ‡∏•‡∏∞ p3
    v1 = p1 - p2
    v2 = p3 - p2
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ valid ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (0 = keypoint not detected)
    if np.any(p1 == 0) or np.any(p2 == 0) or np.any(p3 == 0):
        return np.nan
    
    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì dot product: v1 ¬∑ v2 = |v1||v2|cos(Œ∏)
    dot = np.dot(v1, v2)
    
    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì cross product magnitude: |v1 √ó v2| = |v1||v2|sin(Œ∏)
    cross = np.cross(v1, v2)
    
    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏° (radians) ‡∏î‡πâ‡∏ß‡∏¢ atan2 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏°‡∏∏‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å quadrant
    angle_rad = np.arctan2(np.abs(cross), dot)
    
    # ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô degrees
    angle_deg = np.degrees(angle_rad)
    
    return angle_deg

def calculate_all_angles(row):
    """
    ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 1 row ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    
    Parameters:
    -----------
    row : pandas Series - 1 row ‡∏Ç‡∏≠‡∏á DataFrame
    
    Returns:
    --------
    dict : dictionary ‡∏Ç‡∏≠‡∏á‡∏°‡∏∏‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ
    """
    angles = {}
    
    # Helper function ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î keypoint
    def get_point(name):
        return np.array([row[f'{name}_x'], row[f'{name}_y']])
    
    # ===== Elbow Angles (‡∏°‡∏∏‡∏°‡∏Ç‡πâ‡∏≠‡∏®‡∏≠‡∏Å) =====
    # ‡∏Å‡∏≤‡∏£‡∏á‡∏≠‡∏Ç‡πâ‡∏≠‡∏®‡∏≠‡∏Å: shoulder-elbow-wrist
    angles['left_elbow_angle'] = calculate_angle(
        get_point('left_shoulder'),
        get_point('left_elbow'),
        get_point('left_wrist')
    )
    
    angles['right_elbow_angle'] = calculate_angle(
        get_point('right_shoulder'),
        get_point('right_elbow'),
        get_point('right_wrist')
    )
    
    # ===== Knee Angles (‡∏°‡∏∏‡∏°‡πÄ‡∏Ç‡πà‡∏≤) =====
    # ‡∏Å‡∏≤‡∏£‡∏á‡∏≠‡πÄ‡∏Ç‡πà‡∏≤: hip-knee-ankle
    angles['left_knee_angle'] = calculate_angle(
        get_point('left_hip'),
        get_point('left_knee'),
        get_point('left_ankle')
    )
    
    angles['right_knee_angle'] = calculate_angle(
        get_point('right_hip'),
        get_point('right_knee'),
        get_point('right_ankle')
    )
    
    # ===== Shoulder Angles (‡∏°‡∏∏‡∏°‡πÑ‡∏´‡∏•‡πà) =====
    # ‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÅ‡∏Ç‡∏ô: elbow-shoulder-hip
    angles['left_shoulder_angle'] = calculate_angle(
        get_point('left_elbow'),
        get_point('left_shoulder'),
        get_point('left_hip')
    )
    
    angles['right_shoulder_angle'] = calculate_angle(
        get_point('right_elbow'),
        get_point('right_shoulder'),
        get_point('right_hip')
    )
    
    # ===== Hip Angles (‡∏°‡∏∏‡∏°‡∏™‡∏∞‡πÇ‡∏û‡∏Å) =====
    # ‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡∏Ç‡∏≤: shoulder-hip-knee
    angles['left_hip_angle'] = calculate_angle(
        get_point('left_shoulder'),
        get_point('left_hip'),
        get_point('left_knee')
    )
    
    angles['right_hip_angle'] = calculate_angle(
        get_point('right_shoulder'),
        get_point('right_hip'),
        get_point('right_knee')
    )
    
    # ===== Torso Lean Angle (‡∏°‡∏∏‡∏°‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏ï‡∏±‡∏ß) =====
    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° shoulder center ‡∏Å‡∏±‡∏ö hip center
    shoulder_mid = (get_point('left_shoulder') + get_point('right_shoulder')) / 2
    hip_mid = (get_point('left_hip') + get_point('right_hip')) / 2
    
    # ‡∏°‡∏∏‡∏°‡∏Ç‡∏≠‡∏á‡∏•‡∏≥‡∏ï‡∏±‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á (vertical)
    vertical = np.array([0, -1])  # ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô (‡πÉ‡∏ô pixel coord, Y ‡∏•‡∏î‡∏•‡∏á = ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô)
    torso_vector = shoulder_mid - hip_mid
    
    if np.linalg.norm(torso_vector) > 0:
        torso_vector_norm = torso_vector / np.linalg.norm(torso_vector)
        dot = np.dot(torso_vector_norm, vertical)
        angles['torso_lean_angle'] = np.degrees(np.arccos(np.clip(dot, -1, 1)))
    else:
        angles['torso_lean_angle'] = np.nan
    
    return angles

print("‚úÖ Angle calculation functions defined!")
print("\nüìê Angles to be calculated:")
print("   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê")
print("   ‚îÇ Angle Name          ‚îÇ Points               ‚îÇ")
print("   ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§")
print("   ‚îÇ Elbow Angle         ‚îÇ shoulder-elbow-wrist ‚îÇ")
print("   ‚îÇ Knee Angle          ‚îÇ hip-knee-ankle       ‚îÇ")
print("   ‚îÇ Shoulder Angle      ‚îÇ elbow-shoulder-hip   ‚îÇ")
print("   ‚îÇ Hip Angle           ‚îÇ shoulder-hip-knee    ‚îÇ")
print("   ‚îÇ Torso Lean          ‚îÇ from vertical        ‚îÇ")
print("   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò")

# %% [markdown]
# ### 4.2 Calculate Angles for All Data
#
# **‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:** ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å frame ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
#
# **‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:**
# 1. ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô `calculate_all_angles()` ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å row
# 2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏°‡∏∏‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô DataFrame
# 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå

# %%
# =====================================================
# STEP 4.2: Calculate Angles for All Data
# =====================================================
# üìù Description: 
# ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å frame
#
# ‚è±Ô∏è Note: 
# ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà (30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ - 2 ‡∏ô‡∏≤‡∏ó‡∏µ)
# ‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
#
# üîÑ Process:
# 1. Apply calculate_all_angles() to each row
# 2. Convert results to DataFrame
# 3. Merge with original data
# =====================================================

print("=" * 70)
print("üìê CALCULATING JOINT ANGLES")
print("=" * 70)
print(f"\n‚è≥ Processing {len(df_labeled):,} frames... This may take a moment.")

# ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
import time
start_time = time.time()

# Apply function to each row ‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô DataFrame
angles_list = df_labeled.apply(calculate_all_angles, axis=1).tolist()
angles_df = pd.DataFrame(angles_list)

# ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°
df_with_angles = pd.concat([df_labeled.reset_index(drop=True), angles_df], axis=1)

elapsed_time = time.time() - start_time
print(f"‚úÖ Calculation completed in {elapsed_time:.2f} seconds")

# ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ angle columns
angle_columns = [col for col in df_with_angles.columns if '_angle' in col]
print(f"\nüìä Angle columns added: {len(angle_columns)}")
for col in angle_columns:
    print(f"   - {col}")

# ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
print("\n" + "=" * 70)
print("üìã SAMPLE DATA WITH ANGLES")
print("=" * 70)
display(df_with_angles[['frame_idx', 'person_id', 'action'] + angle_columns].head(10))

# ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏°‡∏∏‡∏°
print("\n" + "=" * 70)
print("üìä ANGLE STATISTICS SUMMARY")
print("=" * 70)
print(df_with_angles[angle_columns].describe().round(2))

# %% [markdown]
# ### 4.3 Angle Time Series Visualization
#
# **‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:** ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏°‡∏∏‡∏°‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤
#
# **‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏Å‡∏£‡∏≤‡∏ü:**
# - ‡πÅ‡∏Å‡∏ô Y: ‡∏°‡∏∏‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏á‡∏®‡∏≤ (0¬∞ - 180¬∞)
# - ‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ 90¬∞: ‡∏°‡∏∏‡∏°‡∏â‡∏≤‡∏Å (reference line)
# - ‡∏™‡∏µ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô: actions ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô
#
# **Pattern ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï:**
# - **‡∏´‡∏°‡∏±‡∏î‡∏ï‡∏£‡∏á**: elbow angle ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß (‡πÅ‡∏Ç‡∏ô‡πÄ‡∏´‡∏¢‡∏µ‡∏¢‡∏î)
# - **‡πÄ‡∏ï‡∏∞**: knee angle ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô + hip angle ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
# - **‡∏ó‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏±‡∏ö**: ‡∏°‡∏∏‡∏°‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏Ñ‡∏á‡∏ó‡∏µ‡πà

# %%
# =====================================================
# STEP 4.3: Angle Time Series Visualization
# =====================================================
# üìù Description: 
# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏°‡∏∏‡∏°‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠
# ‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ action
#
# üìä Graph elements:
# - Y-axis: Angle in degrees (0¬∞ - 180¬∞)
# - Gray dashed line at 90¬∞: right angle reference
# - Different colors: different actions
#
# üí° What to look for:
# - Rapid changes = fast movements
# - Stable values = static poses
# - Periodic patterns = repetitive movements
# =====================================================

def plot_angle_timeseries(df, person_id, angles, figsize=(16, 12)):
    """
    ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü Time Series ‡∏Ç‡∏≠‡∏á‡∏°‡∏∏‡∏°‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠
    
    Parameters:
    -----------
    df : DataFrame - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• pose ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏°‡∏∏‡∏°
    person_id : int - Person ID
    angles : list - ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ angle columns
    figsize : tuple - ‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ
    
    Returns:
    --------
    fig : matplotlib figure object
    """
    person_data = df[df['person_id'] == person_id].copy()
    person_data = person_data.sort_values('timestamp')
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á figure
    fig, axes = plt.subplots(len(angles), 1, figsize=figsize, sharex=True)
    if len(angles) == 1:
        axes = [axes]
    
    fig.suptitle(f'üìê Joint Angle Time Series - Person ID: {person_id}', 
                 fontsize=14, fontweight='bold')
    
    # Color map ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö actions
    actions = [a for a in person_data['action'].unique() if a != 'Unknown']
    action_colors = dict(zip(actions, plt.cm.Set2(np.linspace(0, 1, len(actions)))))
    
    for idx, angle_name in enumerate(angles):
        ax = axes[idx]
        
        for action in actions:
            action_data = person_data[person_data['action'] == action]
            if len(action_data) > 0:
                ax.scatter(action_data['timestamp'], action_data[angle_name],
                          label=action, alpha=0.5, s=3, color=action_colors[action])
        
        # Format axis
        ax.set_ylabel(f'{angle_name.replace("_", " ").title()}\n(degrees)')
        ax.set_ylim(0, 180)
        
        # Reference lines
        ax.axhline(y=90, color='gray', linestyle='--', alpha=0.5, label='90¬∞' if idx == 0 else '')
        ax.axhline(y=180, color='gray', linestyle=':', alpha=0.3)
        ax.axhline(y=0, color='gray', linestyle=':', alpha=0.3)
        
        if idx == 0:
            ax.legend(loc='upper right', fontsize=8, ncol=3, markerscale=3)
    
    axes[-1].set_xlabel('Time (seconds)')
    
    plt.tight_layout()
    return fig

# Angles ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
ANALYSIS_ANGLES = ['right_elbow_angle', 'left_elbow_angle', 
                   'right_knee_angle', 'left_knee_angle',
                   'torso_lean_angle']

print("=" * 70)
print("üìê ANGLE TIME SERIES VISUALIZATION")
print("=" * 70)
print("\nüí° Reading Guide:")
print("   - Y-axis: Angle (0¬∞ to 180¬∞)")
print("   - 180¬∞ = fully extended (straight)")
print("   - 90¬∞ = right angle")
print("   - 0¬∞ = fully flexed")
print("   - Gray dashed line = 90¬∞ reference")
print("\n" + "-" * 70)

for pid in SELECTED_PERSON_IDS[:1]:  # ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ person ‡πÅ‡∏£‡∏Å
    print(f"\nüìä Generating plot for Person ID: {pid}")
    fig = plot_angle_timeseries(df_with_angles, pid, ANALYSIS_ANGLES)
    plt.show()

# %% [markdown]
# ### 4.4 Angle Statistics per Action
#
# **‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:** ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏°‡∏∏‡∏°‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞ Action
#
# **Box Plot Interpretation:**
# ```
#     ‚î¨‚îÄ‚îÄ Maximum (Q3 + 1.5*IQR)
#     ‚îÇ
#   ‚îå‚îÄ‚îº‚îÄ‚îê ‚îÄ‚îÄ Q3 (75th percentile)
#   ‚îÇ ‚îÇ ‚îÇ
#   ‚îÇ ‚îú‚îÄ‚î§ ‚îÄ‚îÄ Median (Q2, 50th percentile)
#   ‚îÇ ‚îÇ ‚îÇ
#   ‚îî‚îÄ‚îº‚îÄ‚îò ‚îÄ‚îÄ Q1 (25th percentile)
#     ‚îÇ
#     ‚î¥‚îÄ‚îÄ Minimum (Q1 - 1.5*IQR)
#     
#     ‚óã ‚îÄ‚îÄ Outliers
# ```

# %%
# =====================================================
# STEP 4.4: Angle Statistics per Action
# =====================================================
# üìù Description: 
# ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏°‡∏∏‡∏°‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ action
# ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡πà‡∏≤
#
# üìä Statistics:
# - Mean: ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
# - Std: ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ö‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
# - Min/Max: ‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î/‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
#
# üìà Visualization:
# Box plot ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏°‡∏∏‡∏°‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞ action
# =====================================================

# ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏°‡∏∏‡∏°‡∏ï‡πà‡∏≠ action
angle_stats = df_with_angles.groupby('action')[angle_columns].agg(['mean', 'std', 'min', 'max'])
angle_stats = angle_stats.round(2)

print("=" * 70)
print("üìä ANGLE STATISTICS BY ACTION")
print("=" * 70)

# ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏°‡∏∏‡∏°
print("\nüìã Mean Angle by Action (degrees):")
mean_angles = df_with_angles.groupby('action')[angle_columns].mean().round(2)
print(mean_angles.to_string())

# Visualization - Box plots for key angles
fig, axes = plt.subplots(2, 3, figsize=(16, 10))
axes = axes.flatten()

key_angles = ['right_elbow_angle', 'left_elbow_angle', 
              'right_knee_angle', 'left_knee_angle',
              'right_shoulder_angle', 'torso_lean_angle']

actions_list = [a for a in df_with_angles['action'].unique() if a != 'Unknown']

for idx, angle in enumerate(key_angles):
    ax = axes[idx]
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á box plot
    data_for_plot = [df_with_angles[df_with_angles['action'] == action][angle].dropna() 
                     for action in actions_list]
    
    bp = ax.boxplot(data_for_plot, labels=[a.replace('_', '\n')[:15] for a in actions_list],
                    patch_artist=True)
    
    # ‡∏™‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö box
    colors = plt.cm.Set3(np.linspace(0, 1, len(actions_list)))
    for patch, color in zip(bp['boxes'], colors):
        patch.set_facecolor(color)
        patch.set_alpha(0.7)
    
    ax.set_ylabel('Angle (degrees)')
    ax.set_title(f'üìê {angle.replace("_", " ").title()}')
    ax.tick_params(axis='x', rotation=45)
    ax.axhline(y=90, color='red', linestyle='--', alpha=0.5, linewidth=1)
    ax.set_ylim(0, 180)

plt.suptitle('üìä Joint Angle Distribution by Action\n(Red dashed line = 90¬∞)', 
             fontsize=14, fontweight='bold')
plt.tight_layout()
plt.show()

# %% [markdown]
# ### 4.5 Angle Heatmap Comparison
#
# **‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:** ‡∏™‡∏£‡πâ‡∏≤‡∏á Heatmap ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏°‡∏∏‡∏°‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ Action
#
# **‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô Heatmap:**
# - **‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏°**: ‡∏°‡∏∏‡∏°‡∏°‡∏≤‡∏Å (‡πÉ‡∏Å‡∏•‡πâ 180¬∞ = ‡πÄ‡∏´‡∏¢‡∏µ‡∏¢‡∏î)
# - **‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏°**: ‡∏°‡∏∏‡∏°‡∏ô‡πâ‡∏≠‡∏¢ (‡πÉ‡∏Å‡∏•‡πâ 0¬∞ = ‡∏á‡∏≠)
# - **‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á**: ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏°‡∏∏‡∏° (‡∏≠‡∏á‡∏®‡∏≤)

# %%
# =====================================================
# STEP 4.5: Angle Heatmap Comparison
# =====================================================
# üìù Description: 
# ‡∏™‡∏£‡πâ‡∏≤‡∏á Heatmap ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏°‡∏∏‡∏°‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ action
# ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢
#
# üé® Color interpretation:
# - Dark red: large angle (near 180¬∞ = extended)
# - Dark blue: small angle (near 0¬∞ = flexed)
# - Numbers: mean angle in degrees
# =====================================================

# ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏°‡∏∏‡∏°‡∏ï‡πà‡∏≠ action
mean_angles_matrix = df_with_angles[df_with_angles['action'] != 'Unknown'].groupby('action')[angle_columns].mean()

# ‡∏™‡∏£‡πâ‡∏≤‡∏á Heatmap
fig, ax = plt.subplots(figsize=(14, 8))

# ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ columns ‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
display_columns = [col.replace('_', ' ').replace(' angle', '').title() 
                   for col in angle_columns]

sns.heatmap(mean_angles_matrix.values, 
            annot=True, 
            fmt='.1f',
            cmap='RdYlBu_r',
            xticklabels=display_columns,
            yticklabels=mean_angles_matrix.index,
            vmin=0, 
            vmax=180,
            cbar_kws={'label': 'Angle (degrees)'},
            ax=ax,
            linewidths=0.5,
            linecolor='white')

ax.set_title('üìä Mean Joint Angles Heatmap by Action\n'
             '(Darker red = larger angle/extended, Darker blue = smaller angle/flexed)', 
             fontsize=14, fontweight='bold')
ax.set_xlabel('Joint Angle')
ax.set_ylabel('Action')

plt.tight_layout()
plt.show()

print("\nüí° Heatmap Interpretation Guide:")
print("   üî¥ Red colors (high values): Extended/straightened joints")
print("   üîµ Blue colors (low values): Flexed/bent joints")
print("   üìä Numbers: Mean angle in degrees for each action-joint combination")

# %% [markdown]
# ---
#
# ## üìö Part 5: Action Comparison Analysis
#
# ### 5.1 Create Action Feature Summary
#
# **‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:** ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á Feature ‡∏™‡∏£‡∏∏‡∏õ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ Action

# %%
# =====================================================
# STEP 5.1: Create Action Feature Summary
# =====================================================
# üìù Description: 
# ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤ features ‡∏´‡∏•‡∏±‡∏Å‡πÜ ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ action
# ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÅ‡∏•‡∏∞ classification
# =====================================================

# ‡∏™‡∏£‡πâ‡∏≤‡∏á feature summary ‡∏ï‡πà‡∏≠ action
actions_to_compare = [a for a in df_with_angles['action'].unique() if a != 'Unknown']

action_features = []

for action in actions_to_compare:
    action_data = df_with_angles[df_with_angles['action'] == action]
    
    features = {
        'action': action,
        'frame_count': len(action_data),
        'unique_persons': action_data['person_id'].nunique(),
        
        # Angle means
        'mean_right_elbow': action_data['right_elbow_angle'].mean(),
        'mean_left_elbow': action_data['left_elbow_angle'].mean(),
        'mean_right_knee': action_data['right_knee_angle'].mean(),
        'mean_left_knee': action_data['left_knee_angle'].mean(),
        'mean_torso_lean': action_data['torso_lean_angle'].mean(),
        
        # Angle std (variability)
        'std_right_elbow': action_data['right_elbow_angle'].std(),
        'std_left_elbow': action_data['left_elbow_angle'].std(),
        'std_right_knee': action_data['right_knee_angle'].std(),
        'std_left_knee': action_data['left_knee_angle'].std(),
    }
    
    action_features.append(features)

action_features = pd.DataFrame(action_features)

print("=" * 70)
print("üìä ACTION FEATURE SUMMARY")
print("=" * 70)
print("\nüìã Features per Action:")
display(action_features.round(2))

# %% [markdown]
# ### 5.2 Radar Chart Comparison
#
# **‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:** ‡∏™‡∏£‡πâ‡∏≤‡∏á Radar Chart (Spider Chart) ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ Action
#
# **‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô Radar Chart:**
# - ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏Å‡∏ô = 1 feature (normalized)
# - ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏ß‡πâ‡∏≤‡∏á = ‡∏Ñ‡πà‡∏≤ feature ‡∏™‡∏π‡∏á‡πÉ‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏°‡∏¥‡∏ï‡∏¥
# - ‡∏£‡∏π‡∏õ‡∏£‡πà‡∏≤‡∏á‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô = ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ó‡πà‡∏≤‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô

# %%
# =====================================================
# STEP 5.2: Radar Chart Comparison
# =====================================================
# üìù Description: 
# ‡∏™‡∏£‡πâ‡∏≤‡∏á Radar Chart ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö features ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ action
#
# üìä Chart interpretation:
# - Each axis = 1 normalized feature
# - Larger area = higher values in multiple dimensions
# - Different shapes = different action characteristics
# =====================================================

def create_radar_chart(df_features, actions_to_plot, features_to_plot, figsize=(10, 10)):
    """
    ‡∏™‡∏£‡πâ‡∏≤‡∏á Radar Chart ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö actions
    
    Parameters:
    -----------
    df_features : DataFrame - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• features ‡∏ï‡πà‡∏≠ action
    actions_to_plot : list - actions ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ plot
    features_to_plot : list - features ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ plot
    figsize : tuple - ‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ
    
    Returns:
    --------
    fig : matplotlib figure object
    """
    # ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞ normalize ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    df_plot = df_features[df_features['action'].isin(actions_to_plot)].copy()
    
    # Normalize features to 0-1 scale
    for feature in features_to_plot:
        min_val = df_plot[feature].min()
        max_val = df_plot[feature].max()
        if max_val > min_val:
            df_plot[f'{feature}_norm'] = (df_plot[feature] - min_val) / (max_val - min_val)
        else:
            df_plot[f'{feature}_norm'] = 0.5
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á radar chart
    num_vars = len(features_to_plot)
    angles = np.linspace(0, 2 * np.pi, num_vars, endpoint=False).tolist()
    angles += angles[:1]  # close the polygon
    
    fig, ax = plt.subplots(figsize=figsize, subplot_kw=dict(polar=True))
    
    colors = plt.cm.Set2(np.linspace(0, 1, len(actions_to_plot)))
    
    for idx, action in enumerate(actions_to_plot):
        action_row = df_plot[df_plot['action'] == action]
        if len(action_row) == 0:
            continue
            
        values = [action_row[f'{f}_norm'].values[0] for f in features_to_plot]
        values += values[:1]  # close the polygon
        
        ax.plot(angles, values, 'o-', linewidth=2, label=action, color=colors[idx])
        ax.fill(angles, values, alpha=0.25, color=colors[idx])
    
    # Set labels
    feature_labels = [f.replace('mean_', '').replace('_', ' ').title() for f in features_to_plot]
    ax.set_xticks(angles[:-1])
    ax.set_xticklabels(feature_labels, size=10)
    
    ax.set_ylim(0, 1)
    ax.set_title('üéØ Action Feature Comparison (Radar Chart)\n'
                 'Values normalized to 0-1 scale', fontsize=14, fontweight='bold', y=1.08)
    ax.legend(loc='upper right', bbox_to_anchor=(1.3, 1.0))
    
    return fig

# ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å features ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö radar chart
radar_features = ['mean_right_elbow', 'mean_left_elbow', 
                  'mean_right_knee', 'mean_left_knee', 'mean_torso_lean']

print("=" * 70)
print("üéØ RADAR CHART COMPARISON")
print("=" * 70)

# ‡∏™‡∏£‡πâ‡∏≤‡∏á radar chart (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 5 actions ‡πÅ‡∏£‡∏Å)
actions_for_radar = actions_to_compare[:5]
print(f"\nüìä Comparing actions: {actions_for_radar}")

fig = create_radar_chart(action_features, actions_for_radar, radar_features)
plt.show()

print("\nüí° Interpretation:")
print("   - ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏Å‡∏ô‡πÅ‡∏ó‡∏ô 1 feature (normalized 0-1)")
print("   - ‡∏£‡∏π‡∏õ‡∏£‡πà‡∏≤‡∏á‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô = ‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô")
print("   - ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å = ‡∏°‡∏∏‡∏°‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°‡∏°‡∏≤‡∏Å (‡πÄ‡∏´‡∏¢‡∏µ‡∏¢‡∏î‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤)")

# %% [markdown]
# ---
#
# ## üìö Part 6: Advanced Analysis
#
# ### 6.1 Correlation Analysis Between Angles
#
# **‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:** ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏°‡∏∏‡∏°‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡∏ï‡πà‡∏≤‡∏á‡πÜ

# %%
# =====================================================
# STEP 6.1: Correlation Analysis Between Angles
# =====================================================
# üìù Description: 
# ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏°‡∏∏‡∏°‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡∏ï‡πà‡∏≤‡∏á‡πÜ
#
# üìä Correlation interpretation:
# - +1: perfect positive correlation
# - 0: no correlation
# - -1: perfect negative correlation
# =====================================================

# ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì correlation matrix
angle_corr = df_with_angles[angle_columns].corr()

# ‡∏™‡∏£‡πâ‡∏≤‡∏á heatmap
fig, ax = plt.subplots(figsize=(10, 8))

mask = np.triu(np.ones_like(angle_corr, dtype=bool))  # ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏•‡πà‡∏≤‡∏á

sns.heatmap(angle_corr, 
            mask=mask,
            annot=True, 
            fmt='.2f',
            cmap='coolwarm',
            center=0,
            vmin=-1, vmax=1,
            square=True,
            ax=ax,
            linewidths=0.5)

# ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
labels = [col.replace('_angle', '').replace('_', ' ').title() for col in angle_columns]
ax.set_xticklabels(labels, rotation=45, ha='right')
ax.set_yticklabels(labels, rotation=0)

ax.set_title('üìä Correlation Matrix: Joint Angles\n'
             '(Red = positive correlation, Blue = negative correlation)', 
             fontsize=14, fontweight='bold')

plt.tight_layout()
plt.show()

print("\nüí° Correlation Insights:")
print("   üî¥ Red (positive): Angles tend to increase together")
print("   üîµ Blue (negative): One increases while other decreases")
print("   ‚ö™ White (zero): No relationship")

# %% [markdown]
# ### 6.2 Symmetry Analysis (Left vs Right)
#
# **‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:** ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏Ç‡∏≠‡∏á‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤

# %%
# =====================================================
# STEP 6.2: Symmetry Analysis (Left vs Right)
# =====================================================
# üìù Description: 
# ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏Ç‡∏≠‡∏á‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤
# ‡∏ñ‡πâ‡∏≤ difference ‡∏°‡∏≤‡∏Å = ‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏°‡∏°‡∏≤‡∏ï‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏°‡∏±‡∏î‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
# =====================================================

# ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì difference ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤
df_with_angles['elbow_diff'] = np.abs(df_with_angles['right_elbow_angle'] - df_with_angles['left_elbow_angle'])
df_with_angles['knee_diff'] = np.abs(df_with_angles['right_knee_angle'] - df_with_angles['left_knee_angle'])
df_with_angles['shoulder_diff'] = np.abs(df_with_angles['right_shoulder_angle'] - df_with_angles['left_shoulder_angle'])
df_with_angles['hip_diff'] = np.abs(df_with_angles['right_hip_angle'] - df_with_angles['left_hip_angle'])

# ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏° action
symmetry_cols = ['elbow_diff', 'knee_diff', 'shoulder_diff', 'hip_diff']
symmetry_by_action = df_with_angles.groupby('action')[symmetry_cols].mean().round(2)
symmetry_by_action = symmetry_by_action.sort_values('elbow_diff', ascending=False)

print("=" * 70)
print("‚öñÔ∏è SYMMETRY ANALYSIS (Left-Right Difference)")
print("=" * 70)
print("\nüìã Mean Angle Difference by Action:")
print("   (Higher value = more asymmetric)")
print("\n" + symmetry_by_action.to_string())

# Visualization
fig, ax = plt.subplots(figsize=(12, 6))

x = np.arange(len(symmetry_by_action))
width = 0.2

bars1 = ax.bar(x - 1.5*width, symmetry_by_action['elbow_diff'], width, label='Elbow', color='#e74c3c')
bars2 = ax.bar(x - 0.5*width, symmetry_by_action['knee_diff'], width, label='Knee', color='#3498db')
bars3 = ax.bar(x + 0.5*width, symmetry_by_action['shoulder_diff'], width, label='Shoulder', color='#2ecc71')
bars4 = ax.bar(x + 1.5*width, symmetry_by_action['hip_diff'], width, label='Hip', color='#9b59b6')

ax.set_xlabel('Action')
ax.set_ylabel('Mean Angle Difference (degrees)')
ax.set_title('‚öñÔ∏è Body Symmetry Analysis by Action\n(Higher = More Asymmetric)', fontsize=14, fontweight='bold')
ax.set_xticks(x)
ax.set_xticklabels([a.replace('_', '\n')[:15] for a in symmetry_by_action.index], rotation=45, ha='right')
ax.legend()
ax.axhline(y=10, color='gray', linestyle='--', alpha=0.5, label='10¬∞ threshold')

plt.tight_layout()
plt.show()

print("\nüí° Interpretation:")
print("   üìä ‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á = ‡∏ó‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏°‡∏°‡∏≤‡∏ï‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏°‡∏±‡∏î‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß, ‡πÄ‡∏ï‡∏∞‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)")
print("   üìä ‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥ = ‡∏ó‡πà‡∏≤‡∏™‡∏°‡∏°‡∏≤‡∏ï‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏±‡∏ö, ‡∏ó‡πà‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°)")

# %% [markdown]
# ---
#
# ## üìö Part 7: Summary and Conclusions
#
# ### 7.1 Generate Final Report
#
# **‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:** ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô report

# %%
# =====================================================
# STEP 7.1: Generate Final Summary Report
# =====================================================
# üìù Description: 
# ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô report
# =====================================================

print("=" * 70)
print("üìã FINAL ANALYSIS REPORT")
print("=" * 70)

print(f"""
üéØ DATASET OVERVIEW
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ Total Frames: {len(df_pose):,}
‚Ä¢ Total Labeled Frames: {len(df_labeled):,}
‚Ä¢ Unique Persons: {df_pose['person_id'].nunique()}
‚Ä¢ Actions Analyzed: {len(actions_to_compare)}
‚Ä¢ Selected Persons for Analysis: {SELECTED_PERSON_IDS}

üìä ACTIONS SUMMARY
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ""")

for action in actions_to_compare[:6]:  # ‡πÅ‡∏™‡∏î‡∏á 6 actions ‡πÅ‡∏£‡∏Å
    action_data = df_with_angles[df_with_angles['action'] == action]
    print(f"\nü•ä {action.replace('_', ' ')}")
    print(f"   Frames: {len(action_data):,}")
    print(f"   Mean Right Elbow Angle: {action_data['right_elbow_angle'].mean():.1f}¬∞")
    print(f"   Mean Right Knee Angle: {action_data['right_knee_angle'].mean():.1f}¬∞")
    print(f"   Mean Torso Lean: {action_data['torso_lean_angle'].mean():.1f}¬∞")

print(f"""

üìà KEY FINDINGS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
1. ‚úÖ Actions ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡∏¢‡∏µ‡∏¢‡∏î‡πÅ‡∏Ç‡∏ô (elbow angle ‡∏™‡∏π‡∏á) ‡πÄ‡∏î‡πà‡∏ô‡∏ä‡∏±‡∏î
2. ‚úÖ ‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏á‡∏≠‡πÄ‡∏Ç‡πà‡∏≤ (knee angle ‡∏ï‡πà‡∏≥) ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏¢‡∏Å‡πÅ‡∏¢‡∏∞‡πÑ‡∏î‡πâ‡∏î‡∏µ
3. ‚úÖ ‡∏°‡∏∏‡∏°‡∏•‡∏≥‡∏ï‡∏±‡∏ß (torso lean) ‡∏ä‡πà‡∏ß‡∏¢‡∏ö‡πà‡∏á‡∏ö‡∏≠‡∏Å‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á‡πÇ‡∏à‡∏°‡∏ï‡∏µ/‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô
4. ‚úÖ Velocity analysis ‡∏ä‡πà‡∏ß‡∏¢‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡πÄ‡∏£‡πá‡∏ß
5. ‚úÖ Symmetry analysis ‡∏ä‡πà‡∏ß‡∏¢‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏Ç‡∏ô/‡∏Ç‡∏≤‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üìå RECOMMENDATIONS FOR FURTHER ANALYSIS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
1. ü§ñ ‡πÉ‡∏ä‡πâ Machine Learning ‡πÄ‡∏û‡∏∑‡πà‡∏≠ classify actions ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
2. üìà ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå temporal patterns ‡∏î‡πâ‡∏ß‡∏¢ DTW ‡∏´‡∏£‡∏∑‡∏≠ LSTM
3. üìä ‡∏™‡∏£‡πâ‡∏≤‡∏á feature vectors ‡∏à‡∏≤‡∏Å angles ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö clustering
4. üé• ‡πÄ‡∏û‡∏¥‡πà‡∏° 3D reconstruction ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏Å‡∏•‡πâ‡∏≠‡∏á
5. ‚è±Ô∏è  ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå timing ‡πÅ‡∏•‡∏∞ rhythm ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß
""")

# %% [markdown]
# ### 7.2 Export Processed Data
#
# **‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:** Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠
#
# **‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞ Export:**
# 1. `pose_data_with_angles.csv` - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏°‡∏∏‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
# 2. `action_features_summary.csv` - ‡∏™‡∏£‡∏∏‡∏õ features ‡∏ï‡πà‡∏≠ action
# 3. `velocity_statistics.csv` - ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß

# %%
# =====================================================
# STEP 7.2: Export Processed Data
# =====================================================
# üìù Description: 
# ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß
# ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á angles ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
#
# üìÅ Output files:
# - pose_data_with_angles.csv
# - action_features_summary.csv
# - velocity_statistics.csv
#
# ‚ö†Ô∏è Note: Uncomment the code below to export
# =====================================================

# # Export DataFrame ‡∏û‡∏£‡πâ‡∏≠‡∏° angles
# output_filename = 'pose_data_with_angles.csv'
# df_with_angles.to_csv(output_filename, index=False)
# print(f"‚úÖ Exported: {output_filename}")

# # Export action features
# features_filename = 'action_features_summary.csv'
# action_features.to_csv(features_filename, index=False)
# print(f"‚úÖ Exported: {features_filename}")

# # Export velocity statistics
# velocity_filename = 'velocity_statistics.csv'
# velocity_stats.to_csv(velocity_filename, index=False)
# print(f"‚úÖ Exported: {velocity_filename}")

print("=" * 70)
print("üíæ EXPORT OPTIONS (Currently commented out)")
print("=" * 70)
print("""
üìÅ Files available for export:

1. pose_data_with_angles.csv
   - Original pose data + calculated joint angles
   - Size: ~{:,} rows √ó {:,} columns
   
2. action_features_summary.csv
   - Aggregated features per action
   - Size: {:,} rows √ó {:,} columns
   
3. velocity_statistics.csv
   - Velocity statistics per action/person/keypoint
   - Size: {:,} rows √ó {:,} columns

üí° To export, uncomment the code above and run again.
""".format(len(df_with_angles), len(df_with_angles.columns),
           len(action_features), len(action_features.columns),
           len(velocity_stats), len(velocity_stats.columns)))

print("\n" + "=" * 70)
print("üéâ LAB COMPLETED SUCCESSFULLY!")
print("=" * 70)
print("""
‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:
‚úÖ ‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Pose Estimation
‚úÖ ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Time Series ‡∏Ç‡∏≠‡∏á keypoint positions
‚úÖ ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Velocity ‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß
‚úÖ ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Joint Angles ‡∏à‡∏≤‡∏Å keypoint coordinates
‚úÖ ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö Actions ‡∏î‡πâ‡∏ß‡∏¢ visualization ‡∏ï‡πà‡∏≤‡∏á‡πÜ
‚úÖ ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Symmetry ‡πÅ‡∏•‡∏∞ Correlation

üöÄ Next Steps:
- ‡∏•‡∏≠‡∏á‡∏ô‡∏≥ features ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ train ML model
- ‡πÄ‡∏û‡∏¥‡πà‡∏° features ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏ä‡πà‡∏ô acceleration, jerk
- ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå temporal patterns ‡∏î‡πâ‡∏ß‡∏¢ sequence models
""")

# %% [markdown]
# ---
#
# ## üìñ Additional Resources
#
# **‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:**
#
# ### 1. Pose Estimation
# - [COCO Keypoint Detection](https://cocodataset.org/#keypoints-2020) - ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô keypoint format
# - [YOLOv11 Documentation](https://docs.ultralytics.com/) - ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ pose estimation
# - [MediaPipe Pose](https://developers.google.com/mediapipe/solutions/vision/pose_landmarker) - alternative pose estimation
#
# ### 2. Time Series Analysis
# - [Pandas Time Series](https://pandas.pydata.org/docs/user_guide/timeseries.html) - ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏•‡∏≤
# - [SciPy Signal Processing](https://docs.scipy.org/doc/scipy/reference/signal.html) - ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì
# - [Dynamic Time Warping](https://rtavenar.github.io/blog/dtw.html) - ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö time series
#
# ### 3. Joint Angle Analysis
# - [Biomechanics Tutorials](https://biomechanics.stanford.edu/) - ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£ biomechanics
# - [OpenSim Documentation](https://opensim.stanford.edu/) - ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß
#
# ### 4. Visualization
# - [Matplotlib Gallery](https://matplotlib.org/stable/gallery/) - ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü
# - [Seaborn Tutorial](https://seaborn.pydata.org/tutorial.html) - ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
#
# ### 5. Machine Learning for Action Recognition
# - [scikit-learn](https://scikit-learn.org/) - ML algorithms
# - [TensorFlow/Keras](https://www.tensorflow.org/) - Deep learning
# - [PyTorch](https://pytorch.org/) - Deep learning alternative
#
# ---
#
# **End of Lab** üéì